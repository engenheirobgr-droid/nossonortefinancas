<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nosso Norte Finan√ßas</title>

    <!-- √çcone do App (Para Salvar na Tela Inicial / Favoritos) -->
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' rx='128' fill='%230f172a'/><g transform='translate(64,64) scale(16)'><path d='M21 12V7H5a2 2 0 0 1 0-4h14v4' fill='none' stroke='%2334d399' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/><path d='M3 5v14a2 2 0 0 0 2 2h16v-5' fill='none' stroke='%2334d399' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/><path d='M18 12a2 2 0 0 0 0 4h4v-4h-4z' fill='none' stroke='%2334d399' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/></g><g transform='translate(390, 120)'><circle cx='0' cy='0' r='70' fill='%230f172a' stroke='%23475569' stroke-width='16'/><g transform='rotate(25)'><path d='M0 -55 L14 0 L-14 0 Z' fill='%23ef4444'/><path d='M0 55 L14 0 L-14 0 Z' fill='%23e2e8f0'/><circle cx='0' cy='0' r='8' fill='%230f172a'/></g></g><path d='M440 440l-10-10c-30-28-50-45-50-68 0-18 14-32 32-32 10 0 19 6 25 13 6-7 15-13 25-13 18 0 32 14 32 32 0 23-20 40-50 68z' fill='%23f43f5e' transform='translate(-20, -20)'/></svg>">
    <link rel="apple-touch-icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' rx='128' fill='%230f172a'/><g transform='translate(64,64) scale(16)'><path d='M21 12V7H5a2 2 0 0 1 0-4h14v4' fill='none' stroke='%2334d399' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/><path d='M3 5v14a2 2 0 0 0 2 2h16v-5' fill='none' stroke='%2334d399' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/><path d='M18 12a2 2 0 0 0 0 4h4v-4h-4z' fill='none' stroke='%2334d399' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/></g><g transform='translate(390, 120)'><circle cx='0' cy='0' r='70' fill='%230f172a' stroke='%23475569' stroke-width='16'/><g transform='rotate(25)'><path d='M0 -55 L14 0 L-14 0 Z' fill='%23ef4444'/><path d='M0 55 L14 0 L-14 0 Z' fill='%23e2e8f0'/><circle cx='0' cy='0' r='8' fill='%230f172a'/></g></g><path d='M440 440l-10-10c-30-28-50-45-50-68 0-18 14-32 32-32 10 0 19 6 25 13 6-7 15-13 25-13 18 0 32 14 32 32 0 23-20 40-50 68z' fill='%23f43f5e' transform='translate(-20, -20)'/></svg>">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.23.10/babel.min.js"></script>

    <!-- SheetJS & PDF.js -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Google AI -->
    <script type="importmap">{"imports": {"@google/generative-ai": "https://esm.run/@google/generative-ai"}}</script>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">

    <style>
        /* --- TEMA N√ÅUTICO DARK (FUNDO + VIDRO) --- */
        body {
            margin: 0;
            padding: 0;
            /* Imagem fixada no topo para mostrar o azul e a silhueta */
            background-image: url('fundo.jpg');
            background-size: cover;
            background-position: top center;
            background-attachment: fixed;
            background-repeat: no-repeat;

            /* Removemos a cor s√≥lida para n√£o escurecer a imagem */
            background-color: transparent !important;
            color: #e2e8f0;

            height: 100vh;
            width: 100vw;
            overflow: hidden;
            position: fixed;
        }

        /* Overlay transparente para permitir a visibilidade do fundo */
        #root {
            background: transparent;
            min-height: 100vh;
        }

        .bg-subtle-filter {
            backdrop-filter: contrast(100%) brightness(150%);
        }

        /* --- GLASSMORPHISM PREMIUM (Identidade N√°utica) --- */

        /* --- ESTILO NOVO (CLEAN) --- */
        /* Removemos a regra mestra que for√ßava vidro em tudo. 
           Agora controlaremos manualmente. */
        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* NOVA CLASSE UNIFICADA PARA CARDS */
        .glass-card {
            background: rgba(15, 23, 42, 0.4);
            /* Slate 900 com 40% opacidade */
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
            /* rounded-3xl */
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        /* Ajuste espec√≠fico para o Header/Topo para ele ficar mais leve */
        .pt-4.pb-0.px-5.shrink-0.z-30.relative.text-white {
            background: transparent !important;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
            /* Sombra mais forte para ler em cima da b√∫ssola */
        }

        /* --- CORRE√á√ÉO DE VISIBILIDADE (MODAIS E FORMUL√ÅRIOS) --- */
        /* Garante que o modal de lan√ßamento seja S√ìLIDO (sem transpar√™ncia) para leitura */
        .modal-solid {
            background: #1e293b !important;
            /* Slate 800 S√≥lido (Azul Noturno) */
            backdrop-filter: none !important;
            /* Remove o vidro */
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Inputs S√≥lidos: Fundo bem escuro para o texto branco brilhar */
        .input-solid {
            background: #020617 !important;
            /* Slate 950 (Quase preto) */
            border: 1px solid rgba(255, 255, 255, 0.15) !important;
            color: #ffffff !important;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .input-solid:focus {
            border-color: #6366f1 !important;
            /* Indigo Focus */
            background: #0f172a !important;
            /* Clareia levemente no foco */
        }

        .input-solid::placeholder {
            color: #64748b !important;
            /* Slate 500 */
        }

        /* --- MELHORIAS VISUAIS (BOT√ïES E INTERA√á√ÉO) --- */
        /* Efeito de clique (escala) */
        button:active {
            transform: scale(0.95);
            transition: transform 0.1s;
        }

        /* Bot√µes com Gradiente Vivo (Classe utilit√°ria) */
        .btn-gradient {
            background: linear-gradient(135deg, #4f46e5 0%, #3730a3 100%);
            /* Indigo Vibrante */
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-gradient:hover {
            filter: brightness(1.1);
        }

        /* Bot√£o de Excluir (Sonhos) - N√£o sobrepor texto */
        .card-dream {
            position: relative;
            padding-right: 40px;
        }

        /* Garante espa√ßo para o bot√£o X */

        /* Textos secund√°rios: Clareados para evitar que sumam no fundo escuro */
        .text-slate-800,
        .text-slate-700,
        .text-gray-600,
        .text-gray-500,
        .text-gray-400 {
            color: #94a3b8 !important;
            /* Slate-400 (Mais leg√≠vel no dark) */
        }

        /* T√≠tulos e valores principais ficam branco puro */
        h1,
        h2,
        h3,
        .font-bold.text-lg,
        .font-extrabold {
            color: #ffffff !important;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        /* Bot√µes de A√ß√£o (Editar/Excluir) e √çcones - Mant√©m cores originais mas com brilho */
        button[class*="bg-"] {
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            /* Glow sutil */
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Inputs e Selects (Formul√°rios) - Vidro mais escuro para foco */
        input,
        select,
        textarea {
            background-color: rgba(0, 0, 0, 0.3) !important;
            color: white !important;
            border-color: rgba(255, 255, 255, 0.1) !important;
        }

        input::placeholder {
            color: rgba(255, 255, 255, 0.3) !important;
        }

        /* Ajusta textos que eram escuros para ficarem claros */
        .text-slate-800,
        .text-slate-700,
        .text-gray-600,
        .text-gray-500 {
            color: #cbd5e1 !important;
        }

        /* Mant√©m bot√µes coloridos (ex: verde, vermelho) brilhantes */
        button[class*="bg-emerald"],
        button[class*="bg-indigo"],
        button[class*="bg-rose"] {
            opacity: 1 !important;
            color: white !important;
            background-color: inherit;
            /* Respeita a cor original do bot√£o */
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        input,
        textarea,
        select {
            user-select: text;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        @keyframes pop {
            0% {
                transform: translate(-50%, 20px) scale(0.9);
                opacity: 0;
            }

            100% {
                transform: translate(-50%, 0) scale(1);
                opacity: 1;
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.4s ease-out;
        }

        .animate-slide-up {
            animation: slideUp 0.3s ease-out;
        }

        .animate-pop {
            animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .safe-pb {
            padding-bottom: max(20px, env(safe-area-inset-bottom));
        }
    </style>
</head>

<div id="root" class="h-full w-full"></div>

<script type="text/babel" data-type="module">
    import { GoogleGenerativeAI } from "@google/generative-ai";

    // --- √çCONES ---
    const Icons = {
        Plus: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M5 12h14" /><path d="M12 5v14" /></svg>,
        Wallet: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1" /><path d="M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4" /></svg>,
        X: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M18 6 6 18" /><path d="m6 6 18 18" /></svg>,
        Users: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M22 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></svg>,
        ArrowRightLeft: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="m16 3 4 4-4 4" /><path d="M20 7H4" /><path d="m8 21-4-4 4-4" /><path d="M4 17h16" /></svg>,
        User: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></svg>,
        PiggyBank: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M19 5c-1.5 0-2.8 1.4-3 2-3.5-1.5-11-.3-11 5 0 1.8 0 3 2 4.5V20h4v-2h3v2h4v-4c1-.5 1.7-1 2-2.5V7.4c-1.5-1.5-3.5-2.4-5-2.4z" /><path d="M16 6h1a2 2 0 0 1 0 4h-1" /><line x1="9" x2="9" y1="11" y2="11.01" /></svg>,
        Target: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><circle cx="12" cy="12" r="10" /><circle cx="12" cy="12" r="6" /><circle cx="12" cy="12" r="2" /></svg>,
        PieChart: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M21.21 15.89A10 10 0 1 1 8 2.83" /><path d="M22 12A10 10 0 0 0 12 2v10z" /></svg>,
        ListIcon: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><line x1="8" x2="21" y1="6" y2="6" /><line x1="8" x2="21" y1="12" y2="12" /><line x1="8" x2="21" y1="18" y2="18" /><line x1="3" x2="3.01" y1="6" y2="6" /><line x1="3" x2="3.01" y1="12" y2="12" /><line x1="3" x2="3.01" y1="18" y2="18" /></svg>,
        BarChart3: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M3 3v18h18" /><path d="M18 17V9" /><path d="M13 17V5" /><path d="M8 17v-3" /></svg>,
        Home: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" /><polyline points="9 22 9 12 15 12 15 22" /></svg>,
        Settings: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></svg>,
        LogOut: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" /><polyline points="16 17 21 12 16 7" /><line x1="21" x2="9" y1="12" y2="12" /></svg>,
        Moon: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z" /></svg>,
        Sun: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><circle cx="12" cy="12" r="4" /><path d="M12 2v2" /><path d="M12 20v2" /><path d="m4.93 4.93 1.41 1.41" /><path d="m17.66 17.66 1.41 1.41" /><path d="M2 12h2" /><path d="M20 12h2" /><path d="m6.34 17.66-1.41 1.41" /><path d="m19.07 4.93-1.41 1.41" /></svg>,
        Sunrise: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M12 2v8" /><path d="m4.93 10.93 1.41 1.41" /><path d="M2 18h2" /><path d="M20 18h2" /><path d="m19.07 10.93-1.41 1.41" /><path d="M22 22H2" /><path d="m8 6 4-4 4 4" /><path d="M16 18a4 4 0 0 0-8 0" /></svg>,
        ChevronLeft: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="m15 18-6-6 6-6" /></svg>,
        Heart: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" /></svg>,
        Check: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M20 6 9 17l-5-5" /></svg>,
        FileText: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /></svg>,
        Upload: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" x2="12" y1="3" y2="15" /></svg>,
        Sparkles: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" /><path d="M5 3v4" /><path d="M9 3v4" /><path d="M3 5h4" /><path d="M3 9h4" /></svg>,
        Key: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><circle cx="7.5" cy="15.5" r="5.5" /><path d="m21 2-9.6 9.6" /><path d="m15.5 7.5 3 3L22 7l-3-3" /><path d="M21 2h-9.6" /></svg>,
        CheckSquare: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><polyline points="9 11 12 14 22 4" /><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11" /></svg>,
        Trash2: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /><line x1="10" x2="10" y1="11" y2="17" /><line x1="14" x2="14" y1="11" y2="17" /></svg>,
        ChevronDown: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="m6 9 6 6 6-6" /></svg>,
        ChevronUp: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="m18 15-6-6-6 6" /></svg>,
        ShoppingCart: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><circle cx="8" cy="21" r="1" /><circle cx="19" cy="21" r="1" /><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12" /></svg>,
        Search: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" /></svg>,
        TrendingDown: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><polyline points="22 17 13.5 8.5 8.5 13.5 2 7" /><polyline points="16 17 22 17 22 11" /></svg>,
        CreditCard: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><rect width="20" height="14" x="2" y="5" rx="2" /><line x1="2" x2="22" y1="10" y2="10" /></svg>,
        Calendar: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><rect width="18" height="18" x="3" y="4" rx="2" ry="2" /><line x1="16" x2="16" y1="2" y2="6" /><line x1="8" x2="8" y1="2" y2="6" /><line x1="3" x2="21" y1="10" y2="10" /></svg>,
        MapPin: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z" /><circle cx="12" cy="10" r="3" /></svg>,
        Banknote: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><rect width="20" height="12" x="2" y="6" rx="2" /><circle cx="12" cy="12" r="2" /><path d="M6 12h.01M18 12h.01" /></svg>,
        Briefcase: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><rect width="20" height="14" x="2" y="7" rx="2" ry="2" /><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16" /></svg>,
        Download: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" x2="12" y1="15" y2="3" /></svg>,
        TrendingUp: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><polyline points="22 7 13.5 15.5 8.5 10.5 2 17" /><polyline points="16 7 22 7 22 13" /></svg>,
        // --- NOVOS √çCONES TAREFAS ---
        // --- NOVOS √çCONES TAREFAS ---
        Broom: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="m9.06 11.9 8.07-8.06a2.85 2.85 0 1 1 4.03 4.03l-8.06 8.08" /><path d="M7.07 14.94c-1.66 0-3 1.35-3 3.02 0 1.33-2.5 1.52-2.5 2.24 0 .46.27.8.71.8.44 0 .71-.34.71-.8 0-.72 2.5-.91 2.5-2.24 0-1.67 1.34-3.02 3-3.02S12 13.5 12 15.2c0 1.33 2.5 1.52 2.5 2.24 0 .46-.27.8-.71.8-.44 0-.71-.34-.71-.8 0-.72-2.5-.91-2.5-2.24 0-1.67 1.34-3.02-3-3.02z" /></svg>,
        RefreshCw: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" /><path d="M21 3v5h-5" /><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" /><path d="M8 16H3v5" /></svg>,
        // --- √çCONES VISIBILIDADE ---
        Eye: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" /><circle cx="12" cy="12" r="3" /></svg>,
        EyeOff: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24" /><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68" /><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61" /><line x1="2" x2="22" y1="2" y2="22" /></svg>,
        Trophy: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6" /><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18" /><path d="M4 22h16" /><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22" /><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22" /><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z" /></svg>,
        Compass: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><circle cx="12" cy="12" r="10" /><path d="m16.24 7.76-2.12 6.36-6.36 2.12 2.12-6.36 6.36-2.12z" /></svg>,
        Trash: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /></svg>,
        // --- √çCONES FALTANTES ADICIONADOS ---
        Type: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><polyline points="4 7 4 4 20 4 20 7" /><line x1="9" x2="15" y1="20" y2="20" /><line x1="12" x2="12" y1="4" y2="20" /></svg>,
        CheckCircle: (p) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" /><polyline points="22 4 12 14.01 9 11.01" /></svg>,
    };

    const { useState, useEffect, useMemo, useRef } = React;

    const {
        Plus, Wallet, X, Users, ArrowRightLeft, User, PiggyBank, Target,
        PieChart, ListIcon, BarChart3, Home, Settings, LogOut,
        Moon, Sun, Sunrise, ChevronLeft, Heart, Check, FileText, Upload,
        Sparkles, Key, CheckSquare, Trash2, ChevronDown, ChevronUp,
        ShoppingCart, Search, TrendingDown, CreditCard, Calendar, MapPin, Banknote, Briefcase, Download, TrendingUp,
        Broom, RefreshCw, Trophy, Trash, Eye, EyeOff, Compass,
        Type, CheckCircle // <--- ADICIONAR AQUI
    } = Icons;

    // --- FIREBASE CONFIG ---
    const MY_FIREBASE_CONFIG = {
        apiKey: 'AIzaSyDxpiQ5XHzv8jndc5uSUI1qbR3k_C19h4M',
        authDomain: 'nosso-norte-fin.firebaseapp.com',
        projectId: 'nosso-norte-fin',
        storageBucket: 'nosso-norte-fin.firebasestorage.app',
        messagingSenderId: '105922259166',
        appId: '1:105922259166:web:45e0d0b2d9eea2e0363a4f',
    };

    if (!firebase.apps.length) {
        firebase.initializeApp(MY_FIREBASE_CONFIG);
    }
    const auth = firebase.auth();
    const db = firebase.firestore();
    const APP_ID = 'nosso-norte-fin-v1';

    // --- DADOS ---
    const USER_CONFIG = {
        bruno: { name: 'Bruno', avatar: 'üë®üèª‚Äçüíª', defaultPin: '1358', color: 'bg-indigo-600' },
        maiara: { name: 'Maiara', avatar: 'üë©üèª‚Äç‚öïÔ∏è', defaultPin: '4321', color: 'bg-pink-600' },
    };

    const BANKS = [
        { id: 'nubank', name: 'Nubank', color: 'bg-indigo-600' }, // Adjusted to Indigo for cleaner look
        { id: 'inter', name: 'Inter', color: 'bg-orange-500' },
        { id: 'itau', name: 'Ita√∫', color: 'bg-blue-600' },
        { id: 'bradesco', name: 'Bradesco', color: 'bg-rose-600' },
        { id: 'bb', name: 'BB', color: 'bg-yellow-500' },
        { id: 'santander', name: 'Santander', color: 'bg-rose-600' },
        { id: 'caixa', name: 'Caixa', color: 'bg-blue-500' },
        { id: 'btg', name: 'BTG', color: 'bg-blue-800' },
        { id: 'xp', name: 'XP', color: 'bg-slate-900' },
        { id: 'rico', name: 'Rico', color: 'bg-orange-600' },
        { id: 'clear', name: 'Clear', color: 'bg-blue-400' },
        { id: 'genial', name: 'Genial', color: 'bg-blue-700' },
        { id: 'c6', name: 'C6 Bank', color: 'bg-slate-800' },
        { id: 'nomad', name: 'Nomad', color: 'bg-yellow-400' },
        { id: 'wise', name: 'Wise', color: 'bg-lime-500' },
        { id: 'avenue', name: 'Avenue', color: 'bg-slate-900' },
        { id: 'money', name: 'Dinheiro', color: 'bg-emerald-600' },
        { id: 'vr', name: 'VR/VA', color: 'bg-pink-500' },
    ];

    const INVESTMENT_TYPES = [
        { id: 'fixed', name: 'Renda Fixa (CDB/Tesouro)', icon: 'üîí' },
        { id: 'stocks', name: 'A√ß√µes BR', icon: 'üáßüá∑' },
        { id: 'reits', name: 'FIIs', icon: 'üè¢' },
        { id: 'int_stocks', name: 'A√ß√µes EUA', icon: 'üá∫üá∏' },
        { id: 'crypto', name: 'Cripto', icon: '‚Çø' },
        { id: 'fund', name: 'Fundos', icon: 'üìà' },
        { id: 'reserve', name: 'Reserva Emerg√™ncia', icon: 'üÜò' },
    ];

    const CATEGORIES = {
        expense: [
            {
                id: 'home', name: 'Moradia', icon: 'üè†', color: 'bg-violet-500/10 text-violet-300 border border-violet-500/20', barColor: 'bg-violet-500',
                subcategories: ['Aluguel', 'Condom√≠nio', 'Internet/TV', '√Ågua', 'Luz', 'G√°s', 'Mercado (Limpeza)', 'Mercado (Higiene)']
            },
            {
                id: 'food', name: 'Alimenta√ß√£o', icon: 'üõí', color: 'bg-amber-500/10 text-amber-300 border border-amber-500/20', barColor: 'bg-amber-500',
                subcategories: ['Mercado (Comida)', 'Mercado (√Ågua)', 'Feira', 'Padaria']
            },
            {
                id: 'transport', name: 'Transporte', icon: 'üöó', color: 'bg-sky-500/10 text-sky-300 border border-sky-500/20', barColor: 'bg-sky-500',
                subcategories: ['Gasolina', 'Lavagem', 'Manuten√ß√£o', 'Uber/99', 'Estacionamento', 'IPVA/Licenciamento']
            },
            {
                id: 'leisure', name: 'Lazer', icon: 'üéâ', color: 'bg-pink-500/10 text-pink-300 border border-pink-500/20', barColor: 'bg-pink-500',
                subcategories: ['Restaurante', 'Bebida', 'Bares e Festas', 'Confraterniza√ß√µes', 'Netflix/Streaming', 'Viagem', 'Outros']
            },
            {
                id: 'health', name: 'Sa√∫de', icon: 'üíä', color: 'bg-rose-500/10 text-rose-300 border border-rose-500/20', barColor: 'bg-rose-500',
                subcategories: ['Academia', 'Consultas M√©dicas', 'Odonto', 'Exames', 'Rem√©dios', 'Terapia']
            },
            {
                id: 'education', name: 'Educa√ß√£o', icon: 'üìö', color: 'bg-teal-500/10 text-teal-300 border border-teal-500/20', barColor: 'bg-teal-500',
                subcategories: ['Curso', 'Faculdade', 'Livros', 'Material Escolar']
            },
            {
                id: 'shopping', name: 'Compras', icon: 'üõçÔ∏è', color: 'bg-fuchsia-500/10 text-fuchsia-300 border border-fuchsia-500/20', barColor: 'bg-fuchsia-500',
                subcategories: ['Roupas', 'Eletr√¥nicos', 'Casa', 'Presentes']
            },
            {
                id: 'adjustment', name: 'Ajuste/Reembolso', icon: 'üí∏', color: 'bg-slate-500/10 text-slate-300 border border-slate-500/20', barColor: 'bg-slate-500',
                subcategories: []
            },
            {
                id: 'other', name: 'Outros', icon: 'üì¶', color: 'bg-gray-500/10 text-gray-300 border border-gray-500/20', barColor: 'bg-gray-500',
                subcategories: ['Telefone Celular', 'Corte Cabelo/Beleza', 'Contribui√ß√£o Fam√≠lia', 'Cesta B√°sica/Doa√ß√£o', 'A√ß√£o Fim de Ano']
            },
        ],
        income: [
            { id: 'salary', name: 'Sal√°rio', icon: 'üí∞', color: 'bg-emerald-500/10 text-emerald-300 border border-emerald-500/20', subcategories: ['Adiantamento', 'Mensal', '13¬∫ Sal√°rio', 'F√©rias'] },
            { id: 'freelance', name: 'Freelance', icon: 'üíª', color: 'bg-cyan-500/10 text-cyan-300 border border-cyan-500/20', subcategories: ['Projeto', 'Consultoria'] },
            { id: 'gift', name: 'Presente', icon: 'üéÅ', color: 'bg-pink-500/10 text-pink-300 border border-pink-500/20', subcategories: [] },
            { id: 'dividends', name: 'Dividendos', icon: 'üíµ', color: 'bg-amber-500/10 text-amber-300 border border-amber-500/20', subcategories: [] },
            { id: 'adjustment', name: 'Reembolso Recebido', icon: 'üí∏', color: 'bg-slate-500/10 text-slate-300 border border-slate-500/20', subcategories: [] },
        ],
        investment: INVESTMENT_TYPES.map(t => ({
            ...t,
            color: 'bg-indigo-500/10 text-indigo-300 border border-indigo-500/20',
            barColor: 'bg-indigo-500',
            subcategories: t.id === 'reserve' ? ['Caixinha', 'Poupan√ßa'] :
                t.id === 'fixed' ? ['CDB', 'Tesouro Direto', 'LCI/LCA'] :
                    t.id === 'stocks' ? ['Varejo', 'Bancos', 'El√©tricas', 'Commodities'] :
                        t.id === 'reits' ? ['Papel', 'Tijolo', 'Fiagro'] : []
        })),
    };

    const DEFAULT_BUDGETS = {
        personal: [
            { category: 'Alimenta√ß√£o', limit: 600 },
            { category: 'Transporte', limit: 400 },
            { category: 'Lazer', limit: 500 },
        ],
        joint: [
            { category: 'Alimenta√ß√£o', limit: 1500 },
            { category: 'Moradia', limit: 2500 },
            { category: 'Lazer', limit: 800 },
        ],
    };

    // --- NOVA LISTA PADR√ÉO DE TAREFAS ---
    const DEFAULT_CHORES = [
        // DI√ÅRIAS (Todo dia aparecem)
        { id: 'dishes', title: 'Lavar a Lou√ßa', assignee: 'bruno', isRotating: true, points: 5, done: false, frequency: 'daily' },
        { id: 'trash', title: 'Tirar o Lixo', assignee: 'bruno', isRotating: false, points: 5, done: false, frequency: 'daily' },

        // SEMANAIS (Fixo da semana)
        { id: 'bath', title: 'Lavar Banheiros', assignee: 'bruno', isRotating: true, points: 30, done: false, frequency: 'weekly' },
        { id: 'floor', title: 'Aspirar e Passar Pano', assignee: 'maiara', isRotating: true, points: 40, done: false, frequency: 'weekly' },
        { id: 'clothes', title: 'Lavar/Estender Roupa', assignee: 'maiara', isRotating: true, points: 20, done: false, frequency: 'weekly' },

        // QUINZENAIS (Aparecem semana sim, semana n√£o)
        { id: 'fridge', title: 'Limpar Geladeira', assignee: 'maiara', isRotating: true, points: 50, done: false, frequency: 'biweekly' },
        { id: 'windows', title: 'Limpar Vidros/Janelas', assignee: 'bruno', isRotating: true, points: 45, done: false, frequency: 'biweekly' }
    ];

    const formatCurrency = (val) => {
        const num = Number(val);
        return isNaN(num) ? 'R$ 0,00' : new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(num);
    };

    const formatDate = (dateStr) => {
        if (typeof dateStr !== 'string' || !dateStr) return '';
        const parts = dateStr.split('-');
        return parts.length === 3 ? `${parts[2]}/${parts[1]}` : dateStr;
    };

    const getGreeting = () => {
        const h = new Date().getHours();
        if (h < 5) return { t: 'Boa madrugada', i: <Moon size={16} /> };
        if (h < 12) return { t: 'Bom dia', i: <Sunrise size={16} /> };
        if (h < 18) return { t: 'Boa tarde', i: <Sun size={16} /> };
        return { t: 'Boa noite', i: <Moon size={16} /> };
    };

    // --- COMPONENTE GRAFICO HIST√ìRICO SIMPLES (SVG) ---
    // --- COMPONENTE GRAFICO HIST√ìRICO SIMPLES (REFEITO V2 - EVOLU√á√ÉO + TOOLTIPS) ---
    const SimpleHistoryChart = ({ data, mode }) => {
        if (!data || data.length === 0) return <div className="text-center text-slate-400 text-xs py-10">Sem hist√≥rico suficiente</div>;

        // Determina qual valor plotar baseado no modo
        // Modo 'statement' (Dia a Dia): Mostra a evolu√ß√£o do SALDO (runningBalance)
        // Modo 'investment' (Investimentos): Mostra a evolu√ß√£o do PATRIM√îNIO (runningNetWorth)
        const getBarValue = (d) => mode === 'statement' ? (d.runningBalance || 0) : (d.runningNetWorth || 0);

        const values = data.map(getBarValue);
        // CORRE√á√ÉO: Usa valor absoluto para calcular altura (suporta saldo negativo)
        const maxVal = Math.max(...values.map(v => Math.abs(v)), 100);
        const height = 120; // Altura fixa do gr√°fico

        const [hoveredIndex, setHoveredIndex] = useState(null);

        return (
            <div className="w-full overflow-visible relative">
                <div className="flex items-end justify-between min-w-full h-[160px] pt-10 pb-6 px-2 relative font-sans">
                    {data.map((d, i) => {
                        const val = getBarValue(d);
                        const isNegative = val < 0;
                        // Altura da barra baseada no valor ABSOLUTO
                        const barHeight = maxVal ? (Math.abs(val) / maxVal) * height : 0;
                        const isHovered = hoveredIndex === i;

                        // Defini√ß√£o de cores baseada no modo e sinal
                        // MODO INVESTIMENTOS: Blue (Palette existente) e Indigo (Negativo)
                        const barColor = isNegative
                            ? 'bg-indigo-600' // Negativo: Indigo
                            : (mode === 'statement' ? 'bg-emerald-500' : 'bg-blue-600'); // Positivo Inv: Blue (Palette)

                        const glowColor = isNegative
                            ? 'shadow-[0_0_15px_rgba(79,70,229,0.4)]'
                            : (mode === 'statement' ? 'shadow-[0_0_15px_rgba(16,185,129,0.4)]' : 'shadow-[0_0_15px_rgba(37,99,235,0.4)]'); // Blue-600

                        // L√ìGICA DE POSICIONAMENTO DO TOOLTIP (CORRE√á√ÉO DE BORDAS)
                        const isFirst = i === 0;
                        const isLast = i === data.length - 1;

                        // Se for o primeiro, alinha √† esquerda (left-0). Se for o √∫ltimo, √† direita (right-0). Se n√£o, centraliza.
                        const tooltipAlignment = isFirst ? 'left-0 translate-x-[-10%]' : isLast ? 'right-0 translate-x-[10%]' : 'left-1/2 -translate-x-1/2';
                        // Ajuste fino: Se for first/last, a setinha precisa acompanhar a barra, mas o tooltip o container.

                        return (
                            <div
                                key={i}
                                className="flex flex-col items-center gap-2 flex-1 min-w-[40px] relative group cursor-pointer"
                                onMouseEnter={() => setHoveredIndex(i)}
                                onMouseLeave={() => setHoveredIndex(null)}
                                onClick={() => setHoveredIndex(isHovered ? null : i)} // Toggle no mobile
                            >
                                {/* √ÅREA DA BARRA (Com hit area maior invis√≠vel para facilitar toque) */}
                                <div className="h-[120px] flex items-end relative w-full justify-center">

                                    {/* BARRA VISUAL */}
                                    <div
                                        style={{ height: `${Math.max(barHeight, 4)}px` }} // M√≠nimo 4px pra n√£o sumir
                                        className={`w-3 rounded-t-md transition-all duration-500 relative
                                            ${barColor} ${isHovered ? `scale-110 ${glowColor} brightness-110` : 'opacity-80'}
                                        `}
                                    >
                                    </div>
                                </div>

                                {/* LABEL M√äS */}
                                <span className={`text-[10px] font-bold uppercase transition-colors ${isHovered ? 'text-white' : 'text-slate-500'}`}>
                                    {d.month.split('-')[1]}
                                </span>

                                {/* TOOLTIP DETALHADO (FLUTUANTE) */}
                                {isHovered && (
                                    <>
                                        {/* CONTAINER DO CONTE√öDO (POSICIONADO RELATIVO AO CONTAINER PAI) */}
                                        <div className={`absolute bottom-[140%] ${tooltipAlignment} bg-slate-900/95 border border-white/10 p-3 rounded-xl shadow-2xl z-50 w-48 backdrop-blur-md animate-fade-in pointer-events-none`}>
                                            <div className="text-center border-b border-white/10 pb-1 mb-2">
                                                <p className="text-xs font-bold text-slate-400 uppercase">{d.month}</p>
                                            </div>

                                            {mode === 'statement' ? (
                                                <div className="space-y-1">
                                                    <div className="flex justify-between items-center text-xs">
                                                        <span className="text-slate-400">Saldo Final:</span>
                                                        <span className={`font-bold ${d.runningBalance >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{formatCurrency(d.runningBalance)}</span>
                                                    </div>
                                                    <div className="flex justify-between items-center text-[10px]">
                                                        <span className="text-slate-500">Entradas:</span>
                                                        <span className="text-slate-300">+{formatCurrency(d.income)}</span>
                                                    </div>
                                                    <div className="flex justify-between items-center text-[10px]">
                                                        <span className="text-slate-500">Sa√≠das:</span>
                                                        <span className="text-rose-400">-{formatCurrency(d.expense)}</span>
                                                    </div>
                                                </div>
                                            ) : (
                                                <div className="space-y-1">
                                                    <div className="flex justify-between items-center text-xs">
                                                        <span className="text-slate-400">Patrim√¥nio:</span>
                                                        <span className={`font-bold ${d.runningNetWorth >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{formatCurrency(d.runningNetWorth)}</span>
                                                    </div>
                                                    {/* NOVO: Investimento Acumulado - Volta pro Slate para seguir logica do Income */}
                                                    <div className="flex justify-between items-center text-[10px]">
                                                        <span className="text-slate-500">Inv. Acumulado:</span>
                                                        <span className="text-slate-300">{formatCurrency(d.runningInvested)}</span>
                                                    </div>
                                                    <div className="flex justify-between items-center text-[10px]">
                                                        <span className="text-slate-500">Aporte M√™s:</span>
                                                        <span className="text-slate-300">+{formatCurrency(d.invested)}</span>
                                                    </div>
                                                </div>
                                            )}
                                        </div>

                                        {/* SETINHA (SEMPRE CENTRALIZADA NA BARRA, INDEPENDENTE DO TOOLTIP) */}
                                        <div className="absolute bottom-[130%] left-1/2 -translate-x-1/2 border-[6px] border-transparent border-t-slate-900/95 z-50 pointer-events-none"></div>
                                    </>
                                )}
                            </div>
                        );
                    })}
                </div>
            </div>
        );
    };

    // --- LOGIN ISOLADO ---
    // --- LOGIN ISOLADO (COM B√öSSOLA INTERATIVA) ---
    // --- LOGIN ISOLADO (VERS√ÉO FINAL 4 - COMPOSI√á√ÉO EQUILIBRADA) ---
    const LoginScreen = ({ onLoginSuccess }) => {
        const [user, setUser] = useState(null);
        const [pin, setPin] = useState('');
        const [error, setError] = useState('');

        // Estados da B√∫ssola
        const [isSearching, setIsSearching] = useState(true);
        const needleRef = useRef(null);

        // Efeito: Gira no in√≠cio -> Segue o mouse depois
        useEffect(() => {
            const timer = setTimeout(() => setIsSearching(false), 2500);

            const handleMouseMove = (e) => {
                if (!needleRef.current) return;
                if (isSearching) return;

                const rect = needleRef.current.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;

                const deltaX = e.clientX - centerX;
                const deltaY = e.clientY - centerY;

                // +90 graus para alinhar o norte da agulha com o mouse
                const angle = (Math.atan2(deltaY, deltaX) * 180 / Math.PI) + 90;

                needleRef.current.style.transform = `rotate(${angle}deg)`;
            };

            window.addEventListener('mousemove', handleMouseMove);
            return () => {
                clearTimeout(timer);
                window.removeEventListener('mousemove', handleMouseMove);
            };
        }, [isSearching]);

        const handlePin = (val) => {
            if (val.length > 4) return;
            setPin(val);
        };

        const submit = () => {
            if (user && pin === USER_CONFIG[user].defaultPin) onLoginSuccess(user);
            else { setError('Senha incorreta'); setPin(''); }
        };

        // TELA 1: SELE√á√ÉO DE USU√ÅRIO
        if (!user) {
            return (
                // AJUSTE: bg-transparent para mostrar a imagem do body
                <div className="min-h-screen bg-transparent flex flex-col items-center justify-center p-6 text-white font-sans overflow-hidden cursor-crosshair">

                    {/* LOGO INTERATIVA - NOSSO NORTE */}
                    <div className="w-32 h-32 relative mb-8 animate-in select-none flex items-center justify-center">

                        {/* 1. CARTEIRA BIFOLD (BASE) */}
                        <div className="absolute inset-0 flex items-center justify-center text-emerald-400 drop-shadow-[0_0_15px_rgba(52,211,153,0.25)]">
                            <svg width="65%" height="65%" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round">
                                <path d="M21 12V7H5a2 2 0 0 1 0-4h14v4" /> {/* Cart√µes atr√°s */}
                                <path d="M3 5v14a2 2 0 0 0 2 2h16v-5" />   {/* Corpo frente */}
                                <path d="M18 12a2 2 0 0 0 0 4h4v-4h-4z" /> {/* Fecho */}
                            </svg>
                        </div>

                        {/* 2. B√öSSOLA (SUPERIOR DIREITO - ACIMA DO CORA√á√ÉO) */}
                        {/* Posi√ß√£o: top-5 right-5 | Tamanho: ~42px (para igualar ao cora√ß√£o) */}
                        <div className="absolute top-2 right-1.5 w-[35px] h-[35px] flex items-center justify-center z-20">
                            {/* Aro da B√∫ssola (Est√°tico) */}
                            <div className="absolute inset-0 border-2 border-slate-600 rounded-full bg-slate-900/80 backdrop-blur-sm"></div>

                            {/* Agulha (Animada) */}
                            <div
                                ref={needleRef}
                                className={`relative w-full h-full flex items-center justify-center transition-transform duration-75 ease-out ${isSearching ? 'animate-[spin_2s_ease-in-out_infinite]' : ''}`}
                                style={{ filter: 'drop-shadow(0 2px 4px rgba(0,0,0,0.5))' }}
                            >
                                <svg width="20" height="42" viewBox="0 0 20 42">
                                    <path d="M10 2 L16 21 H4 Z" fill="#ef4444" /> {/* Norte */}
                                    <path d="M10 40 L16 21 H4 Z" fill="#e2e8f0" /> {/* Sul */}
                                    <circle cx="10" cy="21" r="2" fill="#0f172a" />
                                </svg>
                            </div>
                        </div>

                        {/* 3. CORA√á√ÉO (INFERIOR DIREITO - POSI√á√ÉO ORIGINAL) */}
                        {/* Posi√ß√£o: bottom-5 right-5 | Tamanho: 60px */}
                        <div className="absolute bottom-2 right-1 animate-pulse z-10">
                            <Heart width={35} height={35} className="text-rose-500 fill-rose-500 drop-shadow-2xl" />
                        </div>
                    </div>

                    <h1 className="text-3xl font-bold mb-2">Nosso Norte</h1>
                    <p className="text-slate-400 mb-10 text-center">Finan√ßas a dois,<br />sem complica√ß√µes.</p>

                    <div className="w-full max-w-sm grid gap-4 relative z-10">
                        {Object.entries(USER_CONFIG).map(([key, cfg]) => (
                            <button key={key} onClick={() => setUser(key)} className="bg-slate-800/50 border border-white/10 p-4 rounded-2xl flex items-center gap-4 active:scale-95 transition-all hover:bg-slate-800 hover:border-emerald-500/30 group">
                                <div className={`w-12 h-12 rounded-full flex items-center justify-center text-2xl ${cfg.color} group-hover:scale-110 transition-transform`}>
                                    {cfg.avatar}
                                </div>
                                <span className="text-lg font-bold">Sou {cfg.name}</span>
                            </button>
                        ))}
                    </div>
                </div>
            );
        }

        // TELA 2: SENHA
        return (
            <div className="min-h-screen bg-transparent flex flex-col items-center justify-center p-6 text-white font-sans animate-in">
                <button onClick={() => setUser(null)} className="absolute top-8 left-6 p-2 bg-white/10 rounded-full hover:bg-white/20 transition-colors"><ChevronLeft /></button>
                <div className={`w-20 h-20 rounded-full flex items-center justify-center text-4xl mb-4 border-4 border-slate-700 ${USER_CONFIG[user].color}`}>
                    {USER_CONFIG[user].avatar}
                </div>
                <h2 className="text-xl font-bold mb-8">Ol√°, {USER_CONFIG[user].name}</h2>
                <div className="flex gap-4 mb-8">
                    {[0, 1, 2, 3].map((i) => (
                        <div key={i} className={`w-3 h-3 rounded-full transition-colors duration-300 ${pin.length > i ? 'bg-emerald-400' : 'bg-slate-600'}`} />
                    ))}
                </div>
                {error && <p className="text-red-400 text-sm mb-4 bg-red-400/10 px-3 py-1 rounded-lg">{error}</p>}
                <div className="grid grid-cols-3 gap-4 w-64">
                    {[1, 2, 3, 4, 5, 6, 7, 8, 9].map((n) => (
                        <button key={n} onClick={() => handlePin(pin + n)} className="h-16 rounded-2xl bg-white/5 text-xl font-bold active:scale-95 hover:bg-white/10 transition-colors">{n}</button>
                    ))}
                    <div />
                    <button onClick={() => handlePin(pin + '0')} className="h-16 rounded-2xl bg-white/5 text-xl font-bold active:scale-95 hover:bg-white/10 transition-colors">0</button>
                    <button onClick={() => setPin(pin.slice(0, -1))} className="h-16 rounded-2xl flex items-center justify-center active:scale-95 hover:bg-white/10 transition-colors"><X /></button>
                </div>
                <button onClick={submit} disabled={pin.length !== 4} className={`w-64 mt-6 py-4 rounded-2xl font-bold transition-all duration-300 ${pin.length === 4 ? 'bg-emerald-500 text-white shadow-lg shadow-emerald-500/20' : 'bg-slate-800 text-slate-500'}`}>Entrar</button>
            </div>
        );
    };

    // --- COMPONENTE MARKET (V11 - COM BANCO DE DADOS) ---
    const MarketView = ({ data, shoppingList }) => { // Recebe shoppingList via props
        const [searchTerm, setSearchTerm] = useState('');
        // REMOVIDO: const [shoppingList, setShoppingList] = useState([]); <--- AGORA VEM DO FIREBASE

        // INTELIG√äNCIA DE PRE√áOS (Refinada para M√©dia Unit√°ria)
        const productIntelligence = useMemo(() => {
            const map = {};
            data.fullList.forEach(tx => {
                if (tx.items && tx.items.length > 0) {
                    tx.items.forEach(item => {
                        const normalizedName = item.name.toLowerCase().trim();
                        if (!map[normalizedName]) map[normalizedName] = { name: item.name, history: [] };

                        // Se a IA pegou o unitPrice, usa ele. Se n√£o, tenta deduzir pelo total (assumindo 1un se n√£o tiver qty)
                        // Isso evita misturar "Pre√ßo de 1kg" com "Pre√ßo de 0.5kg" na m√©dia
                        const qty = item.qty || 1;
                        const effectiveUnitPrice = item.unitPrice > 0 ? item.unitPrice : (item.value / qty);

                        map[normalizedName].history.push({
                            unitPrice: effectiveUnitPrice, // Pre√ßo de 1 UNIDADE/KG
                            market: tx.market || tx.title,
                            unit: item.unit || 'un'
                        });
                    });
                }
            });
            return Object.values(map).map(p => {
                // Ordena pelo pre√ßo unit√°rio para achar o "Melhor Lugar"
                p.history.sort((a, b) => a.unitPrice - b.unitPrice);

                const best = p.history[0];
                p.bestPrice = best.unitPrice; // Melhor pre√ßo do KG encontrado
                p.bestMarket = best.market;
                p.unit = best.unit;

                // M√©dia: Soma de todos os pre√ßos unit√°rios / qtd de compras
                p.avgPrice = p.history.reduce((a, b) => a + b.unitPrice, 0) / p.history.length;

                return p;
            }).sort((a, b) => a.name.localeCompare(b.name));
        }, [data.fullList]);

        const filteredProducts = productIntelligence.filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase()));

        // --- A√á√ïES COM BANCO DE DADOS ---
        const addToCart = async (product) => {
            // Pergunta a quantidade desejada
            const defaultQty = "1";
            const userQtyStr = prompt(
                `Quantos ${product.unit || 'un'} de "${product.name}" deseja comprar?\n\n` +
                `Pre√ßo M√©dio: ${formatCurrency(product.avgPrice)} /${product.unit || 'un'}\n` +
                `Melhor local: ${product.bestMarket} (${formatCurrency(product.bestPrice)})`,
                defaultQty
            );

            if (userQtyStr === null) return; // Cancelou

            const finalQty = parseFloat(userQtyStr.replace(',', '.')) || 1;

            // C√°lculo da Estimativa: Quantidade * Pre√ßo M√©dio (conforme seu pedido)
            const estimatedTotal = finalQty * product.avgPrice;

            const newItem = {
                name: product.name,
                plannedQty: finalQty, // Salvamos quanto queremos comprar
                unit: product.unit || 'un',
                price: estimatedTotal, // Valor estimado total
                avgUnitTest: product.avgPrice, // Guardamos a m√©dia usada para refer√™ncia
                market: product.bestMarket || '?', // Sugest√£o de onde ir
                checked: false,
                createdAt: new Date().toISOString()
            };

            await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('shopping_list').add(newItem);
            setSearchTerm('');
        };

        const addManualItem = async () => {
            if (!searchTerm) return;
            let priceInput = prompt(`Qual o pre√ßo para "${searchTerm}"?`, "0.00");
            if (priceInput === null) return;
            priceInput = priceInput.replace(',', '.');
            const finalPrice = parseFloat(priceInput);
            if (isNaN(finalPrice)) { alert("Valor inv√°lido"); return; }

            await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('shopping_list').add({
                name: searchTerm,
                price: finalPrice,
                market: 'Manual üìù',
                checked: false,
                createdAt: new Date().toISOString()
            });
            setSearchTerm('');
        };

        const toggleCartItem = async (item) => {
            // Atualiza status no Firestore
            await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('shopping_list').doc(item.id).update({ checked: !item.checked });
        };

        const removeCartItem = async (id) => {
            // Deleta do Firestore (sem confirma√ß√£o para ser r√°pido, ou com se preferir)
            await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('shopping_list').doc(id).delete();
        };

        // C√°lculo do total usando a lista que vem do banco
        const totalCart = (shoppingList || []).reduce((acc, item) => acc + (item.checked ? 0 : item.price), 0);

        return (
            <div className="space-y-6 pb-24">
                {/* LISTA DE COMPRAS ATIVA */}
                <div className="glass-card p-5">
                    <h3 className="font-bold text-lg mb-4 flex items-center gap-2 text-white uppercase tracking-wider"><ShoppingCart className="text-indigo-400" /> Lista de Compras</h3>

                    {(!shoppingList || shoppingList.length === 0) ? (
                        <p className="text-sm text-slate-400 text-center py-4">Sua lista est√° vazia.</p>
                    ) : (
                        <div className="space-y-3">
                            {shoppingList.map(item => (
                                <div key={item.id} className={`flex items-center gap-3 p-3 rounded-xl border transition-all ${item.checked ? 'bg-slate-800/30 border-white/5 opacity-50' : 'bg-slate-800/30 border-white/10'}`}>
                                    <button onClick={() => toggleCartItem(item)} className={`w-5 h-5 rounded border-2 flex items-center justify-center ${item.checked ? 'bg-indigo-500 border-indigo-500' : 'border-slate-500'}`}>
                                        {item.checked && <Check size={12} className="text-white" />}
                                    </button>
                                    <div className="flex-1">
                                        <p className={`font-bold text-sm text-white ${item.checked ? 'line-through text-slate-500' : ''}`}>{item.name}</p>

                                        {/* LINHA DE DETALHE NOVA */}
                                        <div className="flex justify-between items-center pr-2 mt-0.5">
                                            <p className="text-xs text-indigo-300 font-bold">
                                                {item.plannedQty || 1} {item.unit} <span className="text-slate-400 font-normal">x {formatCurrency(item.price / (item.plannedQty || 1))} (m√©d)</span>
                                            </p>
                                            <p className="text-xs text-slate-400 flex items-center gap-1">
                                                <TrendingDown size={10} className="text-emerald-400" /> {item.market}
                                            </p>
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        <p className="font-bold text-sm text-indigo-300">{item.price > 0 ? formatCurrency(item.price) : '-'}</p>
                                        <button onClick={() => removeCartItem(item.id)}><X size={14} className="text-slate-500 hover:text-rose-400" /></button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    <div className="mt-4 pt-4 border-t border-white/10 flex justify-between items-center">
                        <span className="text-xs font-bold uppercase text-slate-400">Estimativa</span>
                        <span className="text-xl font-bold text-white">{formatCurrency(totalCart)}</span>
                    </div>
                </div>

                {/* BUSCA UNIFICADA */}
                <div className="glass-card p-5">
                    <h3 className="font-bold text-lg mb-4 flex items-center gap-2 text-white uppercase tracking-wider"><Target className="text-emerald-400" /> Adicionar Item</h3>
                    <div className="relative mb-4">
                        <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18} />
                        <input
                            type="text"
                            placeholder="Digite o nome do produto..."
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            className="w-full bg-slate-800/50 pl-10 pr-4 py-3 rounded-xl text-sm font-bold outline-none focus:ring-2 focus:ring-emerald-500/50 text-white placeholder-slate-500 border border-white/5"
                        />
                    </div>

                    <div className="space-y-2 max-h-60 overflow-y-auto scrollbar-hide">
                        {searchTerm && (
                            <div onClick={addManualItem} className="flex items-center gap-3 p-3 bg-indigo-900/30 hover:bg-indigo-900/50 rounded-xl cursor-pointer border border-indigo-500/30 mb-2">
                                <div className="w-8 h-8 rounded-full bg-indigo-500/20 flex items-center justify-center text-indigo-300">
                                    <Plus size={16} />
                                </div>
                                <div>
                                    <p className="font-bold text-sm text-indigo-200">Adicionar "{searchTerm}"</p>
                                    <p className="text-xs text-indigo-400">Novo item na lista</p>
                                </div>
                            </div>
                        )}

                        {filteredProducts.slice(0, 10).map((prod, idx) => (
                            <div key={idx} className="flex items-center justify-between p-3 hover:bg-white/5 rounded-xl cursor-pointer group border border-transparent hover:border-white/5" onClick={() => addToCart(prod)}>
                                <div className="flex-1 pr-3 overflow-hidden">
                                    <p className="font-bold text-sm text-slate-200 truncate">{prod.name}</p>
                                    <p className="text-xs text-slate-400">
                                        M√©dia: {formatCurrency(prod.avgPrice)} {prod.unit && prod.unit !== 'un' ? `/${prod.unit}` : ''}
                                    </p>
                                </div>
                                <div className="text-right flex-shrink-0 min-w-[100px]">
                                    <p className="font-bold text-sm text-emerald-400 leading-tight">
                                        {formatCurrency(prod.bestPrice)}
                                        <span className="text-xs text-emerald-600 font-normal ml-0.5">
                                            {prod.unit && prod.unit !== 'un' ? `/${prod.unit}` : ''}
                                        </span>
                                    </p>
                                    <p className="text-xs text-slate-500 truncate max-w-[120px] ml-auto block">{prod.bestMarket || 'Sem local'}</p>
                                </div>
                                <div className="ml-2 opacity-0 group-hover:opacity-100 transition-opacity bg-emerald-500/20 p-1.5 rounded-lg">
                                    <Plus size={14} className="text-emerald-400" />
                                </div>
                            </div>
                        ))}
                        {!searchTerm && filteredProducts.length === 0 && <p className="text-center text-xs text-slate-500 py-4">Comece a digitar para ver sugest√µes.</p>}
                    </div>
                </div>
            </div>
        );
    };

    // --- COMPONENTE DE TAREFAS (V6 - COM MERCADO INTEGRADO) ---
    const ChoresView = ({ chores, onToggle, onAdd, onDelete, onRotateCycle, onResetDaily, userConfig, weekCycle, data, shoppingList }) => { // <--- ADICIONAR shoppingList AQUI
        const [mode, setMode] = useState('market'); // 'tasks' | 'market'

        const [newChore, setNewChore] = useState('');
        const [newAssignee, setNewAssignee] = useState('bruno');
        const [newFreq, setNewFreq] = useState('weekly');
        const [isRotating, setIsRotating] = useState(true);

        const [newEffort, setNewEffort] = useState('medium');
        const [customPoints, setCustomPoints] = useState(20);
        const [points, setPoints] = useState({ bruno: 0, maiara: 0 });

        const EFFORT_LEVELS = {
            easy: { label: 'üòå Sussa', points: 5, color: 'text-emerald-400' },
            medium: { label: 'üòê Normal', points: 15, color: 'text-sky-400' },
            hard: { label: 'üòÖ Cansativo', points: 30, color: 'text-amber-400' },
            heavy: { label: 'ü•µ D√≥i as Costas', points: 50, color: 'text-rose-400 font-bold' }
        };

        // Calcula Placar
        useMemo(() => {
            let p = { bruno: 0, maiara: 0 };
            if (chores) {
                chores.forEach(c => {
                    if (c.done && p[c.assignee] !== undefined) p[c.assignee] += Number(c.points || 0);
                });
            }
            setPoints(p);
        }, [chores]);

        useEffect(() => {
            if (EFFORT_LEVELS[newEffort]) setCustomPoints(EFFORT_LEVELS[newEffort].points);
        }, [newEffort]);

        const handleAdd = () => {
            if (!newChore) return;
            onAdd({
                title: newChore,
                assignee: newAssignee,
                isRotating: isRotating,
                frequency: newFreq,
                effort: newEffort,
                points: Number(customPoints),
                done: false
            });
            setNewChore('');
        };

        const visibleChores = chores.filter(c => {
            if (c.frequency === 'biweekly') return (weekCycle || 0) % 2 === 0;
            return true;
        });

        const groups = {
            daily: visibleChores.filter(c => c.frequency === 'daily'),
            weekly: visibleChores.filter(c => c.frequency !== 'daily')
        };

        const renderChoreItem = (chore) => {
            const effortKey = chore.effort || (chore.points >= 50 ? 'heavy' : chore.points >= 30 ? 'hard' : chore.points >= 15 ? 'medium' : 'easy');
            const effortStyle = EFFORT_LEVELS[effortKey] || EFFORT_LEVELS['medium'];

            return (
                <div key={chore.id} className={`flex items-center gap-3 p-3 rounded-xl border transition-all ${chore.done ? 'bg-slate-800/30 border-white/5 opacity-60' : 'bg-slate-800/40 border-white/10'}`}>
                    <button onClick={() => onToggle(chore.id)} className={`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors shrink-0 ${chore.done ? 'bg-emerald-500 border-emerald-500' : 'border-slate-500'}`}>
                        {chore.done && <Check size={14} className="text-white" />}
                    </button>

                    <div className="flex-1 min-w-0">
                        <div className="flex justify-between items-start">
                            <p className={`font-bold text-sm text-white truncate pr-2 ${chore.done ? 'line-through text-slate-500' : ''}`}>{chore.title}</p>
                            <div className="flex gap-1 items-center">
                                <span className={`text-xs px-1.5 py-0.5 rounded bg-white/5 border border-white/10 ${effortStyle.color} whitespace-nowrap`}>
                                    {effortStyle.label}
                                </span>
                                {chore.frequency === 'biweekly' && <span className="text-xs bg-purple-500/20 text-purple-300 px-1.5 py-0.5 rounded font-bold uppercase border border-purple-500/30">Quinzenal</span>}
                            </div>
                        </div>
                        <div className="flex gap-2 items-center mt-1">
                            <div className={`flex items-center gap-1 text-xs px-1.5 py-0.5 rounded font-bold text-white ${userConfig[chore.assignee]?.color || 'bg-gray-400'}`}>
                                {userConfig[chore.assignee]?.avatar} {userConfig[chore.assignee]?.name}
                            </div>
                            {chore.isRotating && <span className="text-xs text-indigo-400 flex items-center gap-0.5"><RefreshCw size={10} /></span>}
                            <span className="text-xs text-amber-500 font-bold">+{chore.points}pts</span>
                        </div>
                    </div>

                    <button onClick={() => onDelete(chore.id)} className="text-slate-500 hover:text-rose-500"><Trash size={16} /></button>
                </div>
            );
        };

        return (
            <div className="space-y-6 pb-24 animate-fade-in">

                {/* SELETOR DE MODO (Tarefas vs Mercado) */}
                <div className="flex justify-center mb-6">
                    <div className="bg-slate-900/50 p-1 rounded-2xl border border-white/10 flex">

                        {/* 1¬∫ BOT√ÉO: MERCADO (Esquerda) */}
                        <button onClick={() => setMode('market')} className={`px-6 py-2 rounded-xl text-xs font-bold flex items-center gap-2 transition-all ${mode === 'market' ? 'bg-gradient-to-r from-emerald-500 to-teal-400 text-white shadow-lg shadow-emerald-500/30 border border-emerald-400/20' : 'text-slate-400 hover:bg-white/5'}`}>
                            <ShoppingCart size={16} /> Mercado
                        </button>

                        {/* 2¬∫ BOT√ÉO: TAREFAS (Direita) - √çcone Checklist */}
                        <button onClick={() => setMode('tasks')} className={`px-6 py-2 rounded-xl text-xs font-bold flex items-center gap-2 transition-all ${mode === 'tasks' ? 'bg-gradient-to-r from-indigo-600 to-violet-600 text-white shadow-lg shadow-indigo-500/30 border border-indigo-400/20' : 'text-slate-400 hover:bg-white/5'}`}>
                            <CheckSquare size={16} /> Tarefas
                        </button>

                    </div>
                </div>

                {mode === 'market' ? (
                    <MarketView data={data} shoppingList={shoppingList} /> // <--- ADICIONAR A PROP AQUI
                ) : (
                    <>
                        {/* --- PLACAR REMOVIDO AQUI --- */}

                        {/* GRUPO 1: ROTINA DI√ÅRIA */}
                        <div className="glass-card p-5">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="font-bold text-lg flex items-center gap-2 text-white uppercase tracking-wider"><Sun className="text-amber-500" /> Rotina Di√°ria</h3>
                                <button onClick={onResetDaily} className="text-xs font-bold text-slate-400 hover:text-indigo-400 flex items-center gap-1 bg-white/5 px-2 py-1 rounded-lg border border-white/5">
                                    <RefreshCw size={10} /> Resetar Dia
                                </button>
                            </div>
                            <div className="space-y-3">{groups.daily.map(renderChoreItem)}{groups.daily.length === 0 && <p className="text-xs text-slate-500 text-center">Sem tarefas di√°rias.</p>}</div>
                        </div>

                        {/* GRUPO 2: MISS√ïES DA SEMANA */}
                        <div className="glass-card p-5 relative overflow-hidden">
                            {(weekCycle || 0) % 2 === 0 ? (
                                <div className="absolute top-0 right-0 bg-purple-500/20 text-purple-300 border-l border-b border-purple-500/30 text-xs font-bold px-3 py-1 rounded-bl-xl">
                                    ‚ú® Semana da Faxina Pesada
                                </div>
                            ) : null}

                            <h3 className="font-bold text-lg mb-4 flex items-center gap-2 text-white uppercase tracking-wider"><Broom className="text-indigo-400" /> Miss√µes da Semana</h3>
                            <div className="space-y-3">{groups.weekly.map(renderChoreItem)}{groups.weekly.length === 0 && <p className="text-xs text-slate-500 text-center">Tudo limpo por aqui!</p>}</div>

                            {/* √ÅREA DE CRIA√á√ÉO */}
                            <div className="mt-8 pt-6 border-t border-dashed border-white/10">
                                <div className="flex flex-col gap-3 mb-6 bg-slate-800/50 p-4 rounded-xl border border-white/5">
                                    <input
                                        type="text"
                                        value={newChore}
                                        onChange={e => setNewChore(e.target.value)}
                                        placeholder="Nome da tarefa (Ex: Limpar Lajes)"
                                        className="bg-transparent font-bold text-sm outline-none w-full border-b border-white/10 pb-2 text-white placeholder-slate-500"
                                    />

                                    <div className="flex gap-2">
                                        <select value={newAssignee} onChange={e => setNewAssignee(e.target.value)} className="flex-1 text-xs font-bold bg-slate-900/50 text-slate-300 p-2 rounded-lg border border-white/10 outline-none">
                                            <option value="bruno">Bruno</option>
                                            <option value="maiara">Maiara</option>
                                        </select>
                                        <select value={newFreq} onChange={e => setNewFreq(e.target.value)} className="flex-1 text-xs font-bold bg-slate-900/50 text-slate-300 p-2 rounded-lg border border-white/10 outline-none">
                                            <option value="daily">Di√°ria</option>
                                            <option value="weekly">Semanal</option>
                                            <option value="biweekly">Quinzenal</option>
                                        </select>
                                    </div>

                                    <div className="flex gap-2 items-center">
                                        <select value={newEffort} onChange={e => setNewEffort(e.target.value)} className="flex-1 text-xs font-bold bg-slate-900/50 text-slate-300 p-2 rounded-lg border border-white/10 outline-none">
                                            {Object.entries(EFFORT_LEVELS).map(([k, v]) => (
                                                <option key={k} value={k}>{v.label} ({v.points}pts)</option>
                                            ))}
                                        </select>

                                        <button onClick={() => setIsRotating(!isRotating)} className={`px-3 py-2 rounded-lg text-xs font-bold border transition-colors ${isRotating ? 'bg-indigo-500/20 text-indigo-300 border-indigo-500/30' : 'bg-white/5 text-slate-400 border-white/10'}`}>
                                            {isRotating ? 'üîÑ Revezar' : 'üîí Fixo'}
                                        </button>
                                    </div>

                                    <div className="flex justify-between items-center pt-2 border-t border-white/10 mt-1">
                                        <div className="flex items-center gap-1">
                                            <span className="text-xs font-bold text-slate-400">Pontos:</span>
                                            <input type="number" value={customPoints} onChange={e => setCustomPoints(e.target.value)} className="w-10 text-xs font-bold text-white bg-slate-900/50 border border-white/10 rounded px-1 text-center" />
                                        </div>
                                        <button onClick={handleAdd} className="bg-indigo-600 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-md active:scale-95 flex items-center gap-1 hover:bg-indigo-500">
                                            <Plus size={14} /> Criar
                                        </button>
                                    </div>
                                </div>

                                <button onClick={onRotateCycle} className="w-full bg-slate-800 text-slate-300 border border-white/10 py-3 rounded-xl font-bold text-sm shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-2 hover:bg-slate-700">
                                    <RefreshCw size={16} /> Encerrar Semana & Girar
                                </button>
                            </div>
                        </div>
                    </>
                )}
            </div>
        );
    };

    // --- APP ---
    function App() {
        const [user, setUser] = useState(null);
        const [profile, setProfile] = useState(null);
        const [txs, setTxs] = useState([]);

        // --- CORRE√á√ÉO: ADICIONE ESTA LINHA ABAIXO ---
        const [shoppingList, setShoppingList] = useState([]);

        const [budgets, setBudgets] = useState(DEFAULT_BUDGETS);
        const [viewMode, setViewMode] = useState('personal'); // 'personal' | 'joint'
        const [tab, setTab] = useState('home');

        // Filtros de Data
        const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7)); // YYYY-MM

        // Estado para alternar entre Lista e Gr√°ficos na Home
        const [extratoMode, setExtratoMode] = useState('list'); // 'list' | 'chart'

        // Dashboard Context Mode (Dia a Dia vs Investimentos) - Global para todas as abas
        const [dashboardMode, setDashboardMode] = useState('statement'); // 'statement' | 'investment'

        // --- ESTADO DE VISIBILIDADE (OLHO) ---
        const [hideValues, setHideValues] = useState(false);

        // --- NOVO: MODO DE VISUALIZA√á√ÉO (REAL vs PREVISTO) ---
        const [isForecast, setIsForecast] = useState(true); // Padr√£o: Previs√£o ligada
        // -----------------------------------------------------

        const [apiKey, setApiKey] = useState(localStorage.getItem('gemini_api_key') || '');
        const [menuOpen, setMenuOpen] = useState(false);
        const [modalOpen, setModalOpen] = useState(false);
        const [budgetModal, setBudgetModal] = useState(false);
        const [settingsModal, setSettingsModal] = useState(false);
        const [isProcessingAI, setIsProcessingAI] = useState(false);

        // Novos estados para Revis√£o, Sele√ß√£o e Expans√£o
        const [reviewData, setReviewData] = useState([]);
        const [isReviewOpen, setIsReviewOpen] = useState(false);
        const [selectionMode, setSelectionMode] = useState(false);
        const [selectedIds, setSelectedIds] = useState(new Set());
        const [expandedReviewId, setExpandedReviewId] = useState(null);
        const [expandedTxId, setExpandedTxId] = useState(null);

        // FORM STATES
        const [fTitle, setFTitle] = useState('');
        const [fAmount, setFAmount] = useState('');
        const [fType, setFType] = useState('expense');
        const [fCat, setFCat] = useState('');
        const [fShared, setFShared] = useState(false);
        const [formPayer, setFormPayer] = useState('me');
        const [isInstallment, setIsInstallment] = useState(false);
        const [installments, setInstallments] = useState(2);
        const [fDate, setFDate] = useState(new Date().toISOString().split('T')[0]);
        const [fBank, setFBank] = useState('');
        const [fMarket, setFMarket] = useState('');
        const [fInvestType, setFInvestType] = useState('');

        // --- NOVO (FASE 2): Subcategoria ---
        const [fSubCat, setFSubCat] = useState('');

        // --- NOVO (FASE 3): Recorr√™ncia e Sonhos ---
        const [fRecurrent, setFRecurrent] = useState(false);
        const [fRecurrenceEndMode, setFRecurrenceEndMode] = useState('forever'); // 'forever' | 'date' | 'count'
        const [fRecurrenceEndDate, setFRecurrenceEndDate] = useState('');
        const [fRecurrenceCount, setFRecurrenceCount] = useState(12);

        const [fDreamId, setFDreamId] = useState('');
        const [dreams, setDreams] = useState([]);
        const [dreamModal, setDreamModal] = useState(false);

        // Estados do Modal de Sonho (Atualizado Melhoria 4)
        const [dTitle, setDTitle] = useState('');
        const [dTarget, setDTarget] = useState('');
        const [dEmoji, setDEmoji] = useState('‚úàÔ∏è');
        const [dScope, setDScope] = useState('personal'); // 'personal' | 'joint'

        // --- NOVO: Estado para Edi√ß√£o ---
        const [editingId, setEditingId] = useState(null);

        const [editBudgets, setEditBudgets] = useState([]);
        const [budgetSearch, setBudgetSearch] = useState(''); // NOVO: Filtro de Or√ßamento

        // Novos estados para o contexto da importa√ß√£o

        // Novos estados para o contexto da importa√ß√£o
        const [importMarket, setImportMarket] = useState('');
        const [importBank, setImportBank] = useState('');

        // --- NOVO: ESTADOS PARA TAREFAS ---
        const [chores, setChores] = useState([]);
        const [weekCycle, setWeekCycle] = useState(0); // 0 = Par, 1 = √çmpar
        // Estado para controlar os menus dropdown do topo ('scope' | 'context' | null)
        const [activeDropdown, setActiveDropdown] = useState(null);

        // NOVOS ESTADOS PARA INVESTIMENTOS (CARTEIRA)
        const [currentPrices, setCurrentPrices] = useState({}); // Mapa: Ticker -> Pre√ßo Atual
        const [pricesModal, setPricesModal] = useState(false);
        const [fQty, setFQty] = useState('');
        const [fUnitPrice, setFUnitPrice] = useState('');

        // --- CHART INTERACTION STATE ---
        const [activeBar, setActiveBar] = useState(null); // { index: number, type: 'inc' | 'exp' | 'inv' }

        const fileInputRef = useRef(null);

        // AUTOCOMPLETE DATA MEMOS
        const uniqueTitles = useMemo(() => [...new Set(txs.map(t => t.title))].sort(), [txs]);
        const uniqueMarkets = useMemo(() => [...new Set(txs.map(t => t.market).filter(Boolean))].sort(), [txs]);

        useEffect(() => {
            const localProfile = localStorage.getItem('fincontrol_profile');
            if (localProfile && USER_CONFIG[localProfile]) {
                setProfile(localProfile);
            } else {
                localStorage.removeItem('fincontrol_profile');
                setProfile(null);
            }
            auth.signInAnonymously().catch(console.error);
            auth.onAuthStateChanged(setUser);
        }, []);

        useEffect(() => {
            if (!user) return;
            const unsubTx = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('transactions')
                .onSnapshot(snap => {
                    const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    list.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
                    setTxs(list);
                });
            const unsubBudgets = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('settings').doc('budgets')
                .onSnapshot(s => { if (s.exists) setBudgets(s.data()); });

            // FASE 3: Carregar Sonhos (CORRIGIDO)
            const unsubDreams = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('dreams')
                .onSnapshot(snap => {
                    setDreams(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });

            // Carregar Cota√ß√µes Manuais (Carteira)
            const unsubPrices = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('settings').doc('assetPrices')
                .onSnapshot(s => { if (s.exists) setCurrentPrices(s.data()); });

            // --- NOVO: CARREGAR TAREFAS ---
            const unsubChores = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('chores')
                .onSnapshot(snap => {
                    if (snap.empty) setChores(DEFAULT_CHORES);
                    else setChores(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });

            // <--- ADICIONAR ESTE BLOCO (LISTENER DA LISTA DE COMPRAS) ---
            const unsubShopping = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('shopping_list')
                .onSnapshot(snap => {
                    const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    // Ordena: Pendentes primeiro, depois os comprados
                    list.sort((a, b) => (a.checked === b.checked ? 0 : a.checked ? 1 : -1));
                    setShoppingList(list);
                });

            const unsubChoreSettings = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('settings').doc('chores')
                .onSnapshot(s => { if (s.exists) setWeekCycle(s.data().weekCycle || 0); });

            return () => { unsubTx(); unsubBudgets(); unsubDreams(); unsubPrices(); unsubChores(); unsubShopping(); unsubChoreSettings(); }; // <--- ADICIONE unsubShopping() NO RETURN
        }, [user]);

        // --- BLOCO DE DADOS CORRIGIDO (v27) ---
        const data = useMemo(() => {
            if (!profile) return null;

            let fullList = [...txs];

            // --- CORRE√á√ÉO v41: Busca de Pend√™ncias Isolada e Segura ---
            // Agora buscamos pend√™ncias em TODO o hist√≥rico, independente de m√™s ou filtro
            const pendingSettlements = fullList.filter(t =>
                t.isSettlement &&
                t.status === 'pending' &&
                t.ownerId !== profile // S√≥ mostro se EU preciso confirmar (ou seja, n√£o fui eu que criei)
            );

            // --- 1. PROJE√á√ÉO (Mantido) ---
            const today = new Date();
            const currentMonthStr = today.toISOString().slice(0, 7);
            const isFutureView = selectedMonth > currentMonthStr;

            if (isFutureView) {
                // ... (L√≥gica de proje√ß√£o continua igual aqui ...)
                const recurrenceMap = new Map();
                txs.forEach(t => { if (t.isRecurrent && !t.isSettlement) recurrenceMap.set(t.title.toLowerCase().trim(), t); });

                recurrenceMap.forEach(template => {
                    const existsInMonth = txs.some(t =>
                        t.date.startsWith(selectedMonth) &&
                        t.title.toLowerCase().trim() === template.title.toLowerCase().trim()
                    );
                    if (!existsInMonth) {
                        // --- L√ìGICA DE FIM DA RECORR√äNCIA (NOVO) ---
                        let shouldProject = true;
                        if (template.recurrenceEndMode === 'date' && template.recurrenceEndDate) {
                            if (selectedMonth > template.recurrenceEndDate.slice(0, 7)) shouldProject = false;
                        }
                        else if (template.recurrenceEndMode === 'count' && template.recurrenceCount) {
                            const start = new Date(template.date);
                            const current = new Date(selectedMonth + '-01');
                            const diffMonths = (current.getFullYear() - start.getFullYear()) * 12 + (current.getMonth() - start.getMonth());
                            if (diffMonths >= template.recurrenceCount) shouldProject = false;
                        }

                        if (shouldProject) {
                            const day = template.date.split('-')[2] || '05';
                            fullList.push({ ...template, id: 'ghost_' + template.id, date: `${selectedMonth}-${day}`, isProjection: true, displayTitle: template.title + ' (Previsto)' });
                        }
                    }
                });
            }

            // --- 2. FILTROS DE UNIVERSO (L√≥gica Financeira Blindada v42) ---
            const filterByUniverse = (t) => {
                // L√≥gica de Acertos (Settlements)
                if (t.isSettlement) {
                    if (viewMode === 'joint') return false; // Acerto n√£o √© despesa conjunta, √© transfer√™ncia

                    // No pessoal, mostro se EU participei (paguei ou recebi confirmado)
                    if (t.ownerId === profile) return true;
                    if (t.ownerId !== profile) return t.status === 'confirmed';
                    return false;
                }

                // Modo Conjunto: Mostra tudo que √© compartilhado (Centro de Custo da Casa)
                if (viewMode === 'joint') return t.isShared && !t.isSettlement;

                // Modo Pessoal ("Meu Mundo"):
                // Regra 1: √â meu e privado?
                const myPrivate = t.ownerId === profile && !t.isShared;

                // Regra 2: √â compartilhado, mas saiu do MEU bolso? (Corre√ß√£o do Buraco Cont√°bil)
                // Cen√°rio A: Eu lancei e paguei "me"
                const iCreatedAndPaid = t.ownerId === profile && t.payer === 'me' && t.isShared;
                // Cen√°rio B: O parceiro lan√ßou, mas marcou "partner" (ou seja, EU paguei)
                const partnerCreatedAndIPaid = t.ownerId !== profile && t.payer === 'partner' && t.isShared;

                return myPrivate || iCreatedAndPaid || partnerCreatedAndIPaid;
            };

            // --- FASE 3: C√ÅLCULO DE SALDO ACUMULADO ---
            const startOfSelectedMonth = `${selectedMonth}-01`;
            // ... (resto do c√≥digo igual)

            // Filtra tudo que aconteceu ANTES deste m√™s, respeitando o mesmo filtro de mundo (Seguran√ßa Total)
            const previousTxs = fullList
                .filter(t => t.date < startOfSelectedMonth && !t.isProjection) // Ignora futuro e proje√ß√µes
                .filter(filterByUniverse); // Aplica a regra: S√≥ soma o que √© MEU (se pessoal) ou NOSSO (se conjunto)

            // Calcula o saldo hist√≥rico
            let previousBalance = 0;
            // --- IN√çCIO DA ALTERA√á√ÉO ---
            let accumInvest = 0; // Novo rastreador

            previousTxs.forEach(t => {
                const val = Number(t.amount);

                // CORRE√á√ÉO: L√≥gica de Acertos exclusiva (Igual ao loop do m√™s atual)
                if (t.isSettlement) {
                    if (t.ownerId === profile) previousBalance -= val; // Eu paguei = saiu
                    else previousBalance += val; // Recebi = entrou
                    return; // Retorna para n√£o contar duas vezes
                }

                if (t.type === 'income') previousBalance += val;
                else if (t.type === 'expense') previousBalance -= val;

                // Investimento sai do caixa (realidade), mas somamos no acumulador
                else if (t.type === 'investment') {
                    previousBalance -= val;
                    accumInvest += val;
                }
            });
            // -----------------------------------------------------------



            // --- IN√çCIO DA ALTERA√á√ÉO ---
            const todayStr = new Date().toISOString().split('T')[0];
            const monthBaseList = fullList
                .filter(filterByUniverse)
                .filter(t => t.date.startsWith(selectedMonth));

            // Cen√°rio 1: PREVISTO (Tudo: Realizado + Futuro + Fantasmas)
            const listForecast = monthBaseList.map(t => {
                if (t.isSettlement && t.ownerId !== profile) return { ...t, type: 'income', displayTitle: 'Acerto Recebido' };
                return t;
            });

            // Cen√°rio 2: REALIZADO (Apenas passado/hoje e SEM proje√ß√µes)
            const listReal = listForecast.filter(t => !t.isProjection);

            // Define qual lista usar baseado no bot√£o
            const currentMonthList = isForecast ? listForecast : listReal;
            // --- FIM DA ALTERA√á√ÉO ---

            // --- 3. C√ÅLCULOS DE CAIXA (Saldos e Relat√≥rios) ---
            // --- 3. C√ÅLCULOS DE CAIXA (Saldos e Relat√≥rios) ---
            let inc = 0, exp = 0, inv = 0;
            let strictScopeInv = 0; // Nova m√©trica para Relat√≥rio (Corre√ß√£o 2)
            let dailyCatMap = {}; let incomeCatMap = {}; let dailyBankFlow = {};
            let monthlyDividends = 0;

            // NOVO: Acumulador para o Item 7 (Comparativo Ele/Ela)
            let sharedSpends = { bruno: 0, maiara: 0 };

            currentMonthList.forEach(t => {
                const val = Number(t.amount);
                if (t.isSettlement) {
                    if (t.ownerId === profile) {
                        exp += val;
                        // Integra o valor do acerto na categoria de Ajustes para o gr√°fico
                        const cName = t.category || 'Ajuste/Reembolso';
                        dailyCatMap[cName] = (dailyCatMap[cName] || 0) + val;
                    } else {
                        inc += val;
                    }
                    return;
                }

                if (t.type === 'income') {
                    inc += val;
                    const cName = t.category || 'Outros';
                    incomeCatMap[cName] = (incomeCatMap[cName] || 0) + val;
                    if (t.title.toLowerCase().includes('dividendo') || t.category === 'Dividendos') monthlyDividends += val;
                    if (t.bank) dailyBankFlow[t.bank] = (dailyBankFlow[t.bank] || 0) + val;
                }
                else if (t.type === 'expense') {
                    exp += val;
                    const cName = t.category || 'Outros';
                    dailyCatMap[cName] = (dailyCatMap[cName] || 0) + val;
                    if (t.bank) { if (!dailyBankFlow[t.bank]) dailyBankFlow[t.bank] = 0; dailyBankFlow[t.bank] -= val; }

                    // NOVO (Item 7): Se for compartilhado, soma para o dono respectivo
                    if (viewMode === 'joint' && t.ownerId && sharedSpends[t.ownerId] !== undefined) {
                        sharedSpends[t.ownerId] += val;
                    }
                }
                else if (t.type === 'investment') {
                    inv += val;
                    // CORRE√á√ÉO 2: Filtra estritamente pelo Mundo atual para o Relat√≥rio
                    // Se estou em "Meu Mundo", s√≥ conta o que √© !isShared. Se "Nosso", s√≥ isShared.
                    const belongsToScope = viewMode === 'joint' ? t.isShared : !t.isShared;
                    if (belongsToScope) strictScopeInv += val;
                }
            });

            const bal = inc - exp - inv;
            // CORRE√á√ÉO 1: Total de Sa√≠das para o Gr√°fico (Despesa + Investimento)
            const totalOutflows = exp + inv;

            // --- 4. C√ÅLCULO DO ACERTO CASAL (CORRE√á√ÉO v30: Trava de Coer√™ncia) ---
            let credit = 0, debt = 0;       // Acumulado at√© o m√™s selecionado
            let totCredit = 0, totDebt = 0; // Total Geral (Futuro incluso)
            let economicExp = 0;

            // Define data limite (√∫ltimo dia do m√™s selecionado)
            const [selYear, selMonth] = selectedMonth.split('-').map(Number);
            const lastDayOfMonth = new Date(selYear, selMonth, 0).toISOString().split('T')[0];

            // --- IN√çCIO DA ALTERA√á√ÉO ---
            fullList.forEach(t => {
                // FILTRO MESTRE DO ACERTO:
                const val = Number(t.amount);

                // CORRE√á√ÉO: A defini√ß√£o de "Futuro" para o c√°lculo do saldo deve ser sempre "Depois deste m√™s".
                // Antes, o modo Realizado cortava no dia de "Hoje", ignorando contas manuais do fim do m√™s.
                const isFuture = t.date > lastDayOfMonth;
                const isGhost = t.isProjection;

                // Se modo Real: Ignora APENAS fantasmas (Proje√ß√µes autom√°ticas).
                // Lan√ßamentos manuais futuros (data > hoje) agora ENTRAM na conta, pois s√£o d√≠vidas firmadas.
                if (!isForecast && isGhost) return;

                // L√≥gica Econ√¥mica (Gasto Real)
                // (Removemos a trava de data aqui tamb√©m para alinhar com o filtro acima)
                if (!isFuture && !isGhost && t.ownerId === profile && t.type === 'expense') {
                    if (t.isShared) economicExp += val / 2; else economicExp += val;
                }
                // --- FIM DA ALTERA√á√ÉO ---

                if (t.isShared && !t.isSettlement) {
                    const half = val / 2;
                    let realPayerId = t.ownerId;
                    if (t.payer === 'partner') realPayerId = t.ownerId === profile ? 'partner_placeholder' : profile;
                    const iPaid = (t.ownerId === profile && t.payer === 'me') || (t.ownerId !== profile && t.payer === 'partner');

                    // 1. Soma no Total Global (Sempre)
                    if (iPaid) totCredit += half; else totDebt += half;

                    // 2. Soma no M√™s (Apenas se j√° venceu)
                    if (!isFuture) {
                        if (iPaid) credit += half; else debt += half;
                    }
                }

                if (t.isSettlement) {
                    const isExpense = t.type === 'expense';
                    // Quem desembolsou de fato?
                    const effectivePayerIsMe = (t.ownerId === profile && isExpense) || (t.ownerId !== profile && !isExpense);

                    // Acertos impactam tanto o Global quanto o Mensal (pois o dinheiro j√° saiu)
                    if (effectivePayerIsMe) {
                        credit += val; totCredit += val;
                    } else {
                        debt += val; totDebt += val;
                    }
                }
            });

            const rawCoupleBal = credit - debt;         // Saldo Matem√°tico do M√™s (Vencido - Pago)
            const totalCoupleBal = totCredit - totDebt; // Saldo Real da Vida (Tudo que devo - Tudo que paguei)

            // --- A M√ÅGICA (TRAVA DE COER√äNCIA) ---
            let coupleBal = rawCoupleBal;

            // Regra: O saldo do m√™s n√£o pode contradizer ou exceder a d√≠vida total.
            // Se eu tenho cr√©dito no m√™s (+4000), mas a d√≠vida total √© 0 (ou negativa), 
            // significa que eu s√≥ antecipei parcelas. O m√™s deve mostrar 0 (ou o teto da d√≠vida real).

            // Se os sinais forem opostos (ex: M√™s diz Receber, Total diz Pagar), algo est√° errado (antecipa√ß√£o). Zera.
            if ((rawCoupleBal > 0 && totalCoupleBal < 0) || (rawCoupleBal < 0 && totalCoupleBal > 0)) {
                coupleBal = 0;
            }
            // Se mesmo sinal, limita ao valor do Total.
            // Ex: Se o m√™s diz que tenho 5000 a receber, mas no total s√≥ falta receber 1000, mostra 1000.
            else {
                if (Math.abs(rawCoupleBal) > Math.abs(totalCoupleBal)) {
                    coupleBal = totalCoupleBal;
                }
            }
            // -------------------------------------

            // --- 5. INVESTIMENTOS (Carteira) ---
            const investments = txs.filter(t => {
                if (t.type !== 'investment') return false;
                if (viewMode === 'joint') return t.isShared; // Nosso Mundo: S√≥ compartilhados
                return !t.isShared && t.ownerId === profile; // Meu Mundo: S√≥ MEUS e PRIVADOS
            });

            // CORRE√á√ÉO: Filtrar investimentos at√© a data selecionada para o Dashboard
            // Se n√£o, mostra o valor ATUAL (Futuro) em meses passados
            const historicalInvestments = investments.filter(t => t.date <= lastDayOfMonth);

            // CORRE√á√ÉO: Calcular valor HIST√ìRICO do m√™s anterior para o Dashboard "M√™s Anterior"
            const lastDayOfPrevMonth = new Date(selYear, selMonth - 1, 0).toISOString().split('T')[0];
            const prevInvestments = investments.filter(t => t.date <= lastDayOfPrevMonth);

            const totalInvested = historicalInvestments.reduce((acc, t) => acc + Number(t.amount), 0);

            let portfolio = {};
            let portfolioCurrentTotal = 0;
            let portfolioPreviousTotal = 0; // Novo Total do M√™s Anterior

            let investBankFlow = {};
            let investCatMap = {};

            // Fun√ß√£o helper para calcular total de carteira em data espec√≠fica
            const calculatePortfolioTotal = (investmentList) => {
                let tempPortfolio = {};
                let total = 0;
                investmentList.forEach(t => {
                    const assetName = t.market || t.category || 'Outros';
                    if (!tempPortfolio[assetName]) tempPortfolio[assetName] = { qty: 0, totalCost: 0, currentPrice: currentPrices[assetName] || 0 };

                    const qty = t.quantity > 0 ? Number(t.quantity) : 0;
                    tempPortfolio[assetName].qty += qty;
                    tempPortfolio[assetName].totalCost += Number(t.amount);
                });

                Object.values(tempPortfolio).forEach(asset => {
                    if (asset.qty > 0) {
                        const avgPrice = asset.totalCost / asset.qty;
                        const price = asset.currentPrice > 0 ? Number(asset.currentPrice) : avgPrice;
                        total += asset.qty * price;
                    } else {
                        total += asset.totalCost;
                    }
                });
                return total;
            };

            // Calcula Totais
            portfolioCurrentTotal = calculatePortfolioTotal(historicalInvestments);
            portfolioPreviousTotal = calculatePortfolioTotal(prevInvestments);

            // Reconstr√≥i Portfolio Detalhado para Exibi√ß√£o (Baseado no M√™s Atual)
            // (Mant√©m l√≥gica original para popular a lista detalhada)
            historicalInvestments.forEach(t => {
                const assetName = t.market || t.category || 'Outros';
                if (!portfolio[assetName]) portfolio[assetName] = { name: assetName, qty: 0, totalCost: 0, avgPrice: 0, currentPrice: currentPrices[assetName] || 0, currentTotal: 0 };
                const qty = t.quantity > 0 ? Number(t.quantity) : 0;
                portfolio[assetName].qty += qty;
                portfolio[assetName].totalCost += Number(t.amount);

                if (t.bank) investBankFlow[t.bank] = (investBankFlow[t.bank] || 0) + Number(t.amount);
                const cName = t.category || 'Outros';
                investCatMap[cName] = (investCatMap[cName] || 0) + Number(t.amount);
            });

            Object.values(portfolio).forEach(asset => {
                if (asset.qty > 0) {
                    asset.avgPrice = asset.totalCost / asset.qty;
                    const price = asset.currentPrice > 0 ? Number(asset.currentPrice) : asset.avgPrice;
                    asset.currentTotal = asset.qty * price;
                } else {
                    asset.currentTotal = asset.totalCost;
                }
            });

            const profit = portfolioCurrentTotal - totalInvested;
            const yieldPct = totalInvested > 0 ? (profit / totalInvested) * 100 : 0;

            // --- IN√çCIO DA ALTERA√á√ÉO ---
            // 1. Patrim√¥nio Real (Meu Mundo): Soma Saldo Acumulado + Investimentos
            const accumulatedCash = previousBalance + bal;
            const netWorth = accumulatedCash + portfolioCurrentTotal;

            // 2. Dados para a Legenda (Nosso Mundo):
            // Total investido que comp√µe o saldo (Hist√≥rico + M√™s Atual)
            const totalInvestInBalance = accumInvest + inv;
            // O "Gasto L√≠quido" √© o Saldo Total descontando o que foi guardado
            const operationalBalance = (previousBalance + bal) + totalInvestInBalance;
            // --- FIM DA ALTERA√á√ÉO ---

            // --- SONHOS e METAS (Mantido) ---
            const filteredDreams = dreams.filter(d => {
                if (viewMode === 'joint') return d.scope === 'joint';
                return d.scope === 'personal' || !d.scope;
            });
            const dreamsProgress = filteredDreams.map(d => {
                const currentAmount = txs
                    .filter(t => t.type === 'investment' && t.dreamId === d.id)
                    .reduce((acc, t) => acc + Number(t.amount), 0);
                const pct = d.targetAmount > 0 ? (currentAmount / d.targetAmount) * 100 : 0;
                return { ...d, currentAmount, pct };
            });

            // Or√ßamentos (Mantido)
            const currentBudgets = budgets[viewMode] || [];
            const rawBudgets = currentBudgets.filter(b => {
                const isInvestContext = CATEGORIES.investment.some(c => c.name === b.category) || b.category === 'Dividendos';
                if (dashboardMode === 'statement') return !isInvestContext && Number(b.limit) >= 0;
                return isInvestContext && Number(b.limit) >= 0;
            });

            let planning = rawBudgets.map(b => {
                let realized = 0; let type = 'out';
                const isIncome = CATEGORIES.income.some(c => c.name === b.category) || CATEGORIES.income.some(c => c.subcategories?.includes(b.category)) || b.category === 'Dividendos';
                if (isIncome) {
                    type = 'in';
                    if (b.category === 'Dividendos') realized = monthlyDividends;
                    else realized = currentMonthList.filter(t => t.type === 'income' && (t.category === b.category || t.subCategory === b.category)).reduce((acc, t) => acc + Number(t.amount), 0);
                } else {
                    type = 'out';
                    realized = currentMonthList.filter(t => (t.type === 'expense' || t.type === 'investment') && (t.category === b.category || t.subCategory === b.category)).reduce((acc, t) => acc + Number(t.amount), 0);
                }
                let icon = 'üéØ';
                [...CATEGORIES.expense, ...CATEGORIES.income, ...CATEGORIES.investment].forEach(c => {
                    if (c.name === b.category) icon = c.icon;
                    if (c.subcategories && c.subcategories.includes(b.category)) icon = '‚Ü≥';
                });
                if (b.category === 'Dividendos') icon = 'üíµ';
                return { ...b, realized, limit: Number(b.limit), type, icon };
            });
            planning = planning.map(p => ({ ...p, pct: Math.min(p.limit > 0 ? (p.realized / p.limit) * 100 : 0, 100), rawPct: p.limit > 0 ? (p.realized / p.limit) * 100 : 0 })).filter(p => p.limit > 0 || p.realized > 0);

            // Charts
            // 1. Mapeia todas as categorias presentes nos lan√ßamentos
            const allCharts = Object.keys(dailyCatMap).map(k => ({
                name: k,
                amount: dailyCatMap[k],
                pct: exp > 0 ? (dailyCatMap[k] / exp) * 100 : 0,
                icon: CATEGORIES.expense.find(c => c.name === k)?.icon || 'üè∑Ô∏è',
                color: CATEGORIES.expense.find(c => c.name === k)?.barColor || 'bg-gray-500'
            })).sort((a, b) => b.amount - a.amount);

            // 2. Extrai o Top 5
            const top5 = allCharts.slice(0, 5);

            // 3. Calcula o res√≠duo (do 6¬∫ item em diante)
            const remainder = allCharts.slice(5);

            if (remainder.length > 0) {
                const othersAmount = remainder.reduce((sum, item) => sum + item.amount, 0);
                top5.push({
                    name: 'Outros',
                    amount: othersAmount,
                    pct: exp > 0 ? (othersAmount / exp) * 100 : 0,
                    icon: 'üì¶',
                    color: 'bg-slate-500' // Cor neutra para o res√≠duo
                });
            }

            const dailyCharts = top5;
            const investCharts = Object.keys(investCatMap).map(k => ({ name: k, amount: investCatMap[k], pct: inv > 0 ? (investCatMap[k] / inv) * 100 : 0, icon: CATEGORIES.investment.find(c => c.name === k)?.icon || 'üìà', color: CATEGORIES.investment.find(c => c.name === k)?.barColor || 'bg-indigo-500' })).sort((a, b) => b.amount - a.amount);

            // History (Refeito para acumular Saldo e Patrim√¥nio)
            // History (Refeito para acumular Saldo e Patrim√¥nio)
            const historyMap = {};
            // CORRE√á√ÉO: Aplica o filtro de universo (Meu/Nosso Norte) igual ao Dashboard
            txs.filter(filterByUniverse).forEach(t => {
                const m = t.date.slice(0, 7);
                if (!historyMap[m]) historyMap[m] = { month: m, income: 0, expense: 0, investedFlow: 0, investedAsset: 0 };

                // CORRE√á√ÉO: L√≥gica de Acertos exclusiva (evita duplicidade com income/expense)
                if (t.isSettlement) {
                    if (t.ownerId === profile) historyMap[m].expense += Number(t.amount);
                    else historyMap[m].income += Number(t.amount);
                    return; // Retorna para n√£o contar novamente abaixo
                }

                if (t.type === 'income') historyMap[m].income += Number(t.amount);
                else if (t.type === 'expense') historyMap[m].expense += Number(t.amount);
                else if (t.type === 'investment') {
                    // FLUXO DE CAIXA (Saiu do meu bolso?): Entra na conta do Saldo
                    historyMap[m].investedFlow += Number(t.amount);

                    // ATIVO (√â meu patrim√¥nio?): Entra na conta do Acumulado/Net Worth
                    // Se estou em 'Meu Norte', s√≥ conta se for privado (!isShared).
                    // Se estou em 'Nosso Norte', s√≥ conta se for compartilhado (isShared).
                    const belongsToScope = viewMode === 'joint' ? t.isShared : !t.isShared;
                    if (belongsToScope) {
                        historyMap[m].investedAsset += Number(t.amount);
                    }
                }
            });

            // Converte para array e ordena
            let historyArray = Object.values(historyMap).sort((a, b) => a.month.localeCompare(b.month));

            // Calcula Acumulados (Running Totals) para o Gr√°fico de Evolu√ß√£o
            let currentRunningBalance = 0;
            let currentRunningInvested = 0;

            historyArray = historyArray.map(h => {
                // Balan√ßo do m√™s = Entradas - Sa√≠das - Investimentos (Fluxo de Caixa)
                // OBS: Investimento sai do "Caixa" (Saldo), mas entra no "Patrim√¥nio" (apenas se for do escopo)
                const monthFlow = h.income - h.expense - h.investedFlow;
                currentRunningBalance += monthFlow;
                currentRunningInvested += h.investedAsset; // Acumula apenas ativos do escopo

                return {
                    ...h,
                    runningBalance: currentRunningBalance,
                    runningInvested: currentRunningInvested, // NOVO: Expondo acumulado de aportes filtrado
                    runningNetWorth: currentRunningBalance + currentRunningInvested, // Saldo + Investido (do escopo)
                    invested: h.investedFlow // Mant√©m compatibilidade com gr√°fico de barras (mostra o desembolso)
                };
            });

            // Pega apenas os √∫ltimos 6 meses (ou mais se quiser)
            const finalHistory = historyArray.slice(-6);

            return {
                list: currentMonthList, fullList, bal, inc, exp, inv,
                previousBalance,
                sharedSpends, // <--- ADICIONADO AQUI
                coupleBal, rawCoupleBal, totalCoupleBal,
                totalInvestInBalance,
                operationalBalance,
                pendingSettlements,
                planning, dreamsProgress, netWorth, economicExp,
                analysis: { daily: { charts: dailyCharts, bankFlow: dailyBankFlow }, invest: { charts: investCharts, bankFlow: investBankFlow }, history: finalHistory, health: { savingsRate: inc > 0 ? ((inc - exp) / inc) * 100 : 0, burnRate: exp, coverage: exp > 0 ? (portfolioCurrentTotal / exp) : 0, freedom: exp > 0 ? (monthlyDividends / exp) * 100 : 0, investRate: inc > 0 ? (inv / inc) * 100 : 0, totalNetWorth: netWorth, totalOutflows: totalOutflows, strictScopeInv: strictScopeInv } },
                investData: { totalInvested, totalCurrent: portfolioCurrentTotal, previousTotal: portfolioPreviousTotal, profit, yieldPct, byBank: investBankFlow, byType: investCatMap, dividends: monthlyDividends, portfolio: Object.values(portfolio).sort((a, b) => b.currentTotal - a.currentTotal) }
            };
            // --- CORRE√á√ÉO: ADICIONADO 'isForecast' NAS DEPEND√äNCIAS ABAIXO ---
        }, [txs, profile, viewMode, budgets, selectedMonth, dashboardMode, currentPrices, dreams, isForecast]);

        // --- EXPORTAR EXCEL ---
        const exportData = () => {
            if (!data || !data.fullList.length) return alert("Nada para exportar");

            const exportList = data.fullList.map(t => ({
                Data: t.date,
                Titulo: t.title,
                Valor: t.amount,
                Tipo: t.type === 'expense' ? 'Despesa' : t.type === 'income' ? 'Receita' : 'Investimento',
                Categoria: t.category,
                Banco: t.bank ? (BANKS.find(b => b.id === t.bank)?.name || t.bank) : '',
                Local: t.market || '',
                Compartilhado: t.isShared ? 'Sim' : 'N√£o',
                QuemPagou: t.payer === 'me' ? 'Eu' : 'Parceiro'
            }));

            const ws = XLSX.utils.json_to_sheet(exportList);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Transacoes");
            XLSX.writeFile(wb, `NossoNorte_${new Date().toISOString().split('T')[0]}.xlsx`);
        };

        // --- UNIVERSAL IA HANDLER ---
        const askGemini = async (prompt, inlineData) => {
            if (!apiKey) { alert("Chave API n√£o configurada! V√° em Configura√ß√µes."); return null; }
            const tryModel = async (modelName) => {
                const genAI = new GoogleGenerativeAI(apiKey);
                const model = genAI.getGenerativeModel({ model: modelName });
                const result = await model.generateContent([prompt, inlineData]);
                return result.response.text();
            };
            try {
                const text = await tryModel("gemini-2.5-flash");
                return JSON.parse(text.replace(/```json|```/g, '').trim());
            } catch (e) {
                try {
                    const text = await tryModel("gemini-1.5-flash");
                    return JSON.parse(text.replace(/```json|```/g, '').trim());
                } catch (finalError) {
                    alert("Erro na IA: " + finalError.message);
                    return null;
                }
            }
        };

        const handleUniversalUpload = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            setIsProcessingAI(true);
            setMenuOpen(false);

            // Prompt Matrix-Aware
            const currentMonthIndex = new Date().getMonth();
            const months = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
            const currentMonthName = months[currentMonthIndex];

            const promptBase = `
                    ATEN√á√ÉO: Voc√™ √© um assistente financeiro cont√°bil experiente.
                    Sua miss√£o: Ler este arquivo e encontrar despesas/receitas REAIS do m√™s de ${currentMonthName}.
                    
                    REGRAS CR√çTICAS:
                    1. Se houver detalhamento de itens (ex: lista de produtos no mercado), extraia-os no campo 'items'. 
                       IMPORTANTE: Tente identificar a QUANTIDADE (qty), PRE√áO UNIT√ÅRIO (unitPrice) e UNIDADE (unit - ex: kg, un, l).
                       Formato: items: [{name: 'Queijo', value: 20.00, qty: 0.5, unitPrice: 40.00, unit: 'kg'}, ...].
                    2. Se for uma PLANILHA MATRIZ (meses nas colunas): IGNORE colunas de outros meses. Foque APENAS na coluna referente a ${currentMonthName}.
                    3. IGNORE linhas de "Total", "Saldo", "Cart√£o de Cr√©dito" (se for o pagamento da fatura, ok, mas evite duplicidade).
                    4. Tente identificar o nome do ESTABELECIMENTO (Loja, Mercado, etc) e coloque no campo 'market'.
                    5. Se for poss√≠vel identificar o BANCO/CONTA de origem, coloque no campo 'bank' (ex: Nubank, Ita√∫).
                    
                    SA√çDA OBRIGAT√ìRIA (JSON puro sem markdown):
                    {
                        "transactions": [
                            { 
                                "date": "YYYY-MM-DD", 
                                "title": "Nome da despesa", 
                                "amount": 0.00, 
                                "type": "expense", 
                                "category": "Alimenta√ß√£o",
                                "market": "Nome da Loja",
                                "bank": "Nome do Banco",
                                "items": [ {"name": "Item A", "value": 10.00, "qty": 1, "unitPrice": 10.00, "unit": "un"} ] 
                            }
                        ]
                    }
                `;

            try {
                // L√≥gica V7 Recuperada
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onloadend = async () => {
                        const base64 = reader.result.split(',')[1];
                        const data = await askGemini(promptBase, { inlineData: { data: base64, mimeType: file.type } });
                        processAIResponse(data);
                    };
                    return;
                }
                else if (file.type === 'application/pdf') {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                    let fullText = '';
                    const maxPages = Math.min(pdf.numPages, 3);
                    for (let i = 1; i <= maxPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        fullText += textContent.items.map(item => item.str).join(' ') + '\n';
                    }
                    // Para texto, n√£o usamos inlineData, mandamos no prompt
                    const data = await askGemini(promptBase + "\n\nCONTE√öDO TEXTO:\n" + fullText, null);
                    processAIResponse(data);
                    return;
                }
                else {
                    // Tentar ler como planilha (XLSX/CSV)
                    const reader = new FileReader();
                    reader.onload = async (evt) => {
                        const bstr = evt.target.result;
                        const wb = XLSX.read(bstr, { type: 'binary' });
                        let allText = "";
                        wb.SheetNames.forEach(name => {
                            const ws = wb.Sheets[name];
                            allText += `\n--- ABA: ${name} ---\n` + XLSX.utils.sheet_to_csv(ws);
                        });
                        const data = await askGemini(promptBase + "\n\nDADOS CSV:\n" + allText.substring(0, 30000), null);
                        processAIResponse(data);
                    };
                    reader.readAsBinaryString(file);
                    return;
                }
            } catch (error) {
                console.error(error);
                alert("Erro leitura arquivo: " + error.message);
                setIsProcessingAI(false);
            }
        };

        const processAIResponse = (respData) => {
            if (respData && respData.transactions && respData.transactions.length > 0) {
                const prepared = respData.transactions.map((t, idx) => ({
                    ...t, id: idx, isShared: false, amount: Number(t.amount),
                    date: t.date || new Date().toISOString().split('T')[0],
                    items: t.items || [], market: t.market || '', bank: t.bank || ''
                }));
                setReviewData(prepared); setIsReviewOpen(true); setIsProcessingAI(false);
            } else {
                alert("N√£o encontrei transa√ß√µes."); setIsProcessingAI(false);
            }
        };

        const confirmImport = async () => {
            const batch = db.batch();
            reviewData.forEach(t => {
                const ref = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('transactions').doc();
                const { id, ...dataToSave } = t;

                // Prioriza o dado espec√≠fico do item, sen√£o usa o "Padr√£o" digitado no topo
                const finalMarket = t.market || importMarket;
                const finalBank = t.bank || importBank;

                batch.set(ref, {
                    ...dataToSave,
                    title: t.title || "Importado",
                    amount: Number(t.amount),
                    type: t.type || 'expense',
                    category: t.category || 'Outros',
                    market: finalMarket, // Salva o mercado corretamente
                    bank: finalBank,     // Salva o banco corretamente
                    payer: 'me',
                    ownerId: profile,
                    createdAt: new Date().toISOString(),
                    userId: user.uid,
                    isSettlement: false
                });
            });
            await batch.commit();
            setIsReviewOpen(false);
            setReviewData([]);
            setImportMarket(''); // Limpa o campo
            setImportBank('');   // Limpa o campo
            alert("Importa√ß√£o conclu√≠da!");
        };

        // --- MASSIVE DELETE ACTIONS ---
        const toggleSelection = (id) => {
            const newSet = new Set(selectedIds);
            if (newSet.has(id)) newSet.delete(id);
            else newSet.add(id);
            setSelectedIds(newSet);
        };

        const deleteSelected = async () => {
            if (!confirm(`Excluir ${selectedIds.size} itens selecionados permanentemente?`)) return;
            const batch = db.batch();
            selectedIds.forEach(id => {
                const ref = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('transactions').doc(id);
                batch.delete(ref);
            });
            await batch.commit();
            setSelectedIds(new Set());
            setSelectionMode(false);
        };

        const addReviewItem = (index) => {
            const name = prompt("Nome do item:");
            const val = Number(prompt("Valor:"));
            if (name && !isNaN(val)) {
                const n = [...reviewData];
                // Garante que o array items existe
                if (!n[index].items) n[index].items = [];
                n[index].items.push({ name, value: val });
                // Opcional: Somar ao total da transa√ß√£o se desejar, 
                // mas manteremos apenas o registro do item conforme v7
                setReviewData(n);
            }
        };

        // --- ACTIONS ---
        // NOVO: Fun√ß√£o para carregar edi√ß√£o
        const handleEdit = (tx) => {
            // FASE 2: Se for proje√ß√£o (Fantasma), id vira null (cria novo), mas mant√©m os dados para facilitar o lan√ßamento
            setEditingId(tx.isProjection ? null : tx.id);

            setFTitle(tx.title);
            setFAmount(tx.amount);
            setFType(tx.type);
            setFCat(tx.category);
            setFSubCat(tx.subCategory || '');

            // FASE 3: Recorr√™ncia e Sonho
            setFRecurrent(tx.isRecurrent || false);
            setFRecurrenceEndMode(tx.recurrenceEndMode || 'forever');
            setFRecurrenceEndDate(tx.recurrenceEndDate || '');
            setFRecurrenceCount(tx.recurrenceCount || 12);
            setFDreamId(tx.dreamId || '');

            setFShared(tx.isShared || false);
            setFormPayer(tx.payer || 'me');
            setFDate(tx.date);
            setFBank(tx.bank || '');
            setFMarket(tx.market || '');

            if (tx.type === 'investment') {
                setFQty(tx.quantity || '');
                setFUnitPrice(tx.unitPrice || '');
            }

            setModalOpen(true);
        };

        const saveTx = async (e) => {
            e.preventDefault();
            const batch = db.batch();
            const collectionRef = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('transactions');

            // FASE 2: GERA√á√ÉO DE DNA (GroupId)
            // Se for recorrente ou parcelado (mais de 1x), cria um ID de grupo √∫nico
            const newGroupId = (fRecurrent || (isInstallment && installments > 1))
                ? `grp_${new Date().getTime()}_${Math.random().toString(36).substr(2, 9)}`
                : null;

            // Payload base (Dados comuns)
            const payload = {
                title: fTitle, amount: Number(fAmount), type: fType, category: fCat,
                subCategory: fSubCat,
                date: fDate, isShared: fShared, payer: formPayer,
                ownerId: profile, userId: user.uid, isSettlement: false,
                market: fMarket, bank: fBank,
                quantity: fType === 'investment' ? Number(fQty) : 0,
                unitPrice: fType === 'investment' ? Number(fUnitPrice) : 0,

                // FASE 3: Novos Campos
                isRecurrent: fRecurrent,
                recurrenceEndMode: fRecurrent ? fRecurrenceEndMode : null,
                recurrenceEndDate: fRecurrent && fRecurrenceEndMode === 'date' ? fRecurrenceEndDate : null,
                recurrenceCount: fRecurrent && fRecurrenceEndMode === 'count' ? Number(fRecurrenceCount) : null,
                dreamId: fType === 'investment' ? fDreamId : '', // S√≥ salva v√≠nculo se for investimento
                groupId: newGroupId // <--- SALVA O DNA NO BANCO
            };

            if (editingId) {
                const docRef = collectionRef.doc(editingId);
                // Na edi√ß√£o simples, mantemos o payload sem gerar novo grupo para n√£o quebrar hist√≥rico existente
                // (Futuramente podemos tratar edi√ß√£o de s√©rie, mas por seguran√ßa mantemos simples agora)
                const { groupId, ...updatePayload } = payload;
                batch.update(docRef, updatePayload);
            } else {
                if (isInstallment && installments > 1) {
                    const valPerInst = Number(fAmount) / installments;
                    const [y, m, d] = fDate.split('-').map(Number);
                    for (let i = 0; i < installments; i++) {
                        const docRef = collectionRef.doc();
                        const dateObj = new Date(y, (m - 1) + i, d);
                        batch.set(docRef, {
                            ...payload,
                            title: `${fTitle} (${i + 1}/${installments})`,
                            amount: valPerInst,
                            date: dateObj.toISOString().split('T')[0],
                            createdAt: new Date().toISOString(),
                            items: []
                        });
                    }
                } else {
                    const docRef = collectionRef.doc();
                    batch.set(docRef, { ...payload, createdAt: new Date().toISOString(), items: [] });
                }
            }

            await batch.commit();
            setModalOpen(false);
            // Reset do Form
            setEditingId(null);
            setFTitle(''); setFQty(''); setFUnitPrice(''); setFAmount(''); setIsInstallment(false); setFDate(new Date().toISOString().split('T')[0]);
            setFSubCat(''); setFRecurrent(false); setFDreamId(''); // Reset Fase 3
            setFRecurrenceEndMode('forever'); setFRecurrenceEndDate(''); setFRecurrenceCount(12); // Reset v53
        };

        // FASE 3: Salvar Sonho (Atualizado com Escopo)
        const saveDream = async () => {
            if (!dTitle || !dTarget) return alert("Preencha t√≠tulo e valor");
            await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('dreams').add({
                title: dTitle,
                targetAmount: Number(dTarget),
                emoji: dEmoji,
                scope: dScope, // Salva se √© 'personal' ou 'joint'
                ownerId: profile,
                createdAt: new Date().toISOString()
            });
            setDreamModal(false); setDTitle(''); setDTarget('');
        };

        const deleteDream = async (id) => {
            if (confirm("Apagar este sonho?")) await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('dreams').doc(id).delete();
        }

        // --- FASE 4: EXCLUS√ÉO INTELIGENTE (CASCATA + TARA) ---
        // --- NOVA FUN√á√ÉO: Rejeitar/Excluir Pagamento n√£o recebido ---
        const rejectSettlement = async (id) => {
            if (confirm("O dinheiro n√£o caiu? Ao rejeitar, este lan√ßamento ser√° apagado.")) {
                await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('transactions').doc(id).delete();
            }
        };

        const confirmSettlement = async (tx) => {
            await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('transactions').doc(tx.id).update({
                status: 'confirmed'
            });
        };

        // CORRE√á√ÉO INTELIGENTE (Pagar vs Receber)
        const settleDebt = async (amountOverride = null) => {
            const currentBal = amountOverride !== null ? amountOverride : data.coupleBal;
            const val = Math.abs(currentBal);

            if (val === 0) return;

            // 1. Define quem √© voc√™ na transa√ß√£o
            const isPayer = currentBal < 0; // Saldo Negativo = Eu Devo (Payer)

            // 2. Define Tipo e T√≠tulo
            const type = isPayer ? 'expense' : 'income';
            const title = isPayer ? 'Pagamento de Acerto' : 'Recebimento de Acerto';

            // 3. Define o Status Inicial
            // Se eu PAGUEI -> Nasce 'pending' (Parceiro precisa confirmar ou rejeitar)
            // Se eu RECEBI -> Nasce 'confirmed' (Eu mesmo estou validando)
            const initialStatus = isPayer ? 'pending' : 'confirmed';

            await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('transactions').add({
                title: title,
                amount: val,
                type: type,
                category: 'Ajuste/Reembolso',
                date: new Date().toISOString().split('T')[0],
                isShared: false,
                isSettlement: true,
                status: initialStatus, // Status din√¢mico
                payer: 'me',
                ownerId: profile,
                userId: user.uid,
                createdAt: new Date().toISOString()
            });

            // Feedback visual
            if (isPayer) alert("Pagamento registrado! Aguardando o parceiro confirmar.");
            else alert("Recebimento confirmado! Saldo ajustado.");
        };

        const openBudget = () => {
            // FASE 3 FIX (Melhorias 1 e 2): Lista expandida com Subcategorias e Investimentos
            let list = [];

            // --- ALTERA√á√ÉO 2: Carrega categorias baseadas no MODO ATUAL (Com Dividendos no Invest) ---
            if (dashboardMode === 'statement') {
                // MODO DIA A DIA: Carrega Despesas e Receitas (EXCETO Dividendos)
                [...CATEGORIES.expense, ...CATEGORIES.income].forEach(cat => {
                    if (cat.name === 'Dividendos') return; // Pula dividendos aqui

                    list.push({ id: cat.name, name: cat.name, type: 'main', icon: cat.icon });
                    if (cat.subcategories) {
                        cat.subcategories.forEach(sub => {
                            list.push({ id: sub, name: `${cat.name} > ${sub}`, type: 'sub', parent: cat.name, icon: '‚Ü≥' });
                        });
                    }
                });
            } else {
                // MODO INVESTIMENTOS:
                // 1. Meta de Rentabilidade (Inflow)
                list.push({ id: 'Dividendos', name: 'Dividendos (Meta de Renda)', type: 'invest-in', icon: 'üíµ' });

                // 2. Metas de Aporte (Outflow)
                CATEGORIES.investment.forEach(cat => {
                    list.push({ id: cat.name, name: cat.name, type: 'invest-out', icon: cat.icon });
                });
            }
            // --------------------------------------------------------------

            const current = budgets[viewMode] || [];

            setEditBudgets(list.map(c => ({
                category: c.id,
                displayName: c.name,
                limit: current.find(b => b.category === c.id)?.limit || 0,
                icon: c.icon,
                // CR√çTICO: Estas propriedades estavam sendo perdidas na vers√£o anterior
                parent: c.parent,
                type: c.type
            })));

            setBudgetSearch('');
            setBudgetModal(true);
        };

        // --- CORRE√á√ÉO 1: Fun√ß√£o saveBudget Blindada ---
        const saveBudget = async () => {
            try {
                const current = budgets[viewMode] || [];

                // --- ALTERA√á√ÉO 3: Merge Inteligente (Considerando Dividendos como Investimento) ---
                const otherBudgets = current.filter(b => {
                    // Verifica se o item pertence ao contexto de Investimentos
                    const isInvestContext = CATEGORIES.investment.some(cat => cat.name === b.category) || b.category === 'Dividendos';

                    // Se estou no modo DIA A DIA, preservo tudo que √© Investimento (incluindo Dividendos)
                    if (dashboardMode === 'statement') return isInvestContext;
                    // Se estou no modo INVESTIMENTO, preservo tudo que N√ÉO √© Investimento
                    return !isInvestContext;
                });

                // Remove tamb√©m duplicatas visuais que estamos editando agora (seguran√ßa extra)
                const finalPreserved = otherBudgets.filter(b => !editBudgets.some(e => e.category === b.category));
                // ------------------------------------------------------------------

                // 2. Prepara os novos itens para salvar (SANITIZA√á√ÉO E SOMA DE PAIS)
                const newItems = editBudgets
                    .map(b => {
                        let finalLimit = Number(b.limit);

                        // Se for Pai, recalcula a soma dos filhos para salvar o valor total correto
                        if (b.type === 'main') {
                            const childrenSum = editBudgets
                                .filter(child => child.parent === b.category)
                                .reduce((sum, child) => sum + (Number(child.limit) || 0), 0);

                            // Se tiver filhos somando algo, o limite do pai assume essa soma
                            if (childrenSum > 0) finalLimit = childrenSum;
                        }

                        return {
                            category: b.category,
                            limit: finalLimit
                        };
                    })
                    .filter(b => b.limit > 0 && !isNaN(b.limit)); // S√≥ salva metas maiores que zero

                const updatedBudgets = [...otherBudgets, ...newItems];

                const newB = { ...budgets, [viewMode]: updatedBudgets };

                await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('settings').doc('budgets').set(newB);

                setBudgets(newB);
                setBudgetModal(false);
            } catch (error) {
                console.error("Erro ao salvar or√ßamento:", error);
                alert("Erro ao salvar: " + error.message);
            }
        };

        // --- FUN√á√ÉO DE HARD RESET (LIMPEZA TOTAL) ---
        const resetDatabase = async () => {
            if (!confirm("‚ö†Ô∏è PERIGO: HARD RESET\n\nIsso apagar√° TODAS as transa√ß√µes, sonhos e configura√ß√µes de or√ßamento.\nO app voltar√° ao estado original.\n\nDeseja continuar?")) return;

            // Segunda confirma√ß√£o de seguran√ßa
            if (!confirm("Tem certeza absoluta? Essa a√ß√£o √© irrevers√≠vel.")) return;

            setIsProcessingAI(true); // Usa o spinner de loading

            try {
                const batch = db.batch();
                const basePath = db.collection('artifacts').doc(APP_ID).collection('public').doc('data');

                // 1. Coletar e Deletar Transa√ß√µes
                const txSnapshot = await basePath.collection('transactions').get();
                txSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });

                // 2. Coletar e Deletar Sonhos
                const dreamsSnapshot = await basePath.collection('dreams').get();
                dreamsSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });

                // 3. Resetar Or√ßamentos para o Padr√£o (Overwrite com DEFAULT_BUDGETS)
                // Isso garante que a estrutura volte limpa, sem duplicatas
                const budgetRef = basePath.collection('settings').doc('budgets');
                batch.set(budgetRef, DEFAULT_BUDGETS);

                // 4. Apagar Cota√ß√µes Manuais e outras configs
                batch.delete(basePath.collection('settings').doc('assetPrices'));

                // Executar tudo
                await batch.commit();

                alert("‚úÖ Sistema reiniciado com sucesso! A p√°gina ser√° recarregada.");
                window.location.reload();

            } catch (error) {
                console.error("Erro no reset:", error);
                alert("Erro ao resetar: " + error.message);
                setIsProcessingAI(false);
            }
        };

        // --- NOVO: L√ìGICA DE TAREFAS DOM√âSTICAS (CORRIGIDA v32) ---
        const addChore = async (choreData) => { await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('chores').add(choreData); };

        const toggleChore = async (id) => {
            const chore = chores.find(c => c.id === id);
            if (chore) {
                // CORRE√á√ÉO: Aumentamos a r√©gua para 20 caracteres. 
                // IDs manuais (ex: 'dishes') s√£o menores que 20, ent√£o entram no 'if' para serem CRIADOS.
                // IDs do Firebase s√£o 20 chars, ent√£o v√£o para o 'else' para serem ATUALIZADOS.
                if (!chore.id || chore.id.length < 20) {
                    const { id: _, ...rest } = chore;
                    // Cria a tarefa no banco pela primeira vez ao clicar
                    await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('chores').add({ ...rest, done: !chore.done });
                } else {
                    await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('chores').doc(id).update({ done: !chore.done });
                }
            }
        };

        const deleteChore = async (id) => {
            if (confirm("Remover tarefa?")) {
                // Se for item de exemplo (ID curto), filtramos localmente (gambiarra visual) ou apenas ignoramos pois n√£o est√° no banco
                // O ideal √© recarregar a p√°gina ou ele sumir√° sozinho se n√£o salvou.
                // Mas se j√° salvou (ID longo), deleta do banco.
                if (id.length >= 20) {
                    await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('chores').doc(id).delete();
                } else {
                    // Se tentar deletar um exemplo n√£o salvo, removemos da lista visualmente for√ßando um reload ou filtrando o estado
                    setChores(chores.filter(c => c.id !== id));
                }
            }
        };

        const rotateChores = async () => {
            if (!confirm("Encerrar a semana?\n\n1. Tarefas rotativas trocar√£o de dono.\n2. O ciclo quinzenal ir√° avan√ßar.\n3. Todas as tarefas ser√£o desmarcadas.")) return;
            const batch = db.batch();
            const nextCycle = weekCycle + 1;

            // Atualiza ciclo
            batch.set(db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('settings').doc('chores'), { weekCycle: nextCycle }, { merge: true });

            // Gira tarefas
            chores.forEach(c => {
                // S√≥ processa quem j√° √© "real" no banco (ID longo)
                if (c.id && c.id.length >= 20) {
                    const ref = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('chores').doc(c.id);
                    let update = { done: false };
                    if (c.isRotating) update.assignee = c.assignee === 'bruno' ? 'maiara' : 'bruno';
                    batch.update(ref, update);
                }
            });
            await batch.commit();
            alert(`Ciclo avan√ßado! Estamos na Semana #${nextCycle}.`);
        };

        const resetDailyChores = async () => {
            if (!confirm("Resetar apenas as tarefas DI√ÅRIAS?")) return;
            const batch = db.batch();
            chores.filter(c => c.frequency === 'daily').forEach(c => {
                // S√≥ reseta quem j√° est√° no banco
                if (c.id && c.id.length >= 20) {
                    batch.update(db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('chores').doc(c.id), { done: false });
                }
            });
            await batch.commit();
        };

        // UI HELPERS
        const userConfig = profile ? USER_CONFIG[profile] : null;
        if (!profile || !userConfig) return <LoginScreen onLoginSuccess={(p) => { setProfile(p); localStorage.setItem('fincontrol_profile', p); }} />;
        if (!data) return <div className="h-full flex items-center justify-center bg-slate-900 text-white">Carregando...</div>;
        const greeting = getGreeting();

        // PREPARA√á√ÉO DADOS PARA UI
        const analysisData = dashboardMode === 'statement' ? data.analysis.daily : data.analysis.invest;

        // Taxa de Poupan√ßa (Para an√°lise de dia a dia)
        const savingsRate = data.inc > 0 ? ((data.inc - data.exp) / data.inc) * 100 : 0;
        const daysInMonth = new Date(selectedMonth.split('-')[0], selectedMonth.split('-')[1], 0).getDate();
        const dailyAvg = data.exp / new Date().getDate(); // M√©dia at√© hoje

        return (
            <div className="h-full flex flex-col font-sans text-slate-900 animate-fade-in relative">
                {/* MODALS - MANTIDOS */}
                {isProcessingAI && <div className="absolute inset-0 z-50 bg-slate-900/90 flex items-center justify-center text-white"><Sparkles className="animate-spin mb-2" /> Analisando...</div>}

                {/* MODAL REVIS√ÉO - MANTIDO (Conte√∫do oculto para brevidade, mas ele existe no seu c√≥digo) */}
                {isReviewOpen && (
                    <div className="fixed inset-0 z-[70] bg-slate-900/95 backdrop-blur-sm flex flex-col animate-fade-in">
                        <div className="bg-white rounded-t-3xl mt-10 flex-1 flex flex-col overflow-hidden">
                            <div className="p-6 border-b flex justify-between items-center">
                                <h3 className="font-bold text-xl flex gap-2"><CheckSquare className="text-indigo-600" /> Revisar Importa√ß√£o</h3>
                                <button onClick={() => { setIsReviewOpen(false); setReviewData([]); }} className="bg-gray-100 p-2 rounded-full"><X size={20} /></button>
                            </div>
                            {/* ... (MANTENHA O RESTO DO MODAL IGUAL AO ORIGINAL AQUI) ... */}
                            {/* Para facilitar: N√£o delete o c√≥digo do modal isReviewOpen, apenas pule ele na substitui√ß√£o se preferir, ou copie ele todo de volta */}
                            {/* Vou assumir que voc√™ manteve o modal isReviewOpen inalterado acima desta troca */}
                        </div>
                    </div>
                )}

                {/* NOTIFICA√á√ÉO DE ACERTO - MANTIDA */}
                {data && data.pendingSettlements && data.pendingSettlements.length > 0 && (
                    <div className="bg-amber-100 border-b border-amber-200 px-6 py-4 flex flex-col gap-3 animate-slide-up sticky top-0 z-50">
                        <div className="flex items-center gap-2 text-amber-800 font-bold">
                            <span className="bg-amber-200 p-1.5 rounded-full"><ArrowRightLeft size={16} /></span>
                            <span>Confirma√ß√£o Pendente</span>
                        </div>
                        {data.pendingSettlements.map(tx => (
                            <div key={tx.id} className="glass-card p-3 rounded-xl flex justify-between items-center shadow-sm">
                                <div>
                                    <p className="text-xs text-amber-500 mb-0.5">{USER_CONFIG[tx.ownerId]?.name || 'Parceiro'} informou pagamento:</p>
                                    <p className="font-bold text-lg text-emerald-400">{formatCurrency(tx.amount)}</p>
                                </div>
                                <div className="flex gap-2">
                                    {/* Bot√£o Rejeitar (Vermelho Claro) */}
                                    <button onClick={() => rejectSettlement(tx.id)} className="glass-card text-rose-400 border border-rose-500/30 px-3 py-2 rounded-lg font-bold text-xs shadow-sm active:scale-95 transition-transform hover:bg-rose-500/10 flex items-center gap-1">
                                        <X size={14} /> N√£o
                                    </button>
                                    {/* Bot√£o Confirmar (Verde) */}
                                    <button onClick={() => confirmSettlement(tx)} className="bg-emerald-600 text-white px-4 py-2 rounded-lg font-bold text-xs shadow-sm active:scale-95 transition-transform flex items-center gap-2 hover:bg-emerald-500">
                                        <Check size={14} /> Sim, recebi
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                )}

                {/* --- HEADER S√ìLIDO (TOPO) --- */}
                <div className="pt-4 pb-4 px-5 shrink-0 z-40 relative text-white bg-slate-900 shadow-xl shadow-black/20 border-b border-white/5">
                    <div className="flex justify-between items-center relative z-10 gap-4">

                        {/* ESQUERDA: Perfil Limpo (Sem √≠cones de tempo) */}
                        <div className="flex items-center gap-3 flex-1 min-w-0">
                            <div className={`w-10 h-10 rounded-full flex items-center justify-center text-lg ring-2 ring-white/10 shadow-lg shrink-0 ${USER_CONFIG[profile].color}`}>
                                {USER_CONFIG[profile].avatar}
                            </div>
                            <div>
                                <p className="text-slate-400 text-xs font-medium">{greeting.t}</p>
                                <h1 className="font-bold text-lg md:text-xl leading-none truncate">{USER_CONFIG[profile].name}</h1>
                            </div>
                        </div>

                        {/* DIREITA: Data + Config (Bot√£o de Sele√ß√£o REMOVIDO) */}
                        <div className="flex gap-2 items-center shrink-0">
                            {/* DATA */}
                            <div className="relative flex items-center gap-2 bg-white/5 hover:bg-white/10 border border-white/10 rounded-lg px-3 py-2 transition-colors cursor-pointer">
                                <input type="month" value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} className="absolute inset-0 opacity-0 cursor-pointer z-50 w-full h-full" />
                                <Calendar size={16} className="text-emerald-400 shrink-0" />
                                <span className="text-xs font-bold text-slate-200 tracking-wide">
                                    {selectedMonth.split('-')[1]}/{selectedMonth.split('-')[0]}
                                </span>
                            </div>

                            {/* CONFIG */}
                            <button onClick={() => setSettingsModal(true)} className="w-10 h-10 flex items-center justify-center rounded-lg bg-white/5 border border-white/10 hover:bg-white/10 transition-colors text-slate-300">
                                <Settings size={20} />
                            </button>
                            {/* SAIR */}
                            <button onClick={() => { localStorage.removeItem('fincontrol_profile'); setProfile(null); }} className="w-10 h-10 flex items-center justify-center rounded-lg bg-white/5 border border-white/10 hover:bg-white/10 transition-colors text-rose-400 hover:text-rose-300">
                                <LogOut size={20} />
                            </button>
                        </div>
                    </div>
                </div>

                {/* --- MENU CONTEXTUAL FLUTUANTE (FUNDO DO APP) --- */}
                <div className="px-2 pt-4 pb-4 shrink-0 z-30 relative flex gap-4 w-full border-b border-white/20">

                    {/* 1. ESCOPO (TEXTO PURO + SETA) */}
                    <div className="relative flex-1 min-w-0">
                        <button
                            onClick={() => setActiveDropdown(activeDropdown === 'scope' ? null : 'scope')}
                            className="flex items-center gap-2 text-white group w-full"
                        >
                            <div className={`p-1.5 rounded-full shrink-0 ${viewMode === 'personal' ? 'bg-indigo-500/20 text-indigo-400' : 'bg-pink-500/20 text-pink-400'}`}>
                                {viewMode === 'personal' ? <User size={14} strokeWidth={3} /> : <Users size={14} strokeWidth={3} />}
                            </div>
                            {/* AJUSTE: text-base (mobile) md:text-xl (desktop) e 'truncate' para evitar quebra de layout */}
                            <span className="font-bold text-base md:text-xl tracking-tight text-white drop-shadow-md truncate">
                                {viewMode === 'personal' ? 'Meu Norte' : 'Nosso Norte'}
                            </span>
                            <ChevronDown size={14} className={`text-slate-400 shrink-0 transition-transform ${activeDropdown === 'scope' ? 'rotate-180' : ''}`} />
                        </button>
                        {/* Dropdown 1 */}
                        {activeDropdown === 'scope' && (
                            <div className="absolute top-full left-0 w-48 md:w-56 mt-2 bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl overflow-hidden animate-slide-up z-[100]">
                                <button onClick={() => { setViewMode('personal'); setActiveDropdown(null); }} className="w-full text-left px-4 py-4 hover:bg-white/5 flex items-center gap-3 border-b border-white/5">
                                    <User size={16} className="text-indigo-400" /> <span className="font-bold text-sm text-slate-200">Meu Norte</span>
                                </button>
                                <button onClick={() => { setViewMode('joint'); setActiveDropdown(null); }} className="w-full text-left px-4 py-4 hover:bg-white/5 flex items-center gap-3">
                                    <Users size={16} className="text-pink-400" /> <span className="font-bold text-sm text-slate-200">Nosso Norte</span>
                                </button>
                            </div>
                        )}
                    </div>

                    {/* 2. CONTEXTO (TEXTO PURO + SETA) */}
                    <div className="relative flex-1 min-w-0">
                        <button
                            onClick={() => setActiveDropdown(activeDropdown === 'context' ? null : 'context')}
                            className="flex items-center gap-2 text-white group w-full"
                        >
                            <div className={`p-1.5 rounded-full shrink-0 ${dashboardMode === 'statement' ? 'bg-indigo-500/20 text-indigo-400' : 'bg-emerald-500/20 text-emerald-400'}`}>
                                {dashboardMode === 'statement' ? <Banknote size={14} strokeWidth={3} /> : <TrendingUp size={14} strokeWidth={3} />}
                            </div>
                            {/* AJUSTE: Mesma corre√ß√£o de tipografia responsiva */}
                            <span className="font-bold text-base md:text-xl tracking-tight text-white drop-shadow-md truncate">
                                {dashboardMode === 'statement' ? 'Dia a dia' : 'Carteira'}
                            </span>
                            <ChevronDown size={14} className={`text-slate-400 shrink-0 transition-transform ${activeDropdown === 'context' ? 'rotate-180' : ''}`} />
                        </button>
                        {/* Dropdown 2 */}
                        {activeDropdown === 'context' && (
                            <div className="absolute top-full left-0 w-56 mt-2 bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl overflow-hidden animate-slide-up z-[100]">
                                <button onClick={() => { setDashboardMode('statement'); setActiveDropdown(null); }} className="w-full text-left px-4 py-4 hover:bg-white/5 flex items-center gap-3 border-b border-white/5">
                                    <Banknote size={16} className="text-indigo-400" /> <span className="font-bold text-sm text-slate-200">Dia a dia</span>
                                </button>
                                <button onClick={() => { setDashboardMode('investment'); setActiveDropdown(null); }} className="w-full text-left px-4 py-4 hover:bg-white/5 flex items-center gap-3">
                                    <TrendingUp size={16} className="text-emerald-400" /> <span className="font-bold text-sm text-slate-200">Investimentos</span>
                                </button>
                            </div>
                        )}
                    </div>
                </div>

                {/* Content (√Årea de Rolagem - ONDE O CARD VIVE AGORA) */}
                {/* Usamos px-5 aqui para alinhar tudo com o cabe√ßalho */}
                <div className="flex-1 overflow-y-auto px-2 pb-32 scrollbar-hide relative bg-subtle-filter">


                    {/* --- CARD PRINCIPAL (Agora dentro da rolagem) --- */}
                    {tab === 'home' && (
                        <div className="pt-6 mb-6 relative z-20 shrink-0 animate-fade-in">
                            {/* --- NOVO LAYOUT HERO (Imagem 5) --- */}
                            <div className="px-1 relative z-10">

                                {/* 1. LABEL SUPERIOR + CONTROLES */}
                                <div className="flex justify-between items-center mb-1">
                                    <p className="text-sm text-slate-400 font-normal uppercase tracking-wide">Saldo Dispon√≠vel</p>

                                    <div className="flex items-center gap-3">
                                        {/* Seletor Real/Previsto (Estilo Texto) */}
                                        <button
                                            onClick={() => setIsForecast(!isForecast)}
                                            className="text-sm text-slate-400 font-normal flex items-center hover:text-white transition-colors"
                                        >
                                            {isForecast ? 'Prev' : 'Real'} <ChevronDown size={14} className="ml-0.5 opacity-70" />
                                        </button>

                                        {/* Olho (Toggle Visibilidade) */}
                                        <button onClick={() => setHideValues(!hideValues)} className="text-slate-400 hover:text-white transition-colors">
                                            {hideValues ? <EyeOff size={16} /> : <Eye size={16} />}
                                        </button>
                                    </div>
                                </div>

                                {/* 2. SALDO GIGANTE + VARIA√á√ÉO */}
                                <div className="flex items-baseline gap-3 mb-2">
                                    <h2 className="text-4xl font-bold text-white tracking-tighter drop-shadow-lg">
                                        {hideValues ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : (
                                            dashboardMode === 'investment'
                                                ? formatCurrency(data.investData.totalCurrent)
                                                : formatCurrency(data.previousBalance + data.bal)
                                        )}
                                    </h2>

                                    {/* Varia√ß√£o % (Seta + Valor) */}
                                    {!hideValues && (
                                        <div className={`flex items-center text-lg font-medium ${(dashboardMode === 'statement' ? data.bal >= 0 : data.investData.yieldPct >= 0) ? 'text-emerald-500' : 'text-rose-400'}`}>
                                            {(dashboardMode === 'statement' ? data.bal >= 0 : data.investData.yieldPct >= 0) ? <TrendingUp size={20} className="mr-1" /> : <TrendingDown size={20} className="mr-1" />}
                                            {dashboardMode === 'statement'
                                                ? (data.previousBalance !== 0 ? Math.abs((data.bal / data.previousBalance) * 100).toFixed(1) : '0.0')
                                                : Math.abs(data.investData.yieldPct).toFixed(1)
                                            }%
                                        </div>
                                    )}
                                </div>

                                {/* 3. SUB-INFORMA√á√ïES (Espa√ßamento Reduzido ao M√°ximo) */}
                                <div className="space-y-0.5 mb-0">
                                    <p className="text-sm text-slate-300 font-medium">
                                        M√™s Anterior: <span className="text-slate-400 font-normal">
                                            {hideValues ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : formatCurrency(
                                                dashboardMode === 'investment'
                                                    ? data.investData.previousTotal
                                                    : data.previousBalance
                                            )}
                                        </span>
                                    </p>
                                    <p className="text-sm text-slate-300 font-medium">
                                        M√™s Atual: <span className={`font-normal ${(dashboardMode === 'investment'
                                            ? (data.investData.totalCurrent - data.investData.previousTotal)
                                            : data.bal) >= 0
                                            ? 'text-emerald-400' : 'text-rose-400'
                                            }`}>
                                            {hideValues ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : formatCurrency(
                                                dashboardMode === 'investment'
                                                    ? (data.investData.totalCurrent - data.investData.previousTotal)
                                                    : data.bal
                                            )}
                                        </span>
                                    </p>
                                </div>

                                {/* 4. GRID DE RESUMO (Subindo mais para o topo) */}
                                <div className="grid grid-cols-3 border-t border-white/10 pt-1 mt-2 mb-4">
                                    {/* Receita */}
                                    <div className="text-center border-r border-white/5">
                                        <p className="text-xs font-bold text-emerald-500 uppercase tracking-widest mb-1">Receita</p>
                                        <p className="text-lg font-bold text-emerald-400 tracking-tight">
                                            {hideValues ? '‚Ä¢‚Ä¢‚Ä¢' : formatCurrency(data.inc)}
                                        </p>
                                    </div>

                                    {/* Despesa + Extrato */}
                                    <div className="text-center border-r border-white/5">
                                        <p className="text-xs font-bold text-rose-500 uppercase tracking-widest mb-1">Despesa</p>
                                        <p className="text-lg font-bold text-rose-400 tracking-tight">
                                            {hideValues ? '‚Ä¢‚Ä¢‚Ä¢' : formatCurrency(data.exp)}
                                        </p>
                                        {/* BOT√ÉO EXTRATO DE VOLTA */}
                                        {/* BOT√ÉO EXTRATO DE VOLTA */}
                                        <button onClick={() => setExtratoMode(extratoMode === 'list' ? 'chart' : 'list')} className="flex justify-center items-center gap-1 text-xs text-blue-400 mt-1 opacity-80 hover:opacity-100 transition-opacity active:scale-95 w-full">
                                            {extratoMode === 'list' ? 'Ver Gr√°ficos' : 'Ver Extrato'} <ArrowRightLeft size={8} />
                                        </button>
                                    </div>

                                    {/* Aporte */}
                                    <div className="text-center">
                                        <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Aporte</p>
                                        <p className="text-lg font-bold text-white tracking-tight">
                                            {hideValues ? '‚Ä¢‚Ä¢‚Ä¢' : formatCurrency(data.inv)}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* BARRA FLUTUANTE DE EXCLUS√ÉO (Agora com bot√£o Fechar) */}
                    {selectionMode && (
                        <div className="fixed bottom-24 left-1/2 -translate-x-1/2 z-50 bg-rose-600 text-white pl-6 pr-2 py-2 rounded-full shadow-2xl flex items-center gap-4 animate-pop">
                            <span className="font-bold text-sm whitespace-nowrap">{selectedIds.size} selecionados</span>

                            <div className="flex items-center gap-2">
                                <button onClick={deleteSelected} className="flex items-center gap-2 font-bold text-xs bg-rose-800 px-3 py-2 rounded-xl active:scale-95 transition-transform">
                                    <Trash2 size={14} /> Excluir
                                </button>

                                {/* Bot√£o Cancelar/Sair do Modo Sele√ß√£o */}
                                <button
                                    onClick={() => { setSelectionMode(false); setSelectedIds(new Set()); }}
                                    className="w-8 h-8 flex items-center justify-center bg-rose-700 rounded-full hover:bg-rose-800 transition-colors"
                                >
                                    <X size={16} />
                                </button>
                            </div>
                        </div>
                    )}

                    {/* --- IMPLEMENTA√á√ÉO ITENS 7 e 8 (CARDS NOSSO NORTE) --- */}
                    {tab === 'home' && dashboardMode === 'statement' && viewMode === 'joint' && (
                        <div className="space-y-4 mb-6 animate-slide-up">

                            {/* ITEM 8: CARD DE ACERTO (Quem deve quem) */}
                            <div className={`p-5 rounded-3xl shadow-sm border relative overflow-hidden ${Math.abs(data.coupleBal) < 1 ? 'bg-emerald-900/20 border-emerald-500/20' : 'bg-slate-900/60 border-indigo-500/20'}`}>
                                <div className="flex justify-between items-center relative z-10">
                                    <div>
                                        <p className="text-xs font-bold uppercase text-slate-400 mb-1 flex items-center gap-1">
                                            <ArrowRightLeft size={10} /> Situa√ß√£o do Acerto
                                        </p>
                                        {/* CEN√ÅRIO 1: TUDO QUITADO */}
                                        {Math.abs(data.coupleBal) < 1 ? (
                                            <div className="relative">
                                                <div className="flex justify-between items-start">
                                                    <p className="font-bold text-emerald-400 text-sm mb-1">Tudo quitado! üéâ</p>

                                                    {/* SELO DE PAGAMENTO (S√≥ aparece se houve acerto no m√™s) */}
                                                    {data.list.some(t => t.isSettlement) && (
                                                        <div className="border-[3px] border-emerald-500/40 text-emerald-500 text-[10px] font-black uppercase px-3 py-1 rounded-lg -rotate-12 tracking-widest opacity-80 animate-pop select-none shadow-[0_0_15px_rgba(16,185,129,0.15)] bg-emerald-500/5 backdrop-blur-sm transform origin-center">
                                                            M√™s Quitado
                                                        </div>
                                                    )}
                                                </div>

                                                {/* HIST√ìRICO DO M√äS (Novo Recurso) */}
                                                {data.list.filter(t => t.isSettlement).length > 0 && (
                                                    <div className="text-xs text-slate-400 bg-slate-800/50 p-2 rounded-lg border border-white/5 mt-2 min-w-[200px]">
                                                        <p className="font-bold text-emerald-500 uppercase mb-1 border-b border-white/5 pb-0.5">Hist√≥rico do M√™s:</p>
                                                        {data.list.filter(t => t.isSettlement).map(t => (
                                                            <div key={t.id} className="flex justify-between gap-4 py-0.5">
                                                                <span>{t.date.split('-')[2]}/{t.date.split('-')[1]} ‚Ä¢ {t.title.replace(' de Acerto', '')}</span>
                                                                <span className={`font-bold ${t.type === 'income' ? 'text-emerald-400' : 'text-rose-400'}`}>
                                                                    {formatCurrency(t.amount)}
                                                                </span>
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                        ) : (
                                            /* CEN√ÅRIO 2: D√çVIDA PENDENTE */
                                            <div>
                                                <p className="text-lg font-extrabold text-white">
                                                    {data.coupleBal > 0 ? 'Voc√™ tem a receber' : 'Voc√™ deve pagar'}
                                                </p>
                                                <p className={`text-2xl font-black ${data.coupleBal > 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                                                    {hideValues ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : formatCurrency(Math.abs(data.coupleBal))}
                                                </p>
                                            </div>
                                        )}
                                    </div>

                                    {/* BOT√ÉO DE A√á√ÉO DIN√ÇMICO (S√≥ aparece se tiver saldo) */}
                                    {Math.abs(data.coupleBal) >= 1 && (
                                        <button
                                            onClick={() => settleDebt(data.coupleBal)}
                                            className={`px-4 py-3 rounded-xl font-bold text-xs shadow-lg active:scale-95 transition-all flex flex-col items-center gap-1 border border-white/10
                                        ${data.coupleBal > 0
                                                    ? 'bg-emerald-600 text-white shadow-emerald-500/30' // Emerald para Receber
                                                    : 'bg-indigo-600 text-white shadow-indigo-500/30'}`} // Indigo para Pagar
                                        >
                                            {data.coupleBal > 0 ? <CheckCircle size={18} /> : <Banknote size={18} />}
                                            {/* Textos expl√≠citos de A√á√ÉO */}
                                            {data.coupleBal > 0 ? 'Confirmar Recebimento' : 'Realizar Pagamento'}
                                        </button>
                                    )}
                                </div>
                            </div>

                            {/* ITEM 7: CARD COMPARATIVO (Gastos Ele vs Ela) */}
                            <div className="grid grid-cols-2 gap-3">
                                {/* CARD BRUNO */}
                                <div className={`p-4 rounded-2xl border flex flex-col items-center justify-center gap-2 ${USER_CONFIG['bruno'].color.replace('bg-', 'bg-opacity-10 bg-').replace('text-white', '')} border-gray-100`}>
                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm text-white ${USER_CONFIG['bruno'].color}`}>
                                        {USER_CONFIG['bruno'].avatar}
                                    </div>
                                    <div className="text-center">
                                        <p className="text-xs font-bold uppercase text-gray-400">Bruno gastou</p>
                                        <p className="font-bold text-slate-800">{hideValues ? '‚Ä¢‚Ä¢‚Ä¢' : formatCurrency(data.sharedSpends?.bruno || 0)}</p>
                                    </div>
                                </div>

                                {/* CARD MAIARA */}
                                <div className={`p-4 rounded-2xl border flex flex-col items-center justify-center gap-2 ${USER_CONFIG['maiara'].color.replace('bg-', 'bg-opacity-10 bg-').replace('text-white', '')} border-gray-100`}>
                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm text-white ${USER_CONFIG['maiara'].color}`}>
                                        {USER_CONFIG['maiara'].avatar}
                                    </div>
                                    <div className="text-center">
                                        <p className="text-xs font-bold uppercase text-gray-400">Maiara gastou</p>
                                        <p className="font-bold text-slate-800">{hideValues ? '‚Ä¢‚Ä¢‚Ä¢' : formatCurrency(data.sharedSpends?.maiara || 0)}</p>
                                    </div>
                                </div>
                            </div>

                        </div>
                    )}
                    {/* --- FIM ITENS 7 e 8 --- */}

                    {/* AJUSTE: Linha divis√≥ria entre o Resumo (Extrato) e a Lista de Transa√ß√µes */}
                    {tab === 'home' && dashboardMode === 'statement' && (
                        <div className="h-px w-full bg-white/20 mb-4 mx-auto max-w-[95%]"></div>
                    )}

                    {tab === 'home' && dashboardMode === 'statement' && (
                        <>
                            {extratoMode === 'list' ? (
                                // AJUSTE: Removemos 'space-y-4' e adicionamos o estilo de Container √önico (borda √∫nica, fundo √∫nico)
                                <div className="animate-fade-in -mt-4 bg-slate-900/40 rounded-3xl overflow-hidden shadow-sm">
                                    {data.list.map(t => {
                                        // L√≥gica de Long Press (Segurar)
                                        let pressTimer;
                                        const handleIconPressStart = () => {
                                            pressTimer = setTimeout(() => {
                                                if (!selectionMode) {
                                                    setSelectionMode(true);
                                                    toggleSelection(t.id);
                                                }
                                            }, 800);
                                        };
                                        const handleIconPressEnd = () => clearTimeout(pressTimer);

                                        return (
                                            <div key={t.id}
                                                // AJUSTE: Aumentamos contraste da borda e removemos hover de bot√£o
                                                className={`relative flex items-center justify-between p-4 transition-all
                                                    ${selectionMode && selectedIds.has(t.id)
                                                        ? 'bg-indigo-900/50'
                                                        : 'border-b border-slate-700/50 last:border-0'
                                                    } ${t.isProjection ? 'opacity-50 italic' : ''}`}
                                            >

                                                {/* 1. √çCONE INTERATIVO */}
                                                <div
                                                    className="relative shrink-0 mr-4 cursor-pointer group"
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        if (selectionMode) toggleSelection(t.id);
                                                        else handleEdit(t);
                                                    }}
                                                    onMouseDown={handleIconPressStart}
                                                    onMouseUp={handleIconPressEnd}
                                                    onTouchStart={handleIconPressStart}
                                                    onTouchEnd={handleIconPressEnd}
                                                >
                                                    {/* C√≠rculo do √çcone (Levemente menor e mais integrado) */}
                                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center transition-transform active:scale-90
                                                            ${selectionMode && selectedIds.has(t.id) ? 'bg-indigo-500 text-white' : 'bg-slate-800/80 text-slate-300 group-hover:bg-slate-700'}`}>

                                                        {selectionMode && selectedIds.has(t.id)
                                                            ? <Check size={18} />
                                                            : (t.type === 'income' ? <TrendingUp size={18} className="text-emerald-500" /> :
                                                                t.type === 'investment' ? <PieChart size={18} className="text-indigo-400" /> :
                                                                    t.isSettlement ? <ArrowRightLeft size={18} className="text-amber-400" /> :
                                                                        <span className="text-lg">üè∑Ô∏è</span>)
                                                        }
                                                    </div>

                                                    {/* Indicador de "Quem Pagou" */}
                                                    {viewMode === 'joint' && !selectionMode && (
                                                        <div className="absolute -bottom-1 -right-1 w-4 h-4 rounded-full border border-slate-900 overflow-hidden z-10">
                                                            {(() => {
                                                                const isCreatorPayer = t.payer === 'me';
                                                                const payerId = isCreatorPayer ? t.ownerId : (t.ownerId === 'bruno' ? 'maiara' : 'bruno');
                                                                const payerConfig = USER_CONFIG[payerId];
                                                                return (
                                                                    <div className={`w-full h-full flex items-center justify-center text-[8px] ${payerConfig?.color || 'bg-gray-500'}`}>
                                                                        {payerConfig?.avatar}
                                                                    </div>
                                                                );
                                                            })()}
                                                        </div>
                                                    )}
                                                </div>

                                                {/* 2. DADOS PRINCIPAIS (AGORA APENAS LEITURA) */}
                                                <div className="flex-1 min-w-0 select-none">
                                                    <div className="flex justify-between items-baseline mb-1">
                                                        <h4 className={`font-bold text-sm truncate pr-4 flex items-center gap-2 ${t.type === 'expense' ? 'text-slate-100' : 'text-slate-200'}`}>
                                                            {t.isShared && !t.isSettlement && <Users size={14} className="text-indigo-400 shrink-0" />}
                                                            {t.displayTitle || t.title}
                                                        </h4>
                                                        <span className={`font-bold text-sm whitespace-nowrap ${t.type === 'income' ? 'text-emerald-500' : 'text-rose-400'}`}>
                                                            {t.type === 'income' ? '+' : '-'} {formatCurrency(t.amount)}
                                                        </span>
                                                    </div>

                                                    <div className="flex justify-between items-center text-xs text-slate-500">
                                                        <div className="flex gap-2 truncate items-center">
                                                            <span>{t.date.split('-')[2]}/{t.date.split('-')[1]}</span>
                                                            <span className="opacity-30">‚Ä¢</span>
                                                            <span className="truncate max-w-[150px]">{t.category} {t.subCategory ? `(${t.subCategory})` : ''}</span>
                                                        </div>
                                                        {t.market && (
                                                            <span className="text-slate-600 truncate max-w-[100px] italic">
                                                                {t.market}
                                                            </span>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                    {data.list.length === 0 && (
                                        <div className="text-center text-slate-500 py-12">
                                            <ListIcon className="mx-auto mb-3 opacity-20" size={40} />
                                            <p className="text-sm font-medium opacity-60">Sem movimenta√ß√µes este m√™s.</p>
                                        </div>
                                    )}
                                </div>
                            ) : (
                                /* --- NOVO MODO: VIS√ÉO GR√ÅFICA --- */
                                <div className="space-y-4 animate-fade-in -mt-4">

                                    {/* GR√ÅFICO 1: MAIORES GASTOS (Barras Horizontais) */}
                                    <div className="bg-slate-900/40 rounded-3xl p-5 border border-white/5">
                                        <h3 className="font-bold text-sm text-slate-300 mb-4 flex items-center gap-2 uppercase tracking-wider"><PieChart size={16} className="text-rose-400" /> Maiores Gastos</h3>
                                        <div className="space-y-3">
                                            {analysisData.charts.map((c, i) => (
                                                <div key={i} className="group">
                                                    <div className="flex justify-between text-xs font-bold mb-1">
                                                        <span className="text-slate-200 flex items-center gap-1.5">{c.icon} {c.name}</span>
                                                        <span className="text-rose-400">{formatCurrency(c.amount)}</span>
                                                    </div>
                                                    <div className="h-2 w-full bg-slate-800 rounded-full overflow-hidden">
                                                        <div className={`h-full rounded-full transition-all duration-1000 ${c.color}`} style={{ width: `${c.pct}%` }}></div>
                                                    </div>
                                                </div>
                                            ))}
                                            {analysisData.charts.length === 0 && <p className="text-xs text-slate-500 text-center">Sem dados suficientes.</p>}
                                        </div>
                                    </div>

                                    {/* GR√ÅFICO 2: TRANSA√á√ïES POR SEMANA (Linhas M√∫ltiplas) */}
                                    <div className="bg-slate-900/40 rounded-3xl p-5 border border-white/5">
                                        <h3 className="font-bold text-sm text-slate-300 mb-4 flex items-center gap-2 uppercase tracking-wider"><BarChart3 size={16} className="text-indigo-400" /> Fluxo Semanal</h3>

                                        {(() => {
                                            // Agrupamento Semanal Direto (Isolado da L√≥gica Principal)
                                            const weeks = [1, 2, 3, 4];
                                            const weekData = weeks.map(w => {
                                                const startDay = (w - 1) * 7 + 1;
                                                const endDay = w === 4 ? 31 : w * 7;
                                                const txsInWeek = data.list.filter(t => {
                                                    const day = parseInt(t.date.split('-')[2]);
                                                    return day >= startDay && day <= endDay;
                                                });
                                                return {
                                                    week: w,
                                                    label: `Sem ${w}`,
                                                    exp: txsInWeek.filter(t => t.type === 'expense').reduce((acc, t) => acc + Number(t.amount), 0),
                                                    inc: txsInWeek.filter(t => t.type === 'income').reduce((acc, t) => acc + Number(t.amount), 0),
                                                    inv: txsInWeek.filter(t => t.type === 'investment').reduce((acc, t) => acc + Number(t.amount), 0),
                                                };
                                            });
                                            const maxVal = Math.max(...weekData.map(d => Math.max(d.exp, d.inc, d.inv)), 1);

                                            return (
                                                <div onClick={() => setActiveBar(null)}>
                                                    {/* Legenda */}
                                                    <div className="flex justify-center gap-4 mb-4 text-xs font-bold">
                                                        <span className="flex items-center gap-1 text-emerald-500"><span className="w-2 h-2 rounded-full bg-emerald-500"></span>Receita</span>
                                                        <span className="flex items-center gap-1 text-rose-500"><span className="w-2 h-2 rounded-full bg-rose-500"></span>Despesa</span>
                                                        <span className="flex items-center gap-1 text-indigo-400"><span className="w-2 h-2 rounded-full bg-indigo-400"></span>Aporte</span>
                                                    </div>

                                                    {/* Gr√°fico SVG Customizado Interativo */}
                                                    <div className="flex items-end justify-between h-40 pt-4 border-b border-slate-700/50 pb-2 relative">
                                                        {weekData.map((d, i) => {
                                                            const hExp = (d.exp / maxVal) * 100;
                                                            const hInc = (d.inc / maxVal) * 100;
                                                            const hInv = (d.inv / maxVal) * 100;

                                                            const isIncActive = activeBar && activeBar.index === i && activeBar.type === 'inc';
                                                            const isExpActive = activeBar && activeBar.index === i && activeBar.type === 'exp';
                                                            const isInvActive = activeBar && activeBar.index === i && activeBar.type === 'inv';

                                                            return (
                                                                <div key={i} className="flex flex-col items-center flex-1 relative z-10">
                                                                    <div className="w-full flex justify-center items-end gap-1 h-32">
                                                                        {/* Receita */}
                                                                        <div
                                                                            onClick={(e) => { e.stopPropagation(); setActiveBar({ index: i, type: 'inc' }); }}
                                                                            style={{ height: `${hInc}%` }}
                                                                            className={`w-2 rounded-t-sm transition-all duration-300 cursor-pointer ${isIncActive ? 'bg-emerald-300 shadow-[0_0_10px_rgba(110,231,183,0.8)] scale-110' : 'bg-emerald-500 hover:bg-emerald-400'}`}
                                                                        >
                                                                            {isIncActive && <div className="absolute bottom-full mb-1 left-1/2 -translate-x-1/2 bg-emerald-900 border border-emerald-500 text-emerald-300 text-[9px] font-bold px-1.5 py-0.5 rounded shadow-xl whitespace-nowrap z-20 animate-pop">{formatCurrency(d.inc)}</div>}
                                                                        </div>
                                                                        {/* Despesa */}
                                                                        <div
                                                                            onClick={(e) => { e.stopPropagation(); setActiveBar({ index: i, type: 'exp' }); }}
                                                                            style={{ height: `${hExp}%` }}
                                                                            className={`w-2 rounded-t-sm transition-all duration-300 cursor-pointer ${isExpActive ? 'bg-rose-300 shadow-[0_0_10px_rgba(253,164,175,0.8)] scale-110' : 'bg-rose-500 hover:bg-rose-400'}`}
                                                                        >
                                                                            {isExpActive && <div className="absolute bottom-full mb-1 left-1/2 -translate-x-1/2 bg-rose-900 border border-rose-500 text-rose-300 text-[9px] font-bold px-1.5 py-0.5 rounded shadow-xl whitespace-nowrap z-20 animate-pop">{formatCurrency(d.exp)}</div>}
                                                                        </div>
                                                                        {/* Aporte */}
                                                                        <div
                                                                            onClick={(e) => { e.stopPropagation(); setActiveBar({ index: i, type: 'inv' }); }}
                                                                            style={{ height: `${hInv}%` }}
                                                                            className={`w-2 rounded-t-sm transition-all duration-300 cursor-pointer ${isInvActive ? 'bg-indigo-300 shadow-[0_0_10px_rgba(165,180,252,0.8)] scale-110' : 'bg-indigo-500 hover:bg-indigo-400'}`}
                                                                        >
                                                                            {isInvActive && <div className="absolute bottom-full mb-1 left-1/2 -translate-x-1/2 bg-indigo-900 border border-indigo-500 text-indigo-300 text-[9px] font-bold px-1.5 py-0.5 rounded shadow-xl whitespace-nowrap z-20 animate-pop">{formatCurrency(d.inv)}</div>}
                                                                        </div>
                                                                    </div>
                                                                    <span className="text-xs text-slate-500 font-bold mt-2">{d.label}</span>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </div>
                                            );
                                        })()}
                                    </div>
                                </div>
                            )}
                        </>
                    )}

                    {tab === 'home' && dashboardMode === 'investment' && (
                        <div className="space-y-6 animate-fade-in">
                            {/* Distribui√ß√£o por Institui√ß√£o */}
                            <div className="glass-card p-5">
                                <h3 className="font-bold text-lg mb-4 flex items-center gap-2 text-white uppercase tracking-wider"><Briefcase className="text-indigo-400" /> Por Institui√ß√£o</h3>
                                <div className="space-y-3">
                                    {Object.entries(data.investData.byBank || {}).sort(([, a], [, b]) => b - a).map(([name, val], i) => (
                                        <div key={i} className="flex justify-between items-center p-2 rounded-lg bg-slate-800/50 border border-white/5">
                                            <span className="font-bold text-sm text-slate-200">{name}</span>
                                            <span className="font-bold text-sm text-indigo-400">{formatCurrency(val)}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* Distribui√ß√£o por Tipo */}
                            <div className="glass-card p-5">
                                <h3 className="font-bold text-lg mb-4 flex items-center gap-2 text-white uppercase tracking-wider"><PieChart className="text-indigo-400" /> Por Classe de Ativo</h3>
                                <div className="grid grid-cols-2 gap-3">
                                    {Object.entries(data.investData.byType || {}).sort(([, a], [, b]) => b - a).map(([name, val], i) => (
                                        <div key={i} className="p-3 rounded-2xl bg-indigo-500/10 border border-indigo-500/20">
                                            <p className="text-xs font-bold text-indigo-300 uppercase mb-1">{name}</p>
                                            <p className="font-bold text-slate-200">{formatCurrency(val)}</p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- ABA DE TAREFAS UNIFICADA --- */}
                    {tab === 'chores' && (
                        <ChoresView
                            chores={chores}
                            userConfig={USER_CONFIG}
                            weekCycle={weekCycle}
                            data={data}
                            shoppingList={shoppingList}
                            onToggle={toggleChore}
                            onAdd={addChore}
                            onDelete={deleteChore}
                            onRotateCycle={rotateChores}
                            onResetDaily={resetDailyChores}
                        />
                    )}

                    {tab === 'planning' && (
                        <div className="space-y-6 animate-fade-in pb-20">
                            {/* SE√á√ÉO DE SONHOS */}
                            <div className="glass-card p-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="font-bold flex gap-2 items-center text-lg text-white uppercase tracking-wider">
                                        <Sparkles size={20} className="text-amber-500" />
                                        {viewMode === 'joint' ? 'Nossos Sonhos' : 'Meus Sonhos'}
                                    </h3>
                                    <button onClick={() => setDreamModal(true)} className="bg-slate-800 border border-white/20 text-white p-2 rounded-full hover:bg-slate-700"><Plus size={16} /></button>
                                </div>

                                {data.dreamsProgress.length === 0 ? (
                                    <p className="text-center text-slate-400 text-sm">Nenhum sonho cadastrado. Comece agora!</p>
                                ) : (
                                    <div className="space-y-4">
                                        {data.dreamsProgress.map(d => (
                                            // ADICIONADO "pr-7" ABAIXO PARA EVITAR SOBREPOSI√á√ÉO COM O BOT√ÉO X
                                            <div key={d.id} className="relative pr-7">
                                                <div className="flex justify-between items-end mb-1">
                                                    <div>
                                                        <span className="text-2xl mr-2">{d.emoji}</span>
                                                        <span className="font-bold text-slate-200">{d.title}</span>
                                                    </div>
                                                    <div className="text-right">
                                                        <p className="text-xs text-slate-400">Meta: {formatCurrency(d.targetAmount)}</p>
                                                        <p className="font-bold text-indigo-400">{formatCurrency(d.currentAmount)}</p>
                                                    </div>
                                                </div>
                                                <div className="h-4 bg-slate-700/50 rounded-full overflow-hidden relative">
                                                    <div className="h-full bg-gradient-to-r from-indigo-500 to-purple-500 transition-all duration-1000" style={{ width: `${d.pct}%` }} />
                                                </div>
                                                <button onClick={() => deleteDream(d.id)} className="absolute -top-1 -right-1 opacity-0 hover:opacity-100 transition-opacity bg-rose-500/20 p-1 rounded-full text-rose-500 hover:bg-rose-500/30"><X size={12} /></button>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>

                            <div className="glass-card p-6">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="font-bold flex gap-2 items-center text-lg text-white uppercase tracking-wider">
                                        <Target size={20} className="text-indigo-400" />
                                        Or√ßamento Mensal
                                    </h3>
                                    <button onClick={openBudget} className="text-xs bg-indigo-500/10 text-indigo-400 px-3 py-1.5 rounded-lg font-bold flex gap-1 items-center hover:bg-indigo-500/20 transition-colors border border-indigo-500/20">
                                        <Settings size={14} /> Configurar
                                    </button>
                                </div>

                                {data.planning.length === 0 ? (
                                    <p className="text-center text-slate-400 text-sm py-8">Nenhuma meta configurada.</p>
                                ) : (
                                    <div className="space-y-8">
                                        {/* OBJETIVOS DE ENTRADA */}
                                        {data.planning.filter(b => b.type === 'in').length > 0 && (
                                            <div className="space-y-4">
                                                <h4 className="text-xs font-bold uppercase text-emerald-500 tracking-wider mb-2 border-b border-emerald-500/30 pb-1">Objetivos de Receita</h4>
                                                {data.planning.filter(b => b.type === 'in').map((b, i) => (
                                                    <div key={'in-' + i}>
                                                        <div className="flex justify-between mb-1 text-sm font-bold">
                                                            <span className="flex gap-2 text-slate-200">{b.icon} {b.category}</span>
                                                            <span className={b.realized >= b.limit ? 'text-emerald-400' : 'text-slate-400'}>
                                                                {formatCurrency(b.realized)} / {formatCurrency(b.limit)}
                                                            </span>
                                                        </div>
                                                        <div className="h-3 bg-slate-700/50 rounded-full overflow-hidden relative">
                                                            <div className={`h-full transition-all duration-500 rounded-full ${b.pct >= 100 ? 'bg-emerald-500' : 'bg-emerald-400/70'}`} style={{ width: `${b.pct}%` }} />
                                                        </div>
                                                        <p className="text-xs text-right mt-1 text-slate-400 font-bold">{b.rawPct.toFixed(0)}% atingido</p>
                                                    </div>
                                                ))}
                                            </div>
                                        )}

                                        {/* LIMITES DE SA√çDA */}
                                        {data.planning.filter(b => b.type === 'out').length > 0 && (
                                            <div className="space-y-4">
                                                <h4 className="text-xs font-bold uppercase text-rose-500 tracking-wider mb-2 border-b border-rose-500/30 pb-1 mt-6">Limites de {dashboardMode === 'statement' ? 'Gastos' : 'Aportes'}</h4>
                                                {data.planning.filter(b => b.type === 'out').map((b, i) => (
                                                    <div key={'out-' + i}>
                                                        <div className="flex justify-between mb-1 text-sm font-bold">
                                                            <span className="flex gap-2 text-slate-200">{b.icon} {b.category}</span>
                                                            <span className={b.realized > b.limit ? 'text-rose-500' : 'text-slate-400'}>
                                                                {formatCurrency(b.realized)} / {formatCurrency(b.limit)}
                                                            </span>
                                                        </div>
                                                        <div className="h-3 bg-slate-700/50 rounded-full overflow-hidden">
                                                            <div className={`h-full transition-all duration-500 rounded-full ${b.pct > 100 ? 'bg-rose-500' : b.pct > 80 ? 'bg-amber-400' : 'bg-blue-400'}`} style={{ width: `${b.pct}%` }} />
                                                        </div>
                                                        <p className="text-xs text-right mt-1 text-slate-400 font-bold">{b.rawPct.toFixed(0)}% consumido</p>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {tab === 'reports' && (
                        <div className="space-y-6 animate-fade-in pb-20">
                            {/* DASHBOARD DE SA√öDE FINANCEIRA */}
                            <div className="glass-card text-white p-5 rounded-3xl shadow-lg relative overflow-hidden mb-6">
                                <div className="absolute top-0 right-0 p-6 opacity-5"><Heart size={120} /></div>
                                <h3 className="font-bold text-lg mb-4 flex items-center gap-2 relative z-10 uppercase tracking-wider">
                                    <Sparkles className="text-yellow-400" />
                                    {dashboardMode === 'statement' ? 'Sa√∫de do M√™s' : 'Raio-X Patrimonial'}
                                </h3>

                                <div className="grid grid-cols-2 gap-4 relative z-10">
                                    {dashboardMode === 'statement' ? (
                                        <>
                                            <div className="bg-white/10 p-3 rounded-2xl backdrop-blur-sm border border-white/5">
                                                <p className="text-xs text-slate-300 font-bold uppercase mb-1">Taxa de Poupan√ßa</p>
                                                <p className={`text-xl font-extrabold ${data.analysis.health.savingsRate > 20 ? 'text-emerald-400' : data.analysis.health.savingsRate > 0 ? 'text-amber-400' : 'text-rose-400'}`}>
                                                    {data.analysis.health.savingsRate.toFixed(0)}%
                                                </p>
                                                <p className="text-xs text-slate-400">Meta ideal: &gt;20%</p>
                                            </div>
                                            <div className="bg-white/10 p-3 rounded-2xl backdrop-blur-sm border border-white/5">
                                                <p className="text-xs text-slate-300 font-bold uppercase mb-1">Poder de Aporte</p>
                                                <p className="text-xl font-extrabold text-indigo-400">
                                                    {data.analysis.health.investRate.toFixed(0)}%
                                                </p>
                                                <p className="text-xs text-slate-400">da renda foi investida</p>
                                            </div>
                                            <div className="col-span-2 bg-white/5 p-3 rounded-2xl border border-white/5 flex justify-between items-center mt-1">
                                                <div>
                                                    <p className="text-xs text-slate-400 font-bold uppercase">
                                                        {viewMode === 'joint' ? 'Custo p/ Pessoa' : 'Sobras (Saldo)'}
                                                    </p>
                                                    <p className="text-lg font-bold text-white">
                                                        {viewMode === 'joint'
                                                            ? formatCurrency(data.exp / 2)
                                                            : formatCurrency(data.bal)
                                                        }
                                                    </p>
                                                </div>
                                                <div className="h-8 w-[1px] bg-white/10"></div>
                                                <div className="text-right">
                                                    <p className="text-xs text-slate-400 font-bold uppercase">Custo de Vida/Dia</p>
                                                    <p className="text-lg font-bold text-white">{formatCurrency(data.analysis.health.burnRate / 30)}</p>
                                                </div>
                                            </div>
                                        </>
                                    ) : (
                                        <>
                                            <div className="col-span-2 bg-gradient-to-r from-slate-800/60 to-slate-900/60 p-4 rounded-2xl border border-slate-700 shadow-lg mb-2">
                                                {viewMode === 'joint' ? (
                                                    <>
                                                        <p className="text-xs text-slate-400 font-bold uppercase mb-1 flex items-center gap-2">
                                                            <Trophy size={12} className="text-yellow-400" /> Total Acumulado (Casal)
                                                        </p>
                                                        <p className="text-2xl font-extrabold text-white tracking-tight">
                                                            {formatCurrency(data.investData.totalCurrent)}
                                                        </p>
                                                        <p className="text-xs text-slate-400 mt-1">
                                                            Total bruto em carteira (Sem descontar gastos)
                                                        </p>
                                                    </>
                                                ) : (
                                                    <>
                                                        <p className="text-xs text-slate-400 font-bold uppercase mb-1 flex items-center gap-2">
                                                            <Wallet size={12} /> Patrim√¥nio Global (Pessoal)
                                                        </p>
                                                        <p className="text-2xl font-extrabold text-white tracking-tight">
                                                            {formatCurrency(data.analysis.health.totalNetWorth)}
                                                        </p>
                                                        <p className="text-xs text-slate-400 mt-1">
                                                            Saldo em Conta ({formatCurrency(data.previousBalance + data.bal)}) + Investimentos ({formatCurrency(data.investData.totalCurrent)})
                                                        </p>
                                                    </>
                                                )}
                                            </div>

                                            <div className="bg-white/10 p-3 rounded-2xl backdrop-blur-sm border border-white/5">
                                                <p className="text-xs text-slate-300 font-bold uppercase mb-1">Liberdade Fin.</p>
                                                <p className="text-xl font-extrabold text-amber-400">
                                                    {data.analysis.health.freedom.toFixed(2)}%
                                                </p>
                                                <p className="text-xs text-slate-400">Pagos por dividendos</p>
                                            </div>
                                            <div className="bg-white/10 p-3 rounded-2xl backdrop-blur-sm border border-white/5">
                                                <p className="text-xs text-slate-300 font-bold uppercase mb-1">Sobreviv√™ncia</p>
                                                <p className="text-xl font-extrabold text-emerald-400">
                                                    {data.analysis.health.coverage.toFixed(1)} <span className="text-sm font-normal text-slate-300">meses</span>
                                                </p>
                                                <p className="text-xs text-slate-400">Sem renda ativa</p>
                                            </div>

                                            <div className="col-span-2 mt-2 bg-white/5 p-3 rounded-xl border border-white/10">
                                                <div className="flex justify-between items-start">
                                                    <div>
                                                        <p className="text-xs text-slate-400 font-bold uppercase mb-1">Rentabilidade Carteira</p>
                                                        <div className="flex gap-2 mt-1 items-baseline">
                                                            <span className={`text-lg font-bold ${data.investData.profit >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                                                                {data.investData.profit >= 0 ? '+' : ''}{formatCurrency(data.investData.profit)}
                                                            </span>
                                                            <span className="text-xs text-slate-400">({data.investData.yieldPct.toFixed(1)}%)</span>
                                                        </div>
                                                    </div>
                                                    <button onClick={() => setPricesModal(true)} className="bg-white/10 p-2 rounded-lg hover:bg-white/20 transition-colors">
                                                        <Sparkles size={16} className="text-yellow-400" />
                                                    </button>
                                                </div>
                                            </div>
                                        </>
                                    )}
                                </div>
                            </div>

                            {/* NOVA TABELA: DETALHAMENTO DA CARTEIRA */}
                            {dashboardMode === 'investment' && (
                                <div className="glass-card p-5 mb-6">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="font-bold text-lg flex items-center gap-2 text-white uppercase tracking-wider"><PieChart className="text-indigo-400" /> Minha Carteira</h3>
                                        <button onClick={() => setPricesModal(true)} className="text-xs text-indigo-400 font-bold bg-indigo-500/10 px-3 py-1.5 rounded-lg border border-indigo-500/20 hover:bg-indigo-500/20 transition-colors">Atualizar Cota√ß√µes</button>
                                    </div>
                                    <div className="space-y-3">
                                        {data.investData.portfolio.map((asset, i) => {
                                            const assetProfit = asset.currentTotal - asset.totalCost;
                                            const assetYield = asset.totalCost > 0 ? (assetProfit / asset.totalCost) * 100 : 0;

                                            return (
                                                <div key={i} className="flex justify-between items-center border-b border-white/5 pb-2 last:border-0 last:pb-0">
                                                    <div>
                                                        <p className="font-bold text-sm text-slate-200 flex items-center gap-2">
                                                            {asset.name}
                                                        </p>
                                                        <p className="text-xs text-slate-400">
                                                            {asset.qty > 0 ? `${asset.qty} cotas ‚Ä¢ PM ${formatCurrency(asset.avgPrice)}` : 'Saldo Financeiro'}
                                                        </p>
                                                    </div>
                                                    <div className="text-right">
                                                        <p className="font-bold text-sm text-slate-200">{formatCurrency(asset.currentTotal)}</p>
                                                        {asset.qty > 0 && (
                                                            <p className={`text-xs font-bold ${assetProfit >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                                                                {assetProfit >= 0 ? '+' : ''}{assetYield.toFixed(1)}%
                                                            </p>
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                        {data.investData.portfolio.length === 0 && <p className="text-center text-slate-400 text-xs py-2">Nenhum ativo na carteira.</p>}
                                    </div>
                                </div>
                            )}

                            {/* CARD RECEITA/DESPESA CL√ÅSSICO */}
                            <div className="grid grid-cols-2 gap-3">
                                {dashboardMode === 'statement' ? (
                                    <>
                                        <div className="bg-emerald-500/10 p-4 rounded-2xl border border-emerald-500/20">
                                            <p className="text-xs text-emerald-400 font-bold uppercase mb-1">Entradas</p>
                                            <p className="text-lg font-extrabold text-emerald-100">{formatCurrency(data.inc)}</p>
                                        </div>
                                        <div className="bg-rose-500/10 p-4 rounded-2xl border border-rose-500/20">
                                            <p className="text-xs text-rose-400 font-bold uppercase mb-1">Sa√≠das Totais</p>
                                            <p className="text-lg font-extrabold text-rose-100">{formatCurrency(data.analysis.health.totalOutflows)}</p>
                                            <p className="text-xs text-rose-300/70 font-bold">(Despesas + Aportes)</p>
                                        </div>
                                    </>
                                ) : (
                                    <>
                                        <div className="bg-indigo-500/10 p-4 rounded-2xl border border-indigo-500/20">
                                            <p className="text-xs text-indigo-400 font-bold uppercase mb-1">Aporte M√™s</p>
                                            <p className="text-lg font-extrabold text-indigo-100">{formatCurrency(data.analysis.health.strictScopeInv)}</p>
                                        </div>
                                        <div className="bg-amber-500/10 p-4 rounded-2xl border border-amber-500/20">
                                            <p className="text-xs text-amber-400 font-bold uppercase mb-1">Dividendos</p>
                                            <p className="text-lg font-extrabold text-amber-100">{formatCurrency(data.investData.dividends || 0)}</p>
                                        </div>
                                    </>
                                )}
                            </div>

                            {/* HIST√ìRICO MENSAL */}
                            <div className="glass-card p-5">
                                <h3 className="font-bold text-lg mb-2 flex items-center gap-2 text-white uppercase tracking-wider"><BarChart3 className="text-indigo-400" /> Evolu√ß√£o (6 Meses)</h3>
                                <SimpleHistoryChart data={data.analysis.history} mode={dashboardMode} />
                            </div>

                            {/* FLUXO DE BANCOS */}
                            <div className="glass-card p-5">
                                <h3 className="font-bold text-lg mb-4 flex items-center gap-2 text-white uppercase tracking-wider">
                                    <Banknote className="text-indigo-400" />
                                    {dashboardMode === 'statement' ? 'Fluxo de Contas' : 'Aportes por Corretora'}
                                </h3>
                                <div className="space-y-3">
                                    {Object.entries(analysisData.bankFlow).sort(([, a], [, b]) => b - a).map(([bName, val], i) => (
                                        <div key={i} className="flex justify-between items-center">
                                            <span className="text-sm text-slate-300 font-bold">{BANKS.find(b => b.id === bName)?.name || bName}</span>
                                            <span className={`text-sm font-bold ${val >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{val > 0 ? '+' : ''}{formatCurrency(val)}</span>
                                        </div>
                                    ))}
                                    {Object.keys(analysisData.bankFlow).length === 0 && <p className="text-slate-500 text-xs">Sem dados para este per√≠odo.</p>}
                                </div>
                            </div>

                            {/* TOP CATEGORIAS */}
                            <div className="glass-card p-5">
                                <h3 className="font-bold flex gap-2 mb-4 text-white uppercase tracking-wider">
                                    <PieChart size={20} className="text-indigo-400" />
                                    {dashboardMode === 'statement' ? 'Maiores Despesas' : 'Aloca√ß√£o por Tipo'}
                                </h3>
                                {analysisData.charts.length > 0 ? analysisData.charts.map((c, i) => (
                                    <div key={i} className="mb-3">
                                        <div className="flex justify-between items-center mb-1">
                                            <div className="flex gap-2 items-center"><span className="text-lg">{c.icon}</span><span className="text-sm font-bold text-slate-300">{c.name}</span></div>
                                            <span className="font-bold text-xs text-white">{formatCurrency(c.amount)}</span>
                                        </div>
                                        <div className="h-1.5 w-full bg-slate-700/50 rounded-full"><div className={`h-full rounded-full ${c.color}`} style={{ width: `${c.pct}%` }} /></div>
                                    </div>
                                )) : <p className="text-slate-500 text-xs">Sem dados para exibir.</p>}
                            </div>

                            <button onClick={exportData} className="w-full py-3 bg-slate-800 text-white rounded-xl font-bold flex items-center justify-center gap-2"><Download size={18} /> Exportar Relat√≥rio Excel</button>
                        </div>
                    )}
                </div>

                {/* Nav */}
                {/* MENU DE A√á√ÉO CENTRAL (Bot√µes S√≥lidos e com Foco) */}
                {menuOpen && (
                    <div className="fixed bottom-28 left-1/2 -translate-x-1/2 z-50 flex flex-col gap-3 items-center animate-pop w-64 px-4">

                        {/* 1. Bot√£o Arquivo com IA - Estilo Glassmorphism Premium */}
                        <button onClick={() => fileInputRef.current.click()}
                            className="w-full bg-slate-800/95 backdrop-blur-lg text-white p-4 rounded-2xl shadow-2xl border border-white/10 flex items-center justify-center gap-3 font-bold text-sm active:scale-95 transition-all hover:bg-slate-700">
                            <Sparkles size={20} className="text-yellow-400 drop-shadow-[0_0_8px_rgba(250,204,21,0.5)]" />
                            <span>Arquivo com IA</span>
                        </button>

                        {/* 2. Bot√£o Lan√ßar Manual - Padronizado com o de cima */}
                        <button onClick={() => { setMenuOpen(false); setModalOpen(true); }}
                            className="w-full bg-blue-600/95 backdrop-blur-lg text-white p-4 rounded-2xl shadow-2xl border border-white/10 flex items-center justify-center gap-3 font-bold text-sm active:scale-95 transition-all hover:bg-blue-500">
                            <FileText size={20} className="text-white" />
                            <span>Lan√ßar Manual</span>
                        </button>

                    </div>
                )}

                {/* BARRA DE NAVEGA√á√ÉO HUB - VERS√ÉO SLIM (Menos espa√ßo) */}
                <div className="fixed bottom-0 w-full z-40">
                    {/* Gradiente sutil para transi√ß√£o suave do conte√∫do */}
                    <div className="h-6 bg-gradient-to-t from-[#0f172a] to-transparent pointer-events-none absolute bottom-full w-full"></div>

                    {/* Barra Principal: Altura Reduzida (pb-2) */}
                    <div className="bg-[#0f172a] border-t border-white/10 pb-2 pt-2 px-6 shadow-2xl">
                        <div className="grid grid-cols-5 items-end relative">

                            {/* 1. FINAN√áAS */}
                            <button onClick={() => setTab('home')} className={`flex flex-col items-center gap-0.5 group ${tab === 'home' ? 'text-emerald-400' : 'text-slate-500 hover:text-slate-300'}`}>
                                <div className={`p-1 rounded-full transition-all ${tab === 'home' ? 'bg-emerald-400/10' : ''}`}>
                                    <Wallet size={18} strokeWidth={tab === 'home' ? 2.5 : 2} className="group-active:scale-90 transition-transform" />
                                </div>
                                {tab === 'home' && <span className="text-[8px] font-medium tracking-wide opacity-90 animate-fade-in">Norte</span>}
                            </button>

                            {/* 2. CASA */}
                            <button onClick={() => setTab('chores')} className={`flex flex-col items-center gap-0.5 group ${tab === 'chores' ? 'text-emerald-400' : 'text-slate-500 hover:text-slate-300'}`}>
                                <div className={`p-1 rounded-full transition-all ${tab === 'chores' ? 'bg-emerald-400/10' : ''}`}>
                                    <Home size={18} strokeWidth={tab === 'chores' ? 2.5 : 2} className="group-active:scale-90 transition-transform" />
                                </div>
                                {tab === 'chores' && <span className="text-[8px] font-medium tracking-wide opacity-90 animate-fade-in">Casa</span>}
                            </button>

                            {/* 3. B√öSSOLA CENTRAL (√çcone Aumentado) */}
                            <div className="relative -top-6 flex justify-center">
                                <button
                                    onClick={() => setMenuOpen(!menuOpen)}
                                    className={`w-14 h-14 rounded-full flex items-center justify-center relative shadow-2xl shadow-black/50 transition-all duration-500 ${menuOpen ? 'scale-105' : 'active:scale-95 hover:-translate-y-0.5'}`}
                                >
                                    <div className="absolute inset-0 rounded-full bg-gradient-to-b from-slate-700 to-slate-900 border-[1.5px] border-slate-500"></div>

                                    {/* AJUSTE: Nova Rosa dos Ventos SVG (Substitui√ß√£o completa do svg anterior) */}
                                    <div className={`relative w-10 h-10 transition-transform duration-700 cubic-bezier(0.4, 0, 0.2, 1) ${menuOpen ? 'rotate-[225deg]' : 'rotate-0'}`}>
                                        <svg viewBox="0 0 100 100" className={`w-full h-full drop-shadow-[0_0_3px_rgba(16,185,129,0.3)] transition-colors duration-500 ${menuOpen ? 'text-emerald-400' : 'text-slate-300'}`}>
                                            {/* Pontas Maiores (N-S-L-O) */}
                                            <path d="M50 10 L58 42 L90 50 L58 58 L50 90 L42 58 L10 50 L42 42 Z" fill="currentColor" opacity="0.9" />
                                            {/* Destaque do Norte (Seta Vermelha Estilizada) */}
                                            <path d="M50 10 L58 42 L50 50 Z" fill="#ef4444" />
                                            <path d="M50 10 L42 42 L50 50 Z" fill="#b91c1c" />
                                            {/* Pontas Menores (Intermedi√°rias) */}
                                            <path d="M50 50 L65 35 L50 50 L80 65 L50 50 L35 80 L50 50 L20 35 Z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" opacity="0.4" />
                                            {/* Centro */}
                                            <circle cx="50" cy="50" r="4" fill="#0f172a" stroke="currentColor" strokeWidth="1.5" />
                                        </svg>
                                    </div>
                                </button>
                            </div>

                            {/* 4. METAS */}
                            <button onClick={() => setTab('planning')} className={`flex flex-col items-center gap-0.5 group ${tab === 'planning' ? 'text-emerald-400' : 'text-slate-500 hover:text-slate-300'}`}>
                                <div className={`p-1 rounded-full transition-all ${tab === 'planning' ? 'bg-emerald-400/10' : ''}`}>
                                    <Target size={18} strokeWidth={tab === 'planning' ? 2.5 : 2} className="group-active:scale-90 transition-transform" />
                                </div>
                                {tab === 'planning' && <span className="text-[8px] font-medium tracking-wide opacity-90 animate-fade-in">Metas</span>}
                            </button>

                            {/* 5. AN√ÅLISE */}
                            <button onClick={() => setTab('reports')} className={`flex flex-col items-center gap-0.5 group ${tab === 'reports' ? 'text-emerald-400' : 'text-slate-500 hover:text-slate-300'}`}>
                                <div className={`p-1 rounded-full transition-all ${tab === 'reports' ? 'bg-emerald-400/10' : ''}`}>
                                    <BarChart3 size={18} strokeWidth={tab === 'reports' ? 2.5 : 2} className="group-active:scale-90 transition-transform" />
                                </div>
                                {tab === 'reports' && <span className="text-[8px] font-medium tracking-wide opacity-90 animate-fade-in">An√°lise</span>}
                            </button>
                        </div>
                    </div>
                </div>

                <input type="file" ref={fileInputRef} onChange={handleUniversalUpload} accept="image/*,.pdf,.csv,.xlsx,.xls" className="hidden" />

                <input type="file" ref={fileInputRef} onChange={handleUniversalUpload} accept="image/*,.pdf,.csv,.xlsx,.xls" className="hidden" />

                {/* Modal Settings */}
                {settingsModal && (
                    <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fade-in">
                        <div className="glass-card w-full max-w-sm rounded-[2rem] p-6 shadow-2xl animate-slide-up relative">
                            <div className="flex justify-between mb-6"><h3 className="font-bold text-xl flex gap-2 text-white"><Settings className="text-indigo-400" /> Configura√ß√µes</h3><button onClick={() => setSettingsModal(false)} className="bg-white/10 p-2 rounded-full text-white hover:bg-white/20 transition-colors"><X size={20} /></button></div>
                            <div className="space-y-4">
                                <div>
                                    <label className="text-xs font-bold uppercase text-slate-400 ml-1">Chave API Google (IA)</label>
                                    <div className="relative mt-1">
                                        <input type="password" value={apiKey} onChange={e => setApiKey(e.target.value)} placeholder="Cole a chave..." className="w-full bg-slate-800/50 border border-white/10 p-4 pl-10 rounded-xl font-bold outline-none focus:border-indigo-500 text-white placeholder-slate-600" />
                                        <Key size={18} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500" />
                                    </div>
                                </div>
                                <button onClick={() => { localStorage.setItem('gemini_api_key', apiKey); alert('Salvo!'); setSettingsModal(false); }} className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-500 transition-colors">Salvar Configura√ß√£o</button>
                                <button onClick={exportData} className="w-full border border-white/10 text-slate-300 py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-white/5 transition-colors"><Download size={18} /> Exportar Dados (Excel)</button>

                                {/* --- BOT√ÉO DE RESET (NOVO) --- */}
                                <div className="pt-4 mt-4 border-t border-white/10">
                                    <button onClick={resetDatabase} className="w-full bg-rose-500/10 text-rose-400 border border-rose-500/20 py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-rose-500/20 transition-colors">
                                        <Trash2 size={18} /> Reiniciar Banco de Dados
                                    </button>
                                    <p className="text-xs text-center text-slate-500 mt-2">Apaga tudo e restaura o padr√£o de f√°brica.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                )}

                {/* Modal Add (Manual) - VERS√ÉO S√ìLIDA PARA LEITURA */}
                {/* Modal Add (Manual) - REDESIGN PREMIUM */}
                {/* Modal Add (Manual) - REDESIGN PREMIUM */}
                {/* Modal Add (Manual) - VERS√ÉO FINAL (C√°lculos e Layout Ajustado) */}
                {modalOpen && (
                    <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-end justify-center animate-fade-in">
                        <div className="w-full bg-[#1e293b] rounded-t-[2.5rem] p-6 pb-12 shadow-[0_-10px_40px_rgba(0,0,0,0.5)] animate-slide-up max-h-[95vh] overflow-y-auto border-t border-white/10">

                            {/* Cabe√ßalho */}
                            <div className="flex justify-between items-center mb-6 border-b border-white/5 pb-4">
                                <div>
                                    <p className="text-xs text-slate-400 font-bold uppercase tracking-wider">Nova Movimenta√ß√£o</p>
                                    <h3 className="font-bold text-xl text-white flex items-center gap-2">
                                        {fType === 'expense' ? <TrendingDown size={20} className="text-rose-500" /> : fType === 'income' ? <TrendingUp size={20} className="text-emerald-500" /> : <PieChart size={20} className="text-indigo-500" />}
                                        {fType === 'expense' ? 'Nova Despesa' : fType === 'income' ? 'Nova Receita' : 'Novo Aporte'}
                                    </h3>
                                </div>
                                <button onClick={() => setModalOpen(false)} className="bg-slate-800 p-2 rounded-full text-slate-400 hover:text-white hover:bg-slate-700 transition-colors"><X size={24} /></button>
                            </div>

                            <form onSubmit={saveTx} className="space-y-5">

                                {/* 1. SELETOR DE TIPO */}
                                <div className="bg-[#0f172a] p-1.5 rounded-2xl flex relative border border-white/5">
                                    {['expense', 'income', 'investment'].map(t => (
                                        <button type="button" key={t} onClick={() => { setFType(t); setFCat(''); }}
                                            className={`flex-1 py-3 rounded-xl text-xs font-bold uppercase transition-all flex items-center justify-center gap-2
                                                ${fType === t ? (t === 'expense' ? 'bg-rose-600 text-white shadow-lg' : t === 'income' ? 'bg-emerald-600 text-white shadow-lg' : 'bg-indigo-600 text-white shadow-lg') : 'text-slate-500 hover:text-slate-300'}`}>
                                            {t === 'expense' ? 'Despesa' : t === 'income' ? 'Receita' : 'Investir'}
                                        </button>
                                    ))}
                                </div>

                                {/* 2. VALORES */}
                                {fType === 'investment' ? (
                                    <div className="bg-[#0f172a] p-4 rounded-3xl border border-white/5 space-y-3">
                                        <div className="flex gap-3">
                                            <div className="flex-1">
                                                <label className="text-xs font-bold text-slate-500 uppercase ml-1 mb-1 block">Quantidade</label>
                                                <input type="number" step="0.000001" value={fQty} onChange={e => {
                                                    const q = e.target.value;
                                                    setFQty(q);
                                                    if (fUnitPrice) setFAmount((Number(q) * Number(fUnitPrice)).toFixed(2));
                                                }} placeholder="0" className="w-full bg-[#020617] p-3 rounded-xl text-white font-bold outline-none border border-slate-700 focus:border-indigo-500 shadow-inner" />
                                            </div>
                                            <div className="flex-1">
                                                <label className="text-xs font-bold text-slate-500 uppercase ml-1 mb-1 block">Pre√ßo Unit.</label>
                                                <input type="number" step="0.01" value={fUnitPrice} onChange={e => {
                                                    const p = e.target.value;
                                                    setFUnitPrice(p);
                                                    if (fQty) setFAmount((Number(fQty) * Number(p)).toFixed(2));
                                                }} placeholder="R$ 0,00" className="w-full bg-[#020617] p-3 rounded-xl text-white font-bold outline-none border border-slate-700 focus:border-indigo-500 shadow-inner" />
                                            </div>
                                        </div>
                                        <div className="pt-2 border-t border-white/5 flex justify-between items-center px-2">
                                            <span className="text-xs font-bold text-slate-400 uppercase">Total Estimado</span>
                                            <span className="text-xl font-black text-white">R$ {fAmount || '0.00'}</span>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="relative py-2">
                                        <span className="absolute left-6 top-1/2 -translate-y-1/2 font-bold text-slate-600 text-xl">R$</span>
                                        <input
                                            type="number"
                                            step="0.01"
                                            value={fAmount}
                                            onChange={e => setFAmount(e.target.value)}
                                            placeholder="0,00"
                                            className="w-full bg-[#020617] p-5 pl-14 rounded-3xl text-4xl font-black text-white outline-none border border-white/5 placeholder-slate-700 text-center shadow-inner"
                                            required
                                        />
                                    </div>
                                )}

                                {/* 3. DESCRI√á√ÉO */}
                                <div className="relative">
                                    <input type="text" list="titleOptions" value={fTitle} onChange={e => setFTitle(e.target.value)} placeholder="Descri√ß√£o (ex: Almo√ßo, Sal√°rio)" className="w-full bg-[#020617] p-4 pl-12 rounded-xl text-white font-bold outline-none border border-slate-700 focus:border-indigo-500 shadow-inner" required />
                                    <Type size={18} className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500" />
                                    <datalist id="titleOptions">{uniqueTitles.map(t => <option key={t} value={t} />)}</datalist>
                                </div>

                                {/* 4. DATA E CONTA */}
                                <div className="flex gap-3">
                                    <div className="flex-1 relative">
                                        <input type="date" value={fDate} onChange={e => setFDate(e.target.value)} className="w-full bg-[#020617] p-3 pl-10 rounded-xl text-white font-bold text-sm outline-none border border-slate-700 shadow-inner" />
                                        <Calendar size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500" />
                                    </div>
                                    <div className="flex-1 relative">
                                        <input list="bankOptions" value={fBank} onChange={e => setFBank(e.target.value)} placeholder="Conta/Banco" className="w-full bg-[#020617] p-3 pl-10 rounded-xl text-white font-bold text-sm outline-none border border-slate-700 shadow-inner" />
                                        <Banknote size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500" />
                                        <datalist id="bankOptions">{BANKS.map(b => <option key={b.id} value={b.name} />)}</datalist>
                                    </div>
                                </div>

                                {/* 5. LOCAL / MERCADO */}
                                <div className="relative">
                                    <input type="text" list="marketOptions" value={fMarket} onChange={e => setFMarket(e.target.value)} placeholder={fType === 'investment' ? "Corretora / C√≥digo do Ativo" : "Local / Mercado"} className="w-full bg-[#020617] p-3 pl-10 rounded-xl text-white font-bold text-sm outline-none border border-slate-700 shadow-inner" />
                                    <MapPin size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500" />
                                    <datalist id="marketOptions">{uniqueMarkets.map(m => <option key={m} value={m} />)}</datalist>
                                </div>

                                {/* 6. VINCULAR A SONHO (NOVO) */}
                                {fType === 'investment' && data.dreamsProgress.length > 0 && (
                                    <div className="relative mb-2">
                                        <label className="text-xs font-bold text-slate-500 uppercase ml-1 block mb-1">Vincular a um Sonho</label>
                                        <div className="relative">
                                            <select value={fDreamId} onChange={e => setFDreamId(e.target.value)} className="w-full bg-[#020617] p-3 pl-10 rounded-xl text-white font-bold text-sm outline-none border border-slate-700 shadow-inner appearance-none">
                                                <option value="" className="text-slate-500">N√£o vincular (Carteira Geral)</option>
                                                {data.dreamsProgress.map(d => (
                                                    <option key={d.id} value={d.id}>{d.emoji} {d.title}</option>
                                                ))}
                                            </select>
                                            <Sparkles size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-yellow-500" />
                                        </div>
                                    </div>
                                )}

                                {/* 7. TOGGLES (LAYOUT OTIMIZADO - GRADE DE 2 COLUNAS) */}
                                {/* 7. TOGGLES (LAYOUT FINAL - GRADE DE 3 COLUNAS UNIFICADA) */}
                                <div className="grid grid-cols-3 gap-2">
                                    {/* 1. Recorr√™ncia (Agora igual aos outros) */}
                                    <div onClick={() => { setFRecurrent(!fRecurrent); setIsInstallment(false); }}
                                        className={`p-3 rounded-xl border flex flex-col items-center justify-center cursor-pointer transition-all gap-1 ${fRecurrent ? 'bg-amber-500/10 border-amber-500 text-amber-500' : 'bg-[#1e293b] border-slate-700 text-slate-500 hover:bg-slate-800'}`}>
                                        <div className={`p-2 rounded-full mb-1 ${fRecurrent ? 'bg-amber-500 text-white' : 'bg-slate-800 text-slate-400'}`}>
                                            <RefreshCw size={18} />
                                        </div>
                                        <span className="text-xs font-bold uppercase">Recorr√™ncia</span>
                                        {fRecurrent && <span className="text-[10px] bg-amber-500 text-slate-900 px-1.5 rounded-full absolute top-2 right-2 font-bold">On</span>}
                                    </div>

                                    {/* 2. Divis√£o */}
                                    <div onClick={() => setFShared(!fShared)}
                                        className={`p-3 rounded-xl border flex flex-col items-center justify-center cursor-pointer transition-all gap-1 ${fShared ? 'bg-pink-500/10 border-pink-500 text-pink-500' : 'bg-[#1e293b] border-slate-700 text-slate-500 hover:bg-slate-800'}`}>
                                        <div className={`p-2 rounded-full mb-1 ${fShared ? 'bg-pink-500 text-white' : 'bg-slate-800 text-slate-400'}`}>
                                            {fShared ? <Users size={18} /> : <User size={18} />}
                                        </div>
                                        <span className="text-xs font-bold uppercase">Divis√£o</span>
                                    </div>

                                    {/* 3. Parcelado */}
                                    <div onClick={() => { setIsInstallment(!isInstallment); setFRecurrent(false); }}
                                        className={`p-3 rounded-xl border flex flex-col items-center justify-center cursor-pointer transition-all gap-1 ${isInstallment ? 'bg-blue-500/10 border-blue-500 text-blue-500' : 'bg-[#1e293b] border-slate-700 text-slate-500 hover:bg-slate-800'}`}>
                                        <div className={`p-2 rounded-full mb-1 ${isInstallment ? 'bg-blue-500 text-white' : 'bg-slate-800 text-slate-400'}`}>
                                            <Calendar size={18} />
                                        </div>
                                        <span className="text-xs font-bold uppercase">Parcelado</span>
                                        {isInstallment && <span className="text-[10px] bg-blue-500 text-white px-1.5 rounded-full absolute top-2 right-2">{installments}x</span>}
                                    </div>
                                </div>

                                {/* OP√á√ïES DE RECORR√äNCIA (Detalhado) - MOVIDO PARA FORA DO GRID */}
                                {fRecurrent && (
                                    <div className="bg-amber-500/10 p-4 rounded-xl border border-amber-500/30 animate-slide-up flex flex-col gap-2 mt-2">
                                        <div className="flex gap-2 bg-slate-900/50 p-1 rounded-lg">
                                            {['forever', 'date', 'count'].map(mode => (
                                                <button
                                                    key={mode}
                                                    type="button"
                                                    onClick={() => setFRecurrenceEndMode(mode)}
                                                    className={`flex-1 py-1.5 rounded text-[10px] font-bold uppercase transition-colors ${fRecurrenceEndMode === mode ? 'bg-amber-500 text-slate-900' : 'text-slate-400 hover:text-slate-200'}`}
                                                >
                                                    {mode === 'forever' ? 'Sempre' : mode === 'date' ? 'At√© Data' : 'X Vezes'}
                                                </button>
                                            ))}
                                        </div>

                                        {fRecurrenceEndMode === 'date' && (
                                            <div className="flex items-center gap-2 animate-fade-in">
                                                <label className="text-xs font-bold text-amber-500/70 uppercase whitespace-nowrap">At√©:</label>
                                                <input
                                                    type="month"
                                                    value={fRecurrenceEndDate}
                                                    onChange={e => setFRecurrenceEndDate(e.target.value)}
                                                    className="w-full bg-slate-900 p-2 rounded-lg text-white font-bold text-xs border border-amber-500/30 outline-none"
                                                />
                                            </div>
                                        )}

                                        {fRecurrenceEndMode === 'count' && (
                                            <div className="flex items-center gap-2 animate-fade-in">
                                                <label className="text-xs font-bold text-amber-500/70 uppercase whitespace-nowrap">Repetir:</label>
                                                <input
                                                    type="number"
                                                    min="2"
                                                    max="60"
                                                    value={fRecurrenceCount}
                                                    onChange={e => setFRecurrenceCount(e.target.value)}
                                                    className="flex-1 bg-slate-900 p-2 rounded-lg text-white font-bold text-xs border border-amber-500/30 outline-none text-center"
                                                />
                                                <span className="text-xs font-bold text-amber-500/70">meses</span>
                                            </div>
                                        )}
                                    </div>
                                )}

                                {/* DETALHES DO PARCELAMENTO (C√ÅLCULOS ADICIONADOS) */}
                                {isInstallment && (
                                    <div className="bg-blue-900/20 p-4 rounded-xl border border-blue-500/30 animate-slide-up flex flex-col gap-3">
                                        <div className="flex items-center gap-3">
                                            <label className="text-xs font-bold text-blue-200 uppercase whitespace-nowrap">N¬∫ Parcelas:</label>
                                            <input type="number" min="2" max="60" value={installments} onChange={e => setInstallments(e.target.value)} className="w-full bg-[#020617] p-2 rounded-lg text-center font-bold text-white border border-blue-500/30 outline-none focus:border-blue-500 shadow-inner" />
                                        </div>

                                        {/* C√ÅLCULO DA PARCELA */}
                                        {fAmount > 0 && (
                                            <div className="bg-blue-950/50 p-2 rounded-lg border border-blue-500/20 text-center">
                                                <p className="text-sm font-bold text-blue-300">
                                                    {installments}x de <span className="text-white">{formatCurrency(fAmount / installments)}</span>
                                                </p>

                                                {/* C√ÅLCULO POR PESSOA (CASAL) */}
                                                {fShared && (
                                                    <p className="text-xs text-pink-300 mt-1 font-bold border-t border-blue-500/20 pt-1">
                                                        (Casal: {formatCurrency((fAmount / installments) / 2)} para cada)
                                                    </p>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                )}

                                {/* QUEM PAGOU (S√≥ aparece se dividido ou em aba conjunta) */}
                                {(fShared || viewMode === 'joint') && (
                                    <div className="bg-[#1e293b] p-3 rounded-xl border border-slate-700 flex items-center justify-between animate-slide-up">
                                        <span className="text-xs font-bold text-slate-400 uppercase ml-1">
                                            {fType === 'income' ? 'Quem Recebeu?' : 'Quem Pagou?'}
                                        </span>
                                        <div className="flex gap-4">
                                            <button type="button" onClick={() => setFormPayer('me')} className={`relative w-12 h-12 rounded-full border-2 flex items-center justify-center transition-all ${formPayer === 'me' ? 'border-indigo-500 scale-110 shadow-[0_0_15px_rgba(99,102,241,0.5)] grayscale-0' : 'border-slate-700 grayscale opacity-50 scale-90'}`}>
                                                <div className={`w-full h-full rounded-full flex items-center justify-center text-xl ${USER_CONFIG[profile]?.color || 'bg-gray-500'} border-2 border-[#1e293b]`}>
                                                    {USER_CONFIG[profile]?.avatar}
                                                </div>
                                                {formPayer === 'me' && <div className="absolute -bottom-2 text-xs font-bold text-indigo-400 bg-slate-900 px-2 rounded-full border border-indigo-500/30">Eu</div>}
                                            </button>

                                            <button type="button" onClick={() => setFormPayer('partner')} className={`relative w-12 h-12 rounded-full border-2 flex items-center justify-center transition-all ${formPayer === 'partner' ? 'border-pink-500 scale-110 shadow-[0_0_15px_rgba(236,72,153,0.5)] grayscale-0' : 'border-slate-700 grayscale opacity-50 scale-90'}`}>
                                                <div className={`w-full h-full rounded-full flex items-center justify-center text-xl ${USER_CONFIG[profile === 'bruno' ? 'maiara' : 'bruno']?.color || 'bg-gray-500'} border-2 border-[#1e293b]`}>
                                                    {USER_CONFIG[profile === 'bruno' ? 'maiara' : 'bruno']?.avatar}
                                                </div>
                                                {formPayer === 'partner' && <div className="absolute -bottom-2 text-xs font-bold text-pink-400 bg-slate-900 px-2 rounded-full border border-pink-500/30">{profile === 'bruno' ? 'Maiara' : 'Bruno'}</div>}
                                            </button>
                                        </div>
                                    </div>
                                )}

                                {/* 7. CATEGORIAS */}
                                <div>
                                    <p className="text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Categoria</p>
                                    <div className="grid grid-cols-3 gap-2">
                                        {CATEGORIES[fType].map(c => (
                                            <button type="button" key={c.id} onClick={() => { setFCat(c.name); setFSubCat(''); }}
                                                className={`p-2 rounded-xl border flex flex-col items-center gap-1 transition-all active:scale-95 ${fCat === c.name ? 'border-indigo-500 bg-indigo-500/20 text-white shadow-[0_0_15px_rgba(99,102,241,0.2)]' : 'border-white/5 bg-[#1e293b] text-slate-400 hover:bg-[#283548]'}`}>
                                                <span className="text-xl">{c.icon}</span>
                                                <span className="text-[8px] font-bold uppercase text-center leading-tight">{c.name.slice(0, 10)}</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* 8. SUBCATEGORIA */}
                                {fCat && CATEGORIES[fType].find(c => c.name === fCat)?.subcategories?.length > 0 && (
                                    <div className="p-3 rounded-xl bg-[#0f172a] border border-slate-700 animate-slide-up">
                                        <label className="text-xs font-bold text-slate-400 uppercase ml-1 block mb-1">Detalhe da Categoria</label>
                                        <select value={fSubCat} onChange={e => setFSubCat(e.target.value)} className="w-full bg-transparent font-bold text-sm outline-none text-white appearance-none">
                                            <option value="" className="bg-slate-900 text-slate-500">Selecione uma op√ß√£o...</option>
                                            {CATEGORIES[fType].find(c => c.name === fCat).subcategories.map(sub => <option key={sub} value={sub} className="bg-slate-900 text-white">{sub}</option>)}
                                        </select>
                                    </div>
                                )}

                                {/* BOT√ÉO DE SALVAR */}
                                <button type="submit" className="w-full btn-gradient text-white py-4 rounded-xl font-bold text-lg shadow-xl shadow-indigo-500/20 active:scale-95 transition-transform mt-2 flex items-center justify-center gap-2 border border-white/10">
                                    <CheckCircle size={20} /> Confirmar
                                </button>
                            </form>
                        </div>
                    </div>
                )}

                {/* Modal Budget (Atualizado v23: Soma Autom√°tica de Filhos) */}
                {budgetModal && (
                    <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fade-in">
                        <div className="glass-card w-full max-w-sm rounded-[2rem] p-6 shadow-2xl max-h-[80vh] flex flex-col">
                            <div className="flex justify-between mb-2"><h3 className="font-bold text-xl flex gap-2 text-white"><Target className="text-indigo-400" /> Definir metas</h3><button onClick={() => setBudgetModal(false)} className="bg-white/10 p-2 rounded-full text-white hover:bg-white/20 transition-colors"><X size={20} /></button></div>

                            <div className="mb-4 relative">
                                <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500" size={16} />
                                <input type="text" placeholder="Buscar categoria..." value={budgetSearch} onChange={e => setBudgetSearch(e.target.value)} className="w-full bg-slate-800/50 border border-white/10 pl-9 pr-3 py-2 rounded-xl text-sm font-bold outline-none focus:ring-2 focus:ring-indigo-500/50 text-white placeholder-slate-600" />
                            </div>

                            <div className="overflow-y-auto space-y-4 flex-1 pr-2 custom-scrollbar">
                                {editBudgets
                                    .filter(b => b.displayName.toLowerCase().includes(budgetSearch.toLowerCase()))
                                    .map((b, i) => {
                                        // L√ìGICA DE SOMA AUTOM√ÅTICA (Refor√ßada)
                                        const isParent = b.type === 'main'; // Agora 'b.type' existe
                                        const hasChildren = editBudgets.some(child => child.parent === b.category); // Agora 'child.parent' existe

                                        let displayVal = b.limit;

                                        if (isParent && hasChildren) {
                                            const childrenSum = editBudgets
                                                .filter(child => child.parent === b.category)
                                                .reduce((sum, child) => sum + (Number(child.limit) || 0), 0); // For√ßa Number() para evitar erro
                                            displayVal = childrenSum;
                                        }

                                        return (
                                            <div key={b.category} className="flex gap-3 items-center">
                                                <span className="text-xl w-8 text-center">{b.icon}</span>
                                                <div className="flex-1">
                                                    <div className="flex justify-between">
                                                        <p className={`text-xs font-bold uppercase truncate ${isParent ? 'text-indigo-400' : 'text-slate-400'}`}>{b.displayName || b.category}</p>
                                                        {/* Feedback visual adicionado */}
                                                        {isParent && hasChildren && <span className="text-xs text-indigo-300 font-bold bg-indigo-500/20 px-1.5 rounded flex items-center gap-1 border border-indigo-500/30">Auto <Sparkles size={8} /></span>}
                                                    </div>
                                                    <input
                                                        type="number"
                                                        value={displayVal}
                                                        readOnly={isParent && hasChildren} // Bloqueia edi√ß√£o do Pai
                                                        onChange={e => {
                                                            if (isParent && hasChildren) return;

                                                            const realIndex = editBudgets.findIndex(eb => eb.category === b.category);
                                                            const n = [...editBudgets];
                                                            n[realIndex].limit = Number(e.target.value); // Salva j√° como n√∫mero
                                                            setEditBudgets(n);
                                                        }}
                                                        className={`w-full border-b font-bold py-1 outline-none focus:border-indigo-500 transition-colors bg-transparent ${isParent && hasChildren ? 'border-dashed border-white/10 text-slate-500 cursor-not-allowed pl-2 rounded' : 'border-white/10 text-white'}`}
                                                    />
                                                </div>
                                            </div>
                                        );
                                    })}
                            </div>
                            <button onClick={saveBudget} className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold mt-4 hover:bg-indigo-500 transition-colors">Salvar Altera√ß√µes</button>
                        </div>
                    </div>
                )}

                {/* NOVO MODAL: Atualizar Cota√ß√µes (Por Ativo) */}
                {pricesModal && (
                    <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fade-in">
                        <div className="glass-card w-full max-w-sm rounded-[2rem] p-6 shadow-2xl max-h-[80vh] flex flex-col">
                            <div className="flex justify-between mb-6 border-b border-white/10 pb-4">
                                <h3 className="font-bold text-xl flex gap-2 text-white"><TrendingUp className="text-indigo-400" /> Cota√ß√µes Atuais</h3>
                                <button onClick={() => setPricesModal(false)} className="bg-white/10 p-2 rounded-full text-white hover:bg-white/20 transition-colors"><X size={20} /></button>
                            </div>
                            <p className="text-xs text-slate-400 mb-4">Informe o pre√ßo unit√°rio atual de cada ativo para calcular a rentabilidade.</p>
                            <div className="overflow-y-auto space-y-4 flex-1 custom-scrollbar">
                                {data.investData.portfolio.filter(a => a.qty > 0).map((asset) => (
                                    <div key={asset.name} className="flex gap-3 items-center justify-between">
                                        <div className="flex-1">
                                            <p className="text-sm font-bold text-slate-200">{asset.name}</p>
                                            <p className="text-xs text-slate-400">PM: {formatCurrency(asset.avgPrice)}</p>
                                        </div>
                                        <div className="relative w-32">
                                            <span className="absolute left-0 top-1/2 -translate-y-1/2 text-slate-400 text-xs font-bold">R$</span>
                                            <input
                                                type="number"
                                                step="0.01"
                                                value={currentPrices[asset.name] || ''}
                                                onChange={e => setCurrentPrices({ ...currentPrices, [asset.name]: e.target.value })}
                                                className="w-full border-b border-white/10 pl-6 font-bold py-1 outline-none focus:border-indigo-500 text-right text-white bg-transparent"
                                                placeholder={asset.currentPrice || "0.00"}
                                            />
                                        </div>
                                    </div>
                                ))}
                                {data.investData.portfolio.filter(a => a.qty > 0).length === 0 && <p className="text-center text-xs text-slate-500">Nenhum ativo com quantidade definida.</p>}
                            </div>
                            <button onClick={() => {
                                db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('settings').doc('assetPrices').set(currentPrices);
                                setPricesModal(false);
                            }} className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold mt-4 hover:bg-indigo-500 transition-colors">Salvar Cota√ß√µes</button>
                        </div>
                    </div>
                )}

                {/* MODAL NOVO SONHO (Atualizado) */}
                {dreamModal && (
                    <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fade-in">
                        <div className="glass-card w-full max-w-sm rounded-[2rem] p-6 shadow-2xl animate-slide-up">
                            <div className="flex justify-between mb-6"><h3 className="font-bold text-xl flex gap-2 text-white"><Sparkles className="text-amber-500" /> Novo Sonho</h3><button onClick={() => setDreamModal(false)} className="bg-white/10 p-2 rounded-full text-white hover:bg-white/20 transition-colors"><X size={20} /></button></div>
                            <div className="space-y-4">
                                {/* Toggle Tipo de Sonho (Melhoria 4) */}
                                <div className="flex bg-slate-800 p-1 rounded-xl border border-white/10">
                                    <button onClick={() => setDScope('personal')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${dScope === 'personal' ? 'bg-indigo-600 text-white shadow' : 'text-slate-500 hover:text-slate-300'}`}>Meu Sonho</button>
                                    <button onClick={() => setDScope('joint')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${dScope === 'joint' ? 'bg-pink-600 text-white shadow' : 'text-slate-500 hover:text-slate-300'}`}>Nosso Sonho</button>
                                </div>

                                <div>
                                    <label className="text-xs font-bold uppercase text-slate-400 ml-1">Nome do Sonho</label>
                                    <input type="text" value={dTitle} onChange={e => setDTitle(e.target.value)} placeholder={dScope === 'joint' ? "Ex: Nossa Casa" : "Ex: Viagem Solo"} className="w-full bg-slate-800/50 p-3 rounded-xl font-bold outline-none focus:ring-2 focus:ring-indigo-500 mt-1 border border-white/10 text-white placeholder-slate-600" />
                                </div>
                                <div>
                                    <label className="text-xs font-bold uppercase text-slate-400 ml-1">Valor Alvo (Meta)</label>
                                    <input type="number" value={dTarget} onChange={e => setDTarget(e.target.value)} placeholder="Ex: 20000" className="w-full bg-slate-800/50 p-3 rounded-xl font-bold outline-none focus:ring-2 focus:ring-indigo-500 mt-1 border border-white/10 text-white placeholder-slate-600" />
                                </div>
                                <div>
                                    <label className="text-xs font-bold uppercase text-slate-400 ml-1">√çcone</label>
                                    {/* CORRE√á√ÉO: flex-wrap e largura m√°xima */}
                                    <div className="flex flex-wrap gap-3 mt-2 max-w-full">
                                        {['‚úàÔ∏è', 'üè†', 'üöó', 'üíç', 'üë∂', 'üéì', 'üèñÔ∏è', 'üí∞', 'üöÄ', 'üíª'].map(e => (
                                            <button key={e} onClick={() => setDEmoji(e)} className={`w-10 h-10 rounded-xl text-xl flex items-center justify-center transition-all ${dEmoji === e ? 'bg-indigo-600 text-white shadow-lg scale-110' : 'bg-white/5 hover:bg-white/10'}`}>{e}</button>
                                        ))}
                                    </div>
                                </div>
                                <button onClick={saveDream} className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold mt-2 hover:bg-indigo-500 transition-colors">Criar Sonho</button>
                            </div>
                        </div>
                    </div>
                )}

            </div>
        );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
</body>

</html>